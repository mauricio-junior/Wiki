---
layout: windowsazurestorage
title: Windows Azure Blobs&#58; Improved HTTP Headers for Resume on Download and a Change in If-Match Conditions
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-58" class="post-58 post type-post status-publish format-standard hentry category-uncategorized tag-windows-azure-blobs">

	<header class="entry-header single">
		<h1 class="entry-title">Windows Azure Blobs: Improved HTTP Headers for Resume on Download and a Change in If-Match Conditions</h1>		<div class="rating-wrap">
		<div id="star-rating-58" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="58" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2011-09-15T13:24:00+00:00">September 15, 2011</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/&quot;, &quot;text&quot;: &quot;Windows Azure Blobs: Improved HTTP Headers for Resume on Download and a Change in If-Match Conditions&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/&quot;, &quot;text&quot;: &quot;Windows Azure Blobs: Improved HTTP Headers for Resume on Download and a Change in If-Match Conditions&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>In the new 2011-08-18 version of the Windows Azure Blob service, we have made some changes to improve browser download and streaming for some media players. We also provided an extension to <a href="http://msdn.microsoft.com/en-us/library/hh452235.aspx">Blob Service settings</a> to allow anonymous and un-versioned requests to benefit from these changes. The motivation to provide these features are:</p>
<ol>
<li><b>Allow browsers to resume download if interrupted</b>. Some browsers require the following:
<ul>
<li>ETag returned as part of the response must be quoted to conform to the HTTP <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">spec</a>. </li>
<li>Return <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">Accept-Ranges</a> in the response header to indicate that range requests are accepted by the service. Though this is not mandatory according to the spec, some browsers still require this. </li>
</ul>
</li>
<li><b>Support more range formats for range requests</b>. Certain media players request a range of format “Range:bytes=0-“. The Windows Azure Blob service use to ignore this header format. Now, with the new 2011-08-18 version, we will return the entire blob in the format of a range response. This allows such media players to resume playing as soon as response packets arrive rather than waiting for the entire blob to download. </li>
<li><b>Allow un-versioned requests to be processed using semantics of 2011-08-18 version</b>. Since the above two changes impact un-versioned browser/media player requests and the changes made are versioned, we need to allow such requests to take advantage of the changes made. To allow un-versioned requests to be processed using semantics of 2011-08-18 version, we now take an extra property in “<a href="http://msdn.microsoft.com/en-us/library/hh452235.aspx">Set Blob Service Properties</a>”, which makes it possible to define the default version for the blob service to use for un-versioned requests to your account. </li>
</ol>
<p>In addition, another change for the blob service is that we now return “Pre-Condition Failure” (412) for PUT if you do a PUT request with conditional If-Match and the blob does not exist. Previously, we would have recreated this blob. This change is effective for all versions starting with 2009-09-19 version.</p>
<p>We will now cover the changes in more detail.</p>
<h4><a name="_Toc303517020"></a>Header Related Changes</h4>
<p>In this section we will cover the header related changes that we have done in the Windows Azure Blob service for 2011-08-18 version.</p>
<h5>Quoted ETags</h5>
<p>ETags returned in response headers for all APIs are now quoted to conform to <a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">RFC 2616 specification.</a> ETags returned in the listing operations as part of XML in response body will remain as is. As mentioned above, this allows browsers to resume download using the ETag. Unquoted ETags were ignored by certain browsers, while all standards-compliant browsers honor quoted ETags. ETags are required by a browser when using a conditional Range GET to resume a download on the blob and it needs to ensure that the partial content it is requesting has not been modified.</p>
<p>With version 2011-08-18, we now support this header format.</p>
<p>Sample GET Blob ResponseHTTP/1.1 200 OK</p>
<pre class="code">x-ms-blob-type: BlockBlob
x-ms-lease-status: unlocked
x-ms-meta-m1: v1
x-ms-meta-m2: v2
Content-Length: 11
<span style="color: #2b91af">Content</span>-<span style="color: #2b91af">Type</span>: text/plain; charset=UTF-8
Date: Sun, 25 Sep 2011 22:49:18 GMT
ETag: “0x8CB171DBEAD6A6B”
Last-Modified: Sun, 25 Sep 2011 22:48:29 GMT
x-ms-version: 2011-08-18
Accept-Ranges: bytes
Server: Windows-Azure-Blob/1.0 Microsoft-HTTPAPI/2.0</pre>
<p>&#160;</p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5><a name="_Toc303517022"></a></h5>
<h5>Return Accept-Ranges Header</h5>
<p>“<a href="http://msdn.microsoft.com/en-us/library/dd179440.aspx">Get Blob</a>” requests now return “<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">Accept-Ranges</a>” in response. Though clients should not expect this header to infer that range requests are allowed or not, certain browsers still expect it. For those browsers, if this header is missing, an interrupted download will resume from the beginning rather than resuming from where it was interrupted.</p>
<p>With version 2011-08-18, we now support this header format. The sample REST request above also shows the presence of this new header.</p>
<h5><a name="_Toc303517023"></a>Additional Range Format</h5>
<p>Certain media players issue a range request for the entire blob using the format:</p>
<p>Range: bytes=0-</p>
<p>It expects a status code of 206 (i.e. Partial Content) with entire content being returned and Content-Range header set to:</p>
<p>Content-Range: bytes 0-10240779/10240780 (assuming the blob was of length 10240780).</p>
<p>In receiving the Content-Range, the media player would then start streaming the blob rather than waiting for the entire blob to be downloaded first.</p>
<p>With version 2011-08-18, we now support this header format.</p>
<h5>Sample Range GET Blob Request</h5>
<pre class="code">GET http:<span style="color: green">//cohowinery.blob.core.windows.net/videos/build.wmv?timeout=60 HTTP/1.1
</span>User-Agent: WA-Storage/6.0.6002.18312
Range: bytes=100-Host:10.200.30.18</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5>Sample Range GET Blob Repsonse</h5>
<pre class="code">HTTP/1.1 206 Partial Content
Content-Length: 1048476
<span style="color: #2b91af">Content</span>-<span style="color: #2b91af">Type</span>: application/octet-stream
Content-Range: bytes 100-1048575/1048576
Last-Modified: Thu, 08 Sep 2011 23:39:47 GMT
Accept-Ranges: bytes
ETag: <span style="color: #a31515">&quot;0x8CE4217E34E31F0&quot;
</span>Server: Windows-Azure-Blob/1.0 Microsoft-HTTPAPI/2.0
x-ms-request-id: 387a38ae-fa0c-4fe2-8e60-d6afa2373e56
x-ms-version: 2011-08-18
x-ms-lease-status: unlocked
x-ms-blob-type: BlockBlob
Date: Thu, 08 Sep 2011 23:39:46 GMT

&lt;content …&gt;</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5><a name="_Toc303517024"></a>If-Match Condition on Non-Existent Blob</h5>
<p><a href="http://msdn.microsoft.com/en-us/library/dd179451.aspx">PUT Blob</a> API with If-Match precondition set to a value other than “*” would have succeeded before, even when the blob did not exist. This should not have succeeded, since it violates the HTTP specification. Therefore, we changed this to return “Precondition failed” (i.e. HTTP Status 412). The breaking change was done to prevent users from inadvertently recreating a deleted blob. This should not impact your service since:</p>
<ol>
<li>If the application really intendeds to create the blob, then it will send a PUT request without a ETag, since providing the ETag shows that the caller expects the blob to exist. </li>
<li>If an application sends an ETag, then the intent to just update is made explicit – so if a blob does not exist, the request must fail. </li>
<li>The current behavior is unexpected since we recreate the blob when the intent was to just update it. Because of these semantics, no application should be expecting the blob to be recreated. </li>
</ol>
<p>We have made this change effective in all versions starting with 2009-09-19.</p>
<h4><a name="_Toc301295966"></a><a name="_Toc303517025"></a>Blob Service Settings and DefaultServiceVersion</h4>
<p>Before we get into the changes to the blob service settings, let us understand how versioning works in Windows Azure Storage. The Windows Azure Storage Service accepts the version that should be used to process the request in a “x-ms-version” header. The list of supported versions is explained <a href="http://msdn.microsoft.com/en-us/library/windowsazure/dd894041.aspx">here</a>. However, in certain cases, versions can be omitted:</p>
<ol>
<li>Anonymous browser requests do not send a version header since there is no way to add this custom header </li>
<li>The PDC 2008 version of the request also did not require a version header </li>
</ol>
<p>When requests do not have the version header associated, we call it un-versioned requests. However, the service still needs to associate a version with these requests and the rule was as follows:</p>
<ol>
<li>If a request is versioned, then we use the version specified in the request header </li>
<li>If the version header is not set, then if the ACL for the blob container was set using version 2009-09-19 or later, we will use the 2009-09-19 version to execute the API </li>
<li>Otherwise we will use the PDC 2008 version of the API (which will be deprecated in the future) </li>
</ol>
<p>Because of the above rules, the above changes such as ETag, Accept-Ranges header etc, done for un-versioned requests would not have taken effect for the intended scenarios (e.g., anonymous requests). Hence, we now allow a DefaultServiceVersion property that can be set for the blob service for your storage account. This is used only for un-versioned requests and the new version precedence rules for requests are:</p>
<ol>
<li>If a request is versioned, then we use the version specified in the request header </li>
<li>If a version header is not present and the user has set DefaultServiceVersion in “<a href="http://msdn.microsoft.com/en-us/library/hh452235.aspx">Set Blob Service Properties</a>”to a valid version (2009-09-19 or 2011-08-18)”, then we will use that default version for this request. </li>
<li>If the version header is not set (explicitly or via the DefaultServiceVersion property), then if the ACL for the container was set using version 2009-09-19 or later, we will use 2009-09-19 version to execute the API </li>
<li>Otherwise, we will use the PDC 2008 version of the API, which will be deprecated in the future. </li>
</ol>
<p>For users who are targeting their blobs to be downloaded via browsers or media players, we recommend setting this default service version to 2011-08-18 so that the improvements can take effect. We also recommend setting this for your service, since we will be deprecating the PDC 2008 version at some point in the future.</p>
<h5><a name="_Toc303517026"></a>Set DefaultServiceVersion property</h5>
<p>The existing “<a href="http://msdn.microsoft.com/en-us/library/hh452235.aspx">Set Blob Service Properties</a>” has been extended in 2011-08-18 version to include a new DefaultServiceVersion property. This is an optional property and accepted only if it is set to a valid version value. It only applies to the Windows Azure Blob service. The possible values are:</p>
<ul>
<li>2009-09-19 </li>
<li>2011-08-18 </li>
</ul>
<p>When set, this version is used for all un-versioned requests. Please note that the “<a href="http://msdn.microsoft.com/en-us/library/hh452235.aspx">Set Blob Service Properties</a>” request to set DefaultServiceVersion must be made with version 2011-08-18, regardless of which version you are setting DefaultServiceVersion to. An example REST request looks like the following:</p>
<h5>Sample REST Request</h5>
<pre class="code">PUT http:<span style="color: green">//cohowinery.blob.core.windows.net/?restype=service&amp;comp=properties HTTP/1.1
</span>x-ms-version: 2011-08-18
x-ms-date: Sat, 10 Sep 2011 04:28:19 GMT
Authorization: SharedKey cohowinery:Z1lTLDwtq5o1UYQluucdsXk6/iB7YxEu0m6VofAEkUE=
Host: cohowinery.blob.core.windows.net
Content-Length: 200
&lt;?xml version=<span style="color: #a31515">&quot;1.0&quot; </span>encoding=<span style="color: #a31515">&quot;utf-8&quot;</span>?&gt;
&lt;StorageServiceProperties&gt;
    &lt;Logging&gt;
        &lt;<span style="color: #2b91af">Version</span>&gt;1.0&lt;/<span style="color: #2b91af">Version</span>&gt;
        &lt;Delete&gt;<span style="color: blue">true</span>&lt;/Delete&gt;
        &lt;Read&gt;<span style="color: blue">false</span>&lt;/Read&gt;
        &lt;Write&gt;<span style="color: blue">true</span>&lt;/Write&gt;
        &lt;RetentionPolicy&gt;
            &lt;Enabled&gt;<span style="color: blue">true</span>&lt;/Enabled&gt;
            &lt;Days&gt;7&lt;/Days&gt;
        &lt;/RetentionPolicy&gt;
    &lt;/Logging&gt;
    &lt;Metrics&gt;
        &lt;<span style="color: #2b91af">Version</span>&gt;1.0&lt;/<span style="color: #2b91af">Version</span>&gt;
        &lt;Enabled&gt;<span style="color: blue">true</span>&lt;/Enabled&gt;
        &lt;IncludeAPIs&gt;<span style="color: blue">false</span>&lt;/IncludeAPIs&gt;
        &lt;RetentionPolicy&gt;
            &lt;Enabled&gt;<span style="color: blue">true</span>&lt;/Enabled&gt;
            &lt;Days&gt;7&lt;/Days&gt;
        &lt;/RetentionPolicy&gt;
    &lt;/Metrics&gt;
    &lt;DefaultServiceVersion&gt;2011-08-18&lt;/DefaultServiceVersion&gt;
&lt;/StorageServiceProperties&gt;</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5><a name="_Toc303517027"></a>Get Storage Service Properties</h5>
<p>Using the 2011-08-18 version, <a href="http://msdn.microsoft.com/en-us/library/hh452239.aspx">this</a> API will now return the DefaultServiceVersion if it has been set.</p>
<h5>Sample REST Request</h5>
<pre class="code">GET http:<span style="color: green">//cohowinery.blob.core.windows.net/?restype=service&amp;comp=properties HTTP/1.1
</span>x-ms-version: 2011-08-18
x-ms-date: Sat, 10 Sep 2011 04:28:19 GMT
Authorization: SharedKey cohowinery:Z1lTLDwtq5o1UYQluucdsXk6/iB7YxEu0m6VofAEkUE=
Host: cohowinery.blob.core.windows.net</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5><a name="_Toc303517028"></a>Sample Library and Usage</h5>
<p>We provide sample code that can be used to set these service settings. It is very similar to the example provided in the <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2011/08/03/windows-azure-storage-logging-using-logs-to-track-storage-requests.aspx">Analytics blog</a> but it uses the new DefaultServiceVersion and we have renamed some classes in which we have used “ServiceSettings” in place of “AnalyticsSettings” in class names and method names.</p>
<ul>
<li>Class SettingsSerializerHelper handles serialization and deserialization of settings. </li>
<li>Class ServiceSettings represents the service settings. It also contains DefaultServiceVersion property which should be set only for blob service. Windows Azure Queue and Table service will return a 400 HTTP (“Bad Request”) status error code. </li>
<li>Class ServiceSettingsExtension implements extension methods that can be used to set/get service settings. </li>
</ul>
<p>The way to use the code is still the same except for the new DefaultServiceVersion property:</p>
<pre class="code"><span style="color: #2b91af">CloudStorageAccount </span>account = <span style="color: #2b91af">CloudStorageAccount</span>.Parse(ConnectionString);
<span style="color: #2b91af">CloudBlobClient </span>blobClient = account.CreateCloudBlobClient();
ServiceSettings settings = <span style="color: blue">new </span>ServiceSettings()
        {
            LogType = LoggingLevel.Delete | LoggingLevel.Read | LoggingLevel.Write,
            IsLogRetentionPolicyEnabled = <span style="color: blue">false</span>,
            LogRetentionInDays = 7,
            IsMetricsRetentionPolicyEnabled = <span style="color: blue">true</span>,
            MetricsRetentionInDays = 3,
            MetricsType = MetricsType.All,
            DefaultServiceVersion = <span style="color: #a31515">&quot;2011-08-18&quot;
        </span>};

blobClient.SetServiceSettings(settings);</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Here are the rest of the utility classes.</p>
<pre class="code"><span style="color: blue">using </span>System;
<span style="color: blue">using </span>System.Globalization;
<span style="color: blue">using </span>System.IO;
<span style="color: blue">using </span>System.Net;
<span style="color: blue">using </span>System.Text;
<span style="color: blue">using </span>System.Xml;
<span style="color: blue">using </span>Microsoft.WindowsAzure;
<span style="color: blue">using </span>Microsoft.WindowsAzure.StorageClient;

<span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">This class handles the serialization and deserialization of service settings
</span><span style="color: gray">/// &lt;/summary&gt;
</span><span style="color: blue">public static class </span><span style="color: #2b91af">SettingsSerializerHelper
</span>{
    <span style="color: blue">private const string </span>RootPropertiesElementName = <span style="color: #a31515">&quot;StorageServiceProperties&quot;</span>;
    <span style="color: blue">private const string </span>VersionElementName = <span style="color: #a31515">&quot;Version&quot;</span>;
    <span style="color: blue">private const string </span>RetentionPolicyElementName = <span style="color: #a31515">&quot;RetentionPolicy&quot;</span>;
    <span style="color: blue">private const string </span>RetentionPolicyEnabledElementName = <span style="color: #a31515">&quot;Enabled&quot;</span>;
    <span style="color: blue">private const string </span>RetentionPolicyDaysElementName = <span style="color: #a31515">&quot;Days&quot;</span>;
    <span style="color: blue">private const string </span>DefaultServiceVersionElementName = <span style="color: #a31515">&quot;DefaultServiceVersion&quot;</span>;

    <span style="color: blue">private const string </span>LoggingElementName = <span style="color: #a31515">&quot;Logging&quot;</span>;
    <span style="color: blue">private const string </span>ApiTypeDeleteElementName = <span style="color: #a31515">&quot;Delete&quot;</span>;
    <span style="color: blue">private const string </span>ApiTypeReadElementName = <span style="color: #a31515">&quot;Read&quot;</span>;
    <span style="color: blue">private const string </span>ApiTypeWriteElementName = <span style="color: #a31515">&quot;Write&quot;</span>;

    <span style="color: blue">private const string </span>MetricsElementName = <span style="color: #a31515">&quot;Metrics&quot;</span>;
    <span style="color: blue">private const string </span>IncludeApiSummaryElementName = <span style="color: #a31515">&quot;IncludeAPIs&quot;</span>;
    <span style="color: blue">private const string </span>MetricsEnabledElementName = <span style="color: #a31515">&quot;Enabled&quot;</span>;

    <span style="color: blue">private const int </span>MaximumRetentionDays = 365;

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Reads the settings provided from stream
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;xmlReader&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">internal static </span><span style="color: #2b91af">ServiceSettings </span>DeserializeServiceSettings(XmlReader xmlReader)
    {
        <span style="color: green">// Read the root and check if it is empty or invalid
        </span>xmlReader.Read();
        xmlReader.ReadStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RootPropertiesElementName);

        <span style="color: #2b91af">ServiceSettings </span>settings = <span style="color: blue">new </span><span style="color: #2b91af">ServiceSettings</span>();

        <span style="color: blue">while </span>(<span style="color: blue">true</span>)
        {
            <span style="color: blue">if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.LoggingElementName))
            {
                DeserializeLoggingElement(xmlReader, settings);
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.MetricsElementName))
            {
                DeserializeMetricsElement(xmlReader, settings);
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.DefaultServiceVersionElementName))
            {
                settings.DefaultServiceVersion = xmlReader.ReadElementString(<span style="color: #2b91af">SettingsSerializerHelper</span>.DefaultServiceVersionElementName);
            }
            <span style="color: blue">else
            </span>{
                <span style="color: blue">break</span>;
            }
        }

        xmlReader.ReadEndElement();

        <span style="color: blue">return </span>settings;
    }


    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Write the settings provided to stream
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;xmlWriter&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">internal static void </span>SerializeServiceSettings(XmlWriter xmlWriter, <span style="color: #2b91af">ServiceSettings </span>settings)
    {
        xmlWriter.WriteStartDocument();
        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RootPropertiesElementName);

        <span style="color: green">//LOGGING STARTS HERE
        </span>xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.LoggingElementName);

        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.VersionElementName);
        xmlWriter.WriteValue(settings.LogVersion);
        xmlWriter.WriteEndElement();

        <span style="color: blue">bool </span>isReadEnabled = (settings.LogType &amp; <span style="color: #2b91af">LoggingLevel</span>.Read) != <span style="color: #2b91af">LoggingLevel</span>.None;
        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeReadElementName);
        xmlWriter.WriteValue(isReadEnabled);
        xmlWriter.WriteEndElement();

        <span style="color: blue">bool </span>isWriteEnabled = (settings.LogType &amp; <span style="color: #2b91af">LoggingLevel</span>.Write) != <span style="color: #2b91af">LoggingLevel</span>.None;
        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeWriteElementName);
        xmlWriter.WriteValue(isWriteEnabled);
        xmlWriter.WriteEndElement();

        <span style="color: blue">bool </span>isDeleteEnabled = (settings.LogType &amp; <span style="color: #2b91af">LoggingLevel</span>.Delete) != <span style="color: #2b91af">LoggingLevel</span>.None;
        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeDeleteElementName);
        xmlWriter.WriteValue(isDeleteEnabled);
        xmlWriter.WriteEndElement();

        SerializeRetentionPolicy(xmlWriter, settings.IsLogRetentionPolicyEnabled, settings.LogRetentionInDays);
        xmlWriter.WriteEndElement(); <span style="color: green">// logging element

        //METRICS STARTS HERE
        </span>xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.MetricsElementName);

        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.VersionElementName);
        xmlWriter.WriteValue(settings.MetricsVersion);
        xmlWriter.WriteEndElement();

        <span style="color: blue">bool </span>isServiceSummaryEnabled = (settings.MetricsType &amp; <span style="color: #2b91af">MetricsType</span>.ServiceSummary) != <span style="color: #2b91af">MetricsType</span>.None;
        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.MetricsEnabledElementName);
        xmlWriter.WriteValue(isServiceSummaryEnabled);
        xmlWriter.WriteEndElement();

        <span style="color: blue">if </span>(isServiceSummaryEnabled)
        {
            <span style="color: blue">bool </span>isApiSummaryEnabled = (settings.MetricsType &amp; <span style="color: #2b91af">MetricsType</span>.ApiSummary) != <span style="color: #2b91af">MetricsType</span>.None;
            xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.IncludeApiSummaryElementName);
            xmlWriter.WriteValue(isApiSummaryEnabled);
            xmlWriter.WriteEndElement();
        }

        SerializeRetentionPolicy(
            xmlWriter,
            settings.IsMetricsRetentionPolicyEnabled,
            settings.MetricsRetentionInDays);
        xmlWriter.WriteEndElement(); <span style="color: green">// metrics 

        // Save default service version if provided. NOTE - this should be set only for blob service
        </span><span style="color: blue">if </span>(!<span style="color: blue">string</span>.IsNullOrEmpty(settings.DefaultServiceVersion))
        {
            xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.DefaultServiceVersionElementName);
            xmlWriter.WriteValue(settings.DefaultServiceVersion);
            xmlWriter.WriteEndElement();
        }

        xmlWriter.WriteEndElement(); <span style="color: green">// root element
        </span>xmlWriter.WriteEndDocument();
    }

    <span style="color: blue">private static void </span>SerializeRetentionPolicy(XmlWriter xmlWriter, <span style="color: blue">bool </span>isRetentionEnabled, <span style="color: blue">int </span>days)
    {
        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyElementName);

        xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyEnabledElementName);
        xmlWriter.WriteValue(isRetentionEnabled);
        xmlWriter.WriteEndElement();

        <span style="color: blue">if </span>(isRetentionEnabled)
        {
            xmlWriter.WriteStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyDaysElementName);
            xmlWriter.WriteValue(days);
            xmlWriter.WriteEndElement();
        }

        xmlWriter.WriteEndElement(); <span style="color: green">// Retention policy for logs
    </span>}

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Reads the logging element and fills in the values in settings instance
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;xmlReader&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">private static void </span>DeserializeLoggingElement(
        XmlReader xmlReader,
        <span style="color: #2b91af">ServiceSettings </span>settings)
    {
        <span style="color: green">// Read logging element
        </span>xmlReader.ReadStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.LoggingElementName);

        <span style="color: blue">while </span>(<span style="color: blue">true</span>)
        {
            <span style="color: blue">if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.VersionElementName))
            {
                settings.LogVersion = xmlReader.ReadElementString(<span style="color: #2b91af">SettingsSerializerHelper</span>.VersionElementName);
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeReadElementName))
            {
                <span style="color: blue">if </span>(DeserializeBooleanElementValue(
                    xmlReader,
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeReadElementName))
                {
                    settings.LogType = settings.LogType | <span style="color: #2b91af">LoggingLevel</span>.Read;
                }
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeWriteElementName))
            {
                <span style="color: blue">if </span>(DeserializeBooleanElementValue(
                    xmlReader,
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeWriteElementName))
                {
                    settings.LogType = settings.LogType | <span style="color: #2b91af">LoggingLevel</span>.Write;
                }
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeDeleteElementName))
            {
                <span style="color: blue">if </span>(DeserializeBooleanElementValue(
                    xmlReader,
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.ApiTypeDeleteElementName))
                {
                    settings.LogType = settings.LogType | <span style="color: #2b91af">LoggingLevel</span>.Delete;
                }
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyElementName))
            {
                <span style="color: green">// read retention policy for logging
                </span><span style="color: blue">bool </span>isRetentionEnabled = <span style="color: blue">false</span>;
                <span style="color: blue">int </span>retentionDays = 0;
                DeserializeRetentionPolicy(xmlReader, <span style="color: blue">ref </span>isRetentionEnabled, <span style="color: blue">ref </span>retentionDays);
                settings.IsLogRetentionPolicyEnabled = isRetentionEnabled;
                settings.LogRetentionInDays = retentionDays;
            }
            <span style="color: blue">else
            </span>{
                <span style="color: blue">break</span>;
            }
        }

        xmlReader.ReadEndElement();<span style="color: green">// end Logging element
    </span>}

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Reads the metrics element and fills in the values in settings instance
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;xmlReader&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">private static void </span>DeserializeMetricsElement(
        XmlReader xmlReader,
        <span style="color: #2b91af">ServiceSettings </span>settings)
    {
        <span style="color: blue">bool </span>includeAPIs = <span style="color: blue">false</span>;

        <span style="color: green">// read the next element - it should be metrics. 
        </span>xmlReader.ReadStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.MetricsElementName);

        <span style="color: blue">while </span>(<span style="color: blue">true</span>)
        {
            <span style="color: blue">if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.VersionElementName))
            {
                settings.MetricsVersion = xmlReader.ReadElementString(<span style="color: #2b91af">SettingsSerializerHelper</span>.VersionElementName);

            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.MetricsEnabledElementName))
            {
                <span style="color: blue">if </span>(DeserializeBooleanElementValue(
                    xmlReader,
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.MetricsEnabledElementName))
                {
                    <span style="color: green">// only if metrics is enabled will we read include API
                    </span>settings.MetricsType = settings.MetricsType | <span style="color: #2b91af">MetricsType</span>.ServiceSummary;
                }
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.IncludeApiSummaryElementName))
            {
                <span style="color: blue">if </span>(DeserializeBooleanElementValue(
                    xmlReader,
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.IncludeApiSummaryElementName))
                {
                    includeAPIs = <span style="color: blue">true</span>;
                }
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyElementName))
            {
                <span style="color: green">// read retention policy for metrics
                </span><span style="color: blue">bool </span>isRetentionEnabled = <span style="color: blue">false</span>;
                <span style="color: blue">int </span>retentionDays = 0;
                DeserializeRetentionPolicy(xmlReader, <span style="color: blue">ref </span>isRetentionEnabled, <span style="color: blue">ref </span>retentionDays);
                settings.IsMetricsRetentionPolicyEnabled = isRetentionEnabled;
                settings.MetricsRetentionInDays = retentionDays;
            }
            <span style="color: blue">else
            </span>{
                <span style="color: blue">break</span>;
            }
        }

        <span style="color: blue">if </span>((settings.MetricsType &amp; <span style="color: #2b91af">MetricsType</span>.ServiceSummary) != <span style="color: #2b91af">MetricsType</span>.None)
        {
            <span style="color: green">// If Metrics is enabled, IncludeAPIs must be included.
            </span><span style="color: blue">if </span>(includeAPIs)
            {
                settings.MetricsType = settings.MetricsType | <span style="color: #2b91af">MetricsType</span>.ApiSummary;
            }
        }

        xmlReader.ReadEndElement();<span style="color: green">// end metrics element
    </span>}


    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Reads the retention policy in logging and metrics elements 
    </span><span style="color: gray">/// </span><span style="color: green">and fills in the values in settings instance.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;xmlReader&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;isRetentionEnabled&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;retentionDays&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">private static void </span>DeserializeRetentionPolicy(
        XmlReader xmlReader,
        <span style="color: blue">ref bool </span>isRetentionEnabled,
        <span style="color: blue">ref int </span>retentionDays)
    {
        xmlReader.ReadStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyElementName);

        <span style="color: blue">while </span>(<span style="color: blue">true</span>)
        {
            <span style="color: blue">if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyEnabledElementName))
            {
                isRetentionEnabled = DeserializeBooleanElementValue(
                    xmlReader,
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyEnabledElementName);
            }
            <span style="color: blue">else if </span>(xmlReader.IsStartElement(<span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyDaysElementName))
            {
                <span style="color: blue">string </span>intValue = xmlReader.ReadElementString(
                    <span style="color: #2b91af">SettingsSerializerHelper</span>.RetentionPolicyDaysElementName);
                retentionDays = <span style="color: blue">int</span>.Parse(intValue);
            }
            <span style="color: blue">else
            </span>{
                <span style="color: blue">break</span>;
            }
        }

        xmlReader.ReadEndElement(); <span style="color: green">// end reading retention policy
    </span>}

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Read a boolean value for xml element
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;xmlReader&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;elementToRead&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">private static bool </span>DeserializeBooleanElementValue(
        XmlReader xmlReader,
        <span style="color: blue">string </span>elementToRead)
    {
        <span style="color: blue">string </span>boolValue = xmlReader.ReadElementString(elementToRead);
        <span style="color: blue">return bool</span>.Parse(boolValue);
    }
}

[<span style="color: #2b91af">Flags</span>]
<span style="color: blue">public enum </span><span style="color: #2b91af">LoggingLevel
</span>{
    None = 0,
    Delete = 2,
    Write = 4,
    Read = 8,
}

[<span style="color: #2b91af">Flags</span>]
<span style="color: blue">public enum </span><span style="color: #2b91af">MetricsType
</span>{
    None = 0x0,
    ServiceSummary = 0x1,
    ApiSummary = 0x2,
    All = ServiceSummary | ApiSummary,
}

<span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">The service settings that can set/get
</span><span style="color: gray">/// &lt;/summary&gt;
</span><span style="color: blue">public class </span><span style="color: #2b91af">ServiceSettings
</span>{
    <span style="color: blue">public static string </span>Version = <span style="color: #a31515">&quot;1.0&quot;</span>;

    <span style="color: blue">public </span>ServiceSettings()
    {
        <span style="color: blue">this</span>.LogType = <span style="color: #2b91af">LoggingLevel</span>.None;
        <span style="color: blue">this</span>.LogVersion = <span style="color: #2b91af">ServiceSettings</span>.Version;
        <span style="color: blue">this</span>.IsLogRetentionPolicyEnabled = <span style="color: blue">false</span>;
        <span style="color: blue">this</span>.LogRetentionInDays = 0;

        <span style="color: blue">this</span>.MetricsType = MetricsType.None;
        <span style="color: blue">this</span>.MetricsVersion = <span style="color: #2b91af">ServiceSettings</span>.Version;
        <span style="color: blue">this</span>.IsMetricsRetentionPolicyEnabled = <span style="color: blue">false</span>;
        <span style="color: blue">this</span>.MetricsRetentionInDays = 0;
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The default service version to use for un-versioned requests
    </span><span style="color: gray">/// </span><span style="color: green">NOTE: This can be set only for blob service. 
    </span><span style="color: gray">/// </span><span style="color: green">Possible values: 2009-09-19 or 2011-08-18. 
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public string </span>DefaultServiceVersion { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The type of logs subscribed for
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public </span><span style="color: #2b91af">LoggingLevel </span>LogType { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The version of the logs
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public string </span>LogVersion { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Flag indicating if retention policy is set for logs in $logs
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public bool </span>IsLogRetentionPolicyEnabled { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The number of days to retain logs for under $logs container
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public int </span>LogRetentionInDays { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The metrics version
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public string </span>MetricsVersion { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">A flag indicating if retention policy is enabled for metrics
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public bool </span>IsMetricsRetentionPolicyEnabled { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The number of days to retain metrics data
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public int </span>MetricsRetentionInDays { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">private </span><span style="color: #2b91af">MetricsType </span>metricsType = <span style="color: #2b91af">MetricsType</span>.None;

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">The type of metrics subscribed for
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public </span><span style="color: #2b91af">MetricsType </span>MetricsType
    {
        <span style="color: blue">get
        </span>{
            <span style="color: blue">return </span>metricsType;
        }

        <span style="color: blue">set
        </span>{
            <span style="color: blue">if </span>(<span style="color: blue">value </span>== MetricsType.ApiSummary)
            {
                <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentException</span>(<span style="color: #a31515">&quot;Including just ApiSummary is invalid.&quot;</span>);
            }

            <span style="color: blue">this</span>.metricsType = <span style="color: blue">value</span>;
        }
    }
}


<span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">Extension methods for setting service settings
</span><span style="color: gray">/// &lt;/summary&gt;
</span><span style="color: blue">public static class </span><span style="color: #2b91af">ServiceSettingsExtension
</span>{
    <span style="color: blue">static string </span>RequestIdHeaderName = <span style="color: #a31515">&quot;x-ms-request-id&quot;</span>;
    <span style="color: blue">static string </span>VersionHeaderName = <span style="color: #a31515">&quot;x-ms-version&quot;</span>;
    <span style="color: blue">static string </span>VersionToUse = <span style="color: #a31515">&quot;2011-08-18&quot;</span>;
    <span style="color: blue">static </span><span style="color: #2b91af">TimeSpan </span>DefaultTimeout = <span style="color: #2b91af">TimeSpan</span>.FromSeconds(30);

    <span style="color: blue">#region </span>ServiceSettings
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Set blob service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">public static void </span>SetServiceSettings(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlobClient </span>client, <span style="color: #2b91af">ServiceSettings </span>settings)
    {
        SetSettings(client.BaseUri, client.Credentials, settings, <span style="color: blue">false </span><span style="color: green">/* useSharedKeyLite */</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Set queue service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;baseUri&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">public static void </span>SetServiceSettings(<span style="color: blue">this </span><span style="color: #2b91af">CloudQueueClient </span>client, <span style="color: #2b91af">Uri </span>baseUri, <span style="color: #2b91af">ServiceSettings </span>settings)
    {
        SetSettings(baseUri, client.Credentials, settings, <span style="color: blue">false </span><span style="color: green">/* useSharedKeyLite */</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Set blob service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">public static void </span>SetServiceSettings(<span style="color: blue">this </span><span style="color: #2b91af">CloudTableClient </span>client, <span style="color: #2b91af">ServiceSettings </span>settings)
    {
        SetSettings(client.BaseUri, client.Credentials, settings, <span style="color: blue">true </span><span style="color: green">/* useSharedKeyLite */</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Set service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;baseUri&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;credentials&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;settings&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;useSharedKeyLite&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">internal static void </span>SetSettings(
        <span style="color: #2b91af">Uri </span>baseUri, 
        <span style="color: #2b91af">StorageCredentials </span>credentials, 
        <span style="color: #2b91af">ServiceSettings </span>settings, 
        <span style="color: blue">bool </span>useSharedKeyLite)
    {
        <span style="color: #2b91af">UriBuilder </span>builder = <span style="color: blue">new </span><span style="color: #2b91af">UriBuilder</span>(baseUri);
        builder.Query = <span style="color: blue">string</span>.Format(
            CultureInfo.InvariantCulture,
            <span style="color: #a31515">&quot;comp=properties&amp;restype=service&amp;timeout={0}&quot;</span>,
            DefaultTimeout.TotalSeconds);

        <span style="color: #2b91af">HttpWebRequest </span>request = (<span style="color: #2b91af">HttpWebRequest</span>)<span style="color: #2b91af">HttpWebRequest</span>.Create(builder.Uri);
        request.Headers.Add(VersionHeaderName, VersionToUse);
        request.Method = <span style="color: #a31515">&quot;PUT&quot;</span>;

        <span style="color: #2b91af">StorageCredentialsAccountAndKey </span>accountAndKey = credentials <span style="color: blue">as </span><span style="color: #2b91af">StorageCredentialsAccountAndKey</span>;
        <span style="color: blue">using </span>(MemoryStream buffer = <span style="color: blue">new </span>MemoryStream())
        {
            XmlTextWriter writer = <span style="color: blue">new </span>XmlTextWriter(buffer, Encoding.UTF8);
            <span style="color: #2b91af">SettingsSerializerHelper</span>.SerializeServiceSettings(writer, settings);
            writer.Flush();
            buffer.Seek(0, SeekOrigin.Begin);
            request.ContentLength = buffer.Length;

            <span style="color: blue">if </span>(useSharedKeyLite)
            {
                credentials.SignRequestLite(request);
            }
            <span style="color: blue">else
            </span>{
                credentials.SignRequest(request);
            }

            <span style="color: blue">using </span>(Stream stream = request.GetRequestStream())
            {
                stream.Write(buffer.GetBuffer(), 0, (<span style="color: blue">int</span>)buffer.Length);
            }

            <span style="color: blue">try
            </span>{
                <span style="color: blue">using </span>(<span style="color: #2b91af">HttpWebResponse </span>response = (<span style="color: #2b91af">HttpWebResponse</span>)request.GetResponse())
                {
                    <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Response Request Id = {0} Status={1}&quot;</span>, response.Headers[RequestIdHeaderName], response.StatusCode);
                    <span style="color: blue">if </span>(<span style="color: #2b91af">HttpStatusCode</span>.Accepted != response.StatusCode)
                    {
                        <span style="color: blue">throw new </span><span style="color: #2b91af">Exception</span>(<span style="color: #a31515">&quot;Request failed with incorrect response status.&quot;</span>);
                    }
                }
            }
            <span style="color: blue">catch </span>(<span style="color: #2b91af">WebException </span>e)
            {
                <span style="color: #2b91af">Console</span>.WriteLine(
                    <span style="color: #a31515">&quot;Response Request Id={0} Status={1}&quot;</span>,
                    e.Response != <span style="color: blue">null </span>? e.Response.Headers[RequestIdHeaderName] : <span style="color: #a31515">&quot;Response is null&quot;</span>,
                    e.Status);
                <span style="color: blue">throw</span>;
            }

        }
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Get blob service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">public static </span><span style="color: #2b91af">ServiceSettings </span>GetServiceSettings(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlobClient </span>client)
    {
        <span style="color: blue">return </span>GetSettings(client.BaseUri, client.Credentials, <span style="color: blue">false </span><span style="color: green">/* useSharedKeyLite */</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Get queue service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;baseUri&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">public static </span><span style="color: #2b91af">ServiceSettings </span>GetServiceSettings(<span style="color: blue">this </span><span style="color: #2b91af">CloudQueueClient </span>client, <span style="color: #2b91af">Uri </span>baseUri)
    {
        <span style="color: blue">return </span>GetSettings(baseUri, client.Credentials, <span style="color: blue">false </span><span style="color: green">/* useSharedKeyLite */</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Get table service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;client&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">public static </span><span style="color: #2b91af">ServiceSettings </span>GetServiceSettings(<span style="color: blue">this </span><span style="color: #2b91af">CloudTableClient </span>client)
    {
        <span style="color: blue">return </span>GetSettings(client.BaseUri, client.Credentials, <span style="color: blue">true </span><span style="color: green">/* useSharedKeyLite */</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Get service settings
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;baseUri&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;credentials&quot;&gt;&lt;/param&gt;
    /// &lt;param name=&quot;useSharedKeyLite&quot;&gt;&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    </span><span style="color: blue">public static </span><span style="color: #2b91af">ServiceSettings </span>GetSettings(
        <span style="color: #2b91af">Uri </span>baseUri, 
        <span style="color: #2b91af">StorageCredentials </span>credentials, 
        <span style="color: blue">bool </span>useSharedKeyLite)
    {
        <span style="color: #2b91af">UriBuilder </span>builder = <span style="color: blue">new </span><span style="color: #2b91af">UriBuilder</span>(baseUri);
        builder.Query = <span style="color: blue">string</span>.Format(
            CultureInfo.InvariantCulture,
            <span style="color: #a31515">&quot;comp=properties&amp;restype=service&amp;timeout={0}&quot;</span>,
            DefaultTimeout.TotalSeconds);

        <span style="color: #2b91af">HttpWebRequest </span>request = (<span style="color: #2b91af">HttpWebRequest</span>)<span style="color: #2b91af">HttpWebRequest</span>.Create(builder.Uri);
        request.Headers.Add(VersionHeaderName, VersionToUse);
        request.Method = <span style="color: #a31515">&quot;GET&quot;</span>;

        <span style="color: #2b91af">StorageCredentialsAccountAndKey </span>accountAndKey = credentials <span style="color: blue">as </span><span style="color: #2b91af">StorageCredentialsAccountAndKey</span>;

        <span style="color: blue">if </span>(useSharedKeyLite)
        {
            credentials.SignRequestLite(request);
        }
        <span style="color: blue">else
        </span>{
            credentials.SignRequest(request);
        }

        <span style="color: blue">try
        </span>{
            <span style="color: blue">using </span>(<span style="color: #2b91af">HttpWebResponse </span>response = (<span style="color: #2b91af">HttpWebResponse</span>)request.GetResponse())
            {
                <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Response Request Id={0} Status={1}&quot;</span>, response.Headers[RequestIdHeaderName], response.StatusCode);

                <span style="color: blue">if </span>(<span style="color: #2b91af">HttpStatusCode</span>.OK != response.StatusCode)
                {
                    <span style="color: blue">throw new </span><span style="color: #2b91af">Exception</span>(<span style="color: #a31515">&quot;expected HttpStatusCode.OK&quot;</span>);
                }

                <span style="color: blue">using </span>(Stream stream = response.GetResponseStream())
                {
                    <span style="color: blue">using </span>(StreamReader streamReader = <span style="color: blue">new </span>StreamReader(stream))
                    {
                        <span style="color: blue">string </span>responseString = streamReader.ReadToEnd();
                        <span style="color: #2b91af">Console</span>.WriteLine(responseString);

                        XmlReader reader = XmlReader.Create(<span style="color: blue">new </span>MemoryStream(ASCIIEncoding.UTF8.GetBytes(responseString)));
                        <span style="color: blue">return </span><span style="color: #2b91af">SettingsSerializerHelper</span>.DeserializeServiceSettings(reader);
                    }
                }
            }
        }
        <span style="color: blue">catch </span>(<span style="color: #2b91af">WebException </span>e)
        {
            <span style="color: #2b91af">Console</span>.WriteLine(
                <span style="color: #a31515">&quot;Response Request Id={0} Status={1}&quot;</span>,
                e.Response != <span style="color: blue">null </span>? e.Response.Headers[RequestIdHeaderName] : <span style="color: #a31515">&quot;Response is null&quot;</span>,
                e.Status);
            <span style="color: blue">throw</span>;
        }
    }
    <span style="color: blue">#endregion
</span>}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Jai Haridas</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-blobs-improved-http-headers-for-resume-on-download-and-a-change-in-if-match-conditions%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->