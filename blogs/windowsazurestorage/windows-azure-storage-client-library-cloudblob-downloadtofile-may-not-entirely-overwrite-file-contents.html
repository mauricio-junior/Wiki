---
layout: windowsazurestorage
title: Windows Azure Storage Client Library&#58; CloudBlob.DownloadToFile() may not entirely overwrite file contents
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-41" class="post-41 post type-post status-publish format-standard hentry category-uncategorized tag-issues-fixed tag-windows-azure-blobs tag-windows-azure-storage-client-library">

	<header class="entry-header single">
		<h1 class="entry-title">Windows Azure Storage Client Library: CloudBlob.DownloadToFile() may not entirely overwrite file contents</h1>		<div class="rating-wrap">
		<div id="star-rating-41" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="41" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2010-11-12T19:04:00+00:00">November 12, 2010</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/#comments">2</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/&quot;, &quot;text&quot;: &quot;Windows Azure Storage Client Library: CloudBlob.DownloadToFile() may not entirely overwrite file contents&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/&quot;, &quot;text&quot;: &quot;Windows Azure Storage Client Library: CloudBlob.DownloadToFile() may not entirely overwrite file contents&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<h4><span style="font-size: medium;"><em>Update 3/09/011:&nbsp; The bug is fixed in the </em></span><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=7a1089b6-4050-4307-86c4-9dadaa5ed018"><strong><span style="font-size: medium;"><em><span style="font-size: medium;">Windows Azure SDK March 2011 release</span></em></span></strong></a><strong><span style="font-size: medium;"><em><span style="font-size: small;"><span style="font-size: medium;">. <o:p></o:p></span></span></em></span></strong></h4>
<h4>Summary</h4>
<p><b>There is an issue in the Windows Azure Storage Client Library that can lead to unexpected behavior when utilizing the CloudBlob.DownloadToFile() methods</b>.&nbsp; </p>
<p>The current implementation of CloudBlob.DownloadToFile() does not erase or clear any preexisting data in the file. Therefore, if you download a blob which is smaller than the existing file, preexisting data at the tail end of the file will still exist. </p>
<p><b>Example</b>: Let&rsquo;s say I have a blob titled <b>movieblob</b> that currently contains all the movies that I would like to watch in the future. I want to download this blob to a local file <b>moviesToWatch.txt</b>, which currently contains a lot of romantic comedies which my wife recently watched, however, when I overwrite that file with the action movies I want to watch (which happens to be a smaller list) the existing text is not completely overwritten which may lead to a somewhat random movie selection.</p>
<table cellpadding="0" cellspacing="0" border="3" style="width: 598px;">
<tbody>
<tr>
<td width="113" valign="top">
<p><b>moviesToWatch.txt</b></p>
</td>
<td width="479" valign="top">
<p>You've Got Mail;P.S. I Love You.;Gone With The Wind;Sleepless in Seattle;Notting Hill;Pretty Woman;The Runaway Bride;The Holiday;Little Women;When Harry Met Sally</p>
</td>
</tr>
<tr>
<td width="115" valign="top">
<p><b>movieblob</b></p>
</td>
<td width="477" valign="top">
<p>The Dark Knight;The Matrix;Braveheart;The Core;Star Trek 2:The Wrath of Khan;The Dirty Dozen;</p>
</td>
</tr>
<tr>
<td width="117" valign="top">
<p><b>moviesToWatch.txt (updated)</b></p>
</td>
<td width="478" valign="top">
<p>The Dark Knight;The Matrix;Braveheart;The Core;Star Trek 2:The Wrath of Khan;The Dirty Dozen;<em><span style="text-decoration: underline;"><strong>Woman;The Runaway Bride;The Holiday;Little Women;When Harry Met Sally</strong></span></em></p>
</td>
</tr>
</tbody>
</table>
<p>As you can see in the updated local moviesToWatch.txt file, the last section of the previous movie data still exists on the tail end of the file. </p>
<p>This issue will be addressed in a forthcoming release of the Storage Client Library.</p>
<h4>Workaround</h4>
<p>In order to avoid this behavior you can use the CloudBlob.DownloadToStream() method and pass in the stream for a file that you have already called File.Create on, see below. </p>
<p><b>using</b> <b>(</b>var stream <b>=</b> File<b>.</b>Create<b>(</b>"myFile.txt"<b>)) <br/></b><b>{ <br/></b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; myBlob<b>.</b>DownloadToStream<b>(</b>stream<b>); <br/></b><b>}</b></p>
<p>To reiterate, this issue only affects scenarios where the file already exists, and the downloaded blob contents are less than the length of the previously existing file. If you are using CloudBlob.DownloadToFile() to write to a new file then you will be unaffected by this issue. Until the issue is resolved in a future release, we recommend that users follow the pattern above. </p>
<p>Joe Giardino</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-fixed/" rel="tag">Issues - Fixed</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-storage-client-library/" rel="tag">Windows Azure Storage Client Library</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (2)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F11%2F12%2Fwindows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-81">
				<div id="div-comment-81" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Mark Richards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/#comment-81">
			April 12, 2011 at 9:26 am</a>		</div>

		<p>Joe,</p>
<p>I am using the latest storage client library, and I am using DownloadToFile to download files in excess of 1GB. &nbsp;I have downloaded tens of thousands of smaller files without fail. &nbsp;But with these large files, I am getting a lot of errors, maybe 2/3 of the time. &nbsp;If I re-run my job, they sometimes work, sometimes fail, i can&#39;t discern a pattern.</p>
<p>here is the meat of the error:</p>
<p>Unable to read data from the transport connection: The connection was closed., StackTrace: &nbsp; &nbsp;at OD.CloudCoder.Common.Storage.BlobStore.GetBlobItem(CloudBlobContainer container, String filepath, String blobName) </p>
<p>Have you run into this? &nbsp;Any ideas what I can do to fix it ?</p>
<p>Thanks,</p>
<p>Mark Richards</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F11%2F12%2Fwindows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-82">
				<div id="div-comment-82" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/b596cd385878c1dc59067dc534e2ab25?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b596cd385878c1dc59067dc534e2ab25?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">joegiardino@live.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/11/12/windows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents/#comment-82">
			April 12, 2011 at 11:22 am</a>		</div>

		<p>@Mark Richards</p>
<p>This sounds like you are hitting a connection issue which may be caused by your proxy / edge connection. If you interrogate the innerException of the StorageClientException that is thrown it will give more detailed information about the exact error. &nbsp;Additionally, you can increase the timeout for the transaction via either the BlobRequestOptions or the CloudBlobClient. </p>
<p>Lastly, the DownloadToFile/ByteArray/Stream/Text() methods performs it’s entire download in a single streaming get. &nbsp;If you use CloudBlob.OpenRead() method it will utilize the BlobReadStream abstraction which will download the blob one block at a time as it is consumed. If a connection error occurs, then only that one block will need to be re-downloaded(according to the configured RetryPolicy). Also, this will potentially help improve performance as the client may not need cache a large amount of data locally. For large blobs this can help significantly, however be aware that you will be performing a higher number of overall transactions against the service. </p>
<p>I hope this helps, </p>
<p>Joe</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F11%2F12%2Fwindows-azure-storage-client-library-cloudblob-downloadtofile-may-not-entirely-overwrite-file-contents%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->