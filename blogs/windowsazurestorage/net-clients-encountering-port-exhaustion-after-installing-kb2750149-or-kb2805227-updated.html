---
layout: windowsazurestorage
title: .NET Clients encountering Port Exhaustion after installing KB2750149 or KB2805227 [Updated]
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-134" class="post-134 post type-post status-publish format-standard hentry category-uncategorized">

	<header class="entry-header single">
		<h1 class="entry-title">.NET Clients encountering Port Exhaustion after installing KB2750149 or KB2805227 [Updated]</h1>		<div class="rating-wrap">
		<div id="star-rating-134" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="134" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2013-08-07T22:19:00+00:00">August 7, 2013</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/#comments">2</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/&quot;, &quot;text&quot;: &quot;.NET Clients encountering Port Exhaustion after installing KB2750149 or KB2805227 [Updated]&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/&quot;, &quot;text&quot;: &quot;.NET Clients encountering Port Exhaustion after installing KB2750149 or KB2805227 [Updated]&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p><span style="font-size: large;"><strong>Updated [12/10/13] : This blog was updated to reflect the availability of .NET 4.5.1</strong></span>&nbsp;</p>
<p>A recent update for .NET 4.5 introduced a regression to <a href="http://msdn.microsoft.com/en-us/library/system.net.httpwebrequest.aspx">HttpWebRequest</a> that may affect high scale applications. This blog post will cover the details of this change, how it impacts clients, and mitigations clients may take to avoid this issue altogether.</p>
<p><strong>What is the effect?</strong></p>
<p>Client would observe long latencies for their Blob, Queue, and Table Storage requests and may find either that that their requests to storage are dispatched after a delay or it is not dispatching requests to storage and instead see System.Net.WebException being thrown from their application when trying to access storage. The details about the exception is explained below. Running a netstat as described in the next section would show that the process has consumed many ports causing port exhaustion.</p>
<p><strong>Who is affected?</strong></p>
<p>Any client that is accessing Windows Azure Storage from a .NET platform with <a href="http://support.microsoft.com/kb/2750149">KB2750149</a> or <a href="http://support.microsoft.com/kb/2805227">KB2805227</a> installed that does not consume the entire response stream will be affected. This includes clients that are accessing the REST API directly via <a href="http://msdn.microsoft.com/en-us/library/system.net.httpwebrequest.aspx">HttpWebRequest</a> and <a href="http://msdn.microsoft.com/en-us/library/system.net.http.httpclient.aspx">HttpClient</a>, the <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2012/11/05/windows-azure-storage-client-library-for-windows-runtime.aspx">Storage Client for Windows RT</a>, as well as the .NET Storage Client Library (2.0.6.0 and below provided via <a href="http://www.nuget.org/packages/WindowsAzure.Storage">NuGet</a>, <a href="https://github.com/WindowsAzure/azure-sdk-for-net">GitHub</a>, and the <a href="http://www.windowsazure.com/en-us/develop/net/">SDK</a>). You can read more about the specifics of this update <a href="http://support.microsoft.com/kb/2750149">here</a>.</p>
<p>In many cases the Storage Client Libraries do not expect a body to be returned from the server based on the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/dd179355.aspx">REST API</a> and subsequently do not attempt to read the response stream. Under previous behavior this &ldquo;empty&rdquo; response consisting of a single 0 length chunk would have been automatically consumed by the .NET networking layer allowing the socket to be reused. To address this change proactively we have added a fix to the .NET Client library in version <a href="http://www.nuget.org/packages/WindowsAzure.Storage/2.0.6.1">2.0.6.1</a> to explicitly drain the response stream.</p>
<p>A client can use the <strong>netstat</strong> utility to check for processes that are holding many ports open in the TIME_WAIT or ESTABLISHED states by issuing a <strong>nestat &ndash;a &ndash;o</strong> ( The &ndash;a will show all connections, and the -o option will display the owner process ID).</p>
<p>&nbsp;</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/3808.netstat_thumb3_18729FB9.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/3808.netstat_5F00_thumb3_5F00_18729FB9.jpg"><img style="margin: 0px; border: 0px currentcolor; display: inline; background-image: none;" title="netstat_thumb3" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/1348.netstat_thumb3_thumb_0A3426C9.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/1348.netstat_5F00_thumb3_5F00_thumb_5F00_0A3426C9.jpg" alt="netstat_thumb3" width="818" height="126" border="0"/></a></p>
<p>Running this command on an affected machine shows the following:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/1854.netstat-result_thumb2_70CC238E.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/1854.netstat_2D00_result_5F00_thumb2_5F00_70CC238E.jpg"><img style="border: 0px currentcolor; display: inline; background-image: none;" title="netstat-result_thumb2" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/4174.netstat-result_thumb2_thumb_5B6E6E26.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/4174.netstat_2D00_result_5F00_thumb2_5F00_thumb_5F00_5B6E6E26.jpg" alt="netstat-result_thumb2" width="821" height="487" border="0"/></a></p>
<p>You can see above that a single process with ID 3024 is holding numerous connections open to the server.</p>
<p><strong>Description</strong></p>
<p>Users installing the recent update (<a href="http://support.microsoft.com/kb/2750149">KB2750149</a> or <a href="http://support.microsoft.com/kb/2805227">KB2805227</a>) will observe slightly different behavior when leveraging the HttpWebRequest to communicate with a server that returns a chunked encoded response. (For more on Chunked encoded data see <a href="http://en.wikipedia.org/wiki/Chunked_transfer_encoding">here</a>).</p>
<p>When a server responds to an HTTP request with a chunked encoded response the client may be unaware of the entire length of the body, and therefore will read the body in a series of chunks from the response stream. The response stream is terminated when the server sends a zero length &ldquo;chunk&rdquo; followed by a CRLF sequence (see the article above for more details). When the server responds with an empty body this entire payload will consists of a single zero-length chunk to terminate the stream.</p>
<p>Prior to this update the default behavior of the HttpWebRequest was to attempt to &ldquo;drain&rdquo; the response stream whenever the users closes the HttpWebResponse. If the request can successfully read the rest of the response then the socket may be reused by another request in the application and is subsequently returned back to the shared pool. However, if a request still contains unread data then the underlying socket will remain open for some period of time before being explicitly disposed. This behavior will not allow the socket to be reused by the shared pool causing additional performance degradation as each request will be required to establish a new socket connection with the service.</p>
<p><strong>Client Observed Behavior</strong></p>
<p>In some cases older versions of the Storage Client Library will not retrieve the response stream from the HttpWebRequest (i.e. PUT operations), and therefore will not drain it, even though data is not sent by the server. Clients with <a href="http://support.microsoft.com/kb/2750149">KB2750149</a> or <a href="http://support.microsoft.com/kb/2805227">KB2805227</a> installed that leverage these libraries may begin to encounter TCP/IP port exhaustion. When TCP/IP port exhaustion does occur a client will encounter the following Web and Socket Exceptions:</p>
<p><a name="CodeSnippetCopyLink"></a>System.Net.WebException: The underlying connection was closed: An unexpected error occurred on a send.</p>
<p>- or -</p>
<p>System.Net.WebException: Unable to connect to the remote server <br/>System.Net.Sockets.SocketException: Only one usage of each socket address (protocol/network address/port) is normally permitted.</p>
<p>Note, if you are accessing storage via the Storage Client library these exceptions will be wrapped in a StorageException:</p>
<p>Microsoft.WindowsAzure.Storage.StorageException: Unable to connect to the remote server</p>
<p>System.Net.WebException: Unable to connect to the remote server <br/>System.Net.Sockets.SocketException: Only one usage of each socket address (protocol/network address/port) is normally permitted</p>
<p><strong>Mitigation</strong></p>
<p>We have been working with the .NET team to address this issue. A permanent fix is now available which reinstates this read ahead semantic in a time bounded manner.</p>
<p><strong><span style="font-family: 'Verdana','sans-serif'; mso-ansi-language: EN;" lang="EN">Install .NET Framework 4.5.1</span></strong></p>
<p><span style="font-family: 'Verdana','sans-serif'; mso-ansi-language: EN;" lang="EN">Please consider installing <a href="http://www.microsoft.com/en-us/download/details.aspx?id=40779">.NET Framework 4.5.1</a>&nbsp;which contains the fix.</span></p>
<p><strong>Upgrade to latest version of the Storage Client (2.0.6.1, or later)</strong></p>
<p>An update was made for the 2.0.6.1 (<a href="http://www.nuget.org/packages/WindowsAzure.Storage/">NuGet</a>, <a href="https://github.com/WindowsAzure/azure-sdk-for-net">GitHub</a>) version of the Storage Client library to address this issue. If possible please upgrade your application to use the latest assembly.</p>
<p><strong>Uninstall KB2750149 and KB2805227</strong></p>
<p>We also recognize that some clients may be running applications that still utilize the 1.7 version of the storage client and may not be able to easily upgrade to the latest version without additional effort or&nbsp;are unable to install .NET 4.5.1. For such users, consider uninstalling the updates mentioned above.</p>
<p><strong>Update applications that leverage the REST API directly to explicitly drain the response stream</strong></p>
<p>Any client application that directly references the Windows Azure REST API can be updated to explicitly retrieve the response stream from the HttpWebRequest via [Begin/End]GetResponseStream() and drain it manually i.e. by calling the Read or BeginRead methods until end of stream</p>
<p><strong>Summary</strong></p>
<p>We apologize for any inconvenience this may have caused. Please feel free to leave questions or comments below,</p>
<p>Joe Giardino, Serdar Ozler, Jean Ghanem, and Marcus Swenson</p>
<p>&nbsp;</p>
<p><strong>Resources</strong></p>
<p>Windows Azure Storage Client library 2.0.6.1 (<a href="http://www.nuget.org/packages/WindowsAzure.Storage/2.0.6.1">NuGet</a>, <a href="https://github.com/WindowsAzure/azure-sdk-for-net">GitHub</a>)</p>
<p>Original KB article #1: <a href="http://support.microsoft.com/kb/2750149">http://support.microsoft.com/kb/2750149</a></p>
<p>Original KB article #2: <a href="http://support.microsoft.com/kb/2805227">http://support.microsoft.com/kb/2805227</a></p>
<p>Hotfix KB article: <a href="http://support.microsoft.com/kb/2846046">http://support.microsoft.com/kb/2846046</a></p>
<p>.NET 4.5.1: <a href="http://www.microsoft.com/en-us/download/details.aspx?id=40779">http://www.microsoft.com/en-us/download/details.aspx?id=40779</a></p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (2)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2013%2F08%2F07%2Fnet-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-312">
				<div id="div-comment-312" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">mike wiegand</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/#comment-312">
			August 27, 2013 at 10:39 am</a>		</div>

		<p>Does this issue include Storage Library 2.1 RC???</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2013%2F08%2F07%2Fnet-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-315">
				<div id="div-comment-315" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/419b33245887eb453bdf6c8715579628?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/419b33245887eb453bdf6c8715579628?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">serdar.ozler@outlook.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2013/08/07/net-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated/#comment-315">
			August 28, 2013 at 9:42 am</a>		</div>

		<p>2.1 RC already has the fix for Blob and Queue services. Final version of 2.1 will have the fix for all 3 services including Table.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2013%2F08%2F07%2Fnet-clients-encountering-port-exhaustion-after-installing-kb2750149-or-kb2805227-updated%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->