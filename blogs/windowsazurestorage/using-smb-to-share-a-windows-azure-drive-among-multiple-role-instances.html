---
layout: windowsazurestorage
title: Using SMB to Share a Windows Azure Drive among multiple Role Instances
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-54" class="post-54 post type-post status-publish format-standard hentry category-uncategorized tag-windows-azure-drives">

	<header class="entry-header single">
		<h1 class="entry-title">Using SMB to Share a Windows Azure Drive among multiple Role Instances</h1>		<div class="rating-wrap">
		<div id="star-rating-54" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="54" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2011-04-16T12:53:56+00:00">April 16, 2011</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comments">22</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/&quot;, &quot;text&quot;: &quot;Using SMB to Share a Windows Azure Drive among multiple Role Instances&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/&quot;, &quot;text&quot;: &quot;Using SMB to Share a Windows Azure Drive among multiple Role Instances&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<h4><b><em>UPDATED 11/17/11 with a high availability sample</em></b></h4>
<p>We often get questions from customers about how to share a drive with read-write access among multiple role instances. A common scenario is that of a content repository for multiple web servers to access and store content. An Azure drive is similar to a traditional disk drive in that it may only be mounted read-write on one system. However using <a href="http://technet.microsoft.com/en-us/library/cc734393(WS.10).aspx">SMB</a>, it is possible to mount a drive on one role instance and then <i>share</i> that out to other role instances which can map the network share to a drive letter or mount point.</p>
<p>In this blog post we’ll cover the specifics on how to set this up and leave you with a simple prototype that demonstrates the concept. We’ll use an example of a worker role (referred to as the server) which mounts the drive and shares it out and two other worker roles (clients) that map the network share to a drive letter and write log records to the shared drive. <b></b></p>
<h5><b>Service Definition on the Server role</b></h5>
<p>The server role has TCP port 445 enabled as an internal endpoint so that it can receive SMB requests from other roles in the service. This done by defining the endpoint in the <i>ServiceDefinition.csdef</i> as follows</p>
<pre class="code">&lt;Endpoints&gt;
      &lt;InternalEndpoint name=<span style="color: #a31515">&quot;SMB&quot; </span>protocol=<span style="color: #a31515">&quot;tcp&quot; </span>port=<span style="color: #a31515">&quot;445&quot; </span>/&gt;
&lt;/Endpoints&gt;</pre>
<p>Now when the role starts up, it must mount the drive and then <i>share</i> it. Sharing the drive requires the Server role to be running with administrator privileges. Beginning with SDK 1.3 it’s possible to do that using the following setting in the <i>ServiceDefinition.csdef</i> file.</p>
<pre class="code">&lt;Runtime executionContext=<span style="color: #a31515">&quot;elevated&quot;</span>&gt; 
&lt;/Runtime&gt;</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5><b>Mounting the drive and sharing it</b></h5>
<p>When the server role instance starts up, it first mounts the Azure drive and executes shell commands to</p>
<ol>
<li>Create a user account for the clients to authenticate as. The user name and password are derived from the service configuration. </li>
<li>Enable inbound SMB protocol traffic through the role instance firewall<i></i> </li>
<li>Share the mounted drive with the share name specified in the service configuration and grant the user account previously created full access. The value for <i>path </i>in the example below is the drive letter assigned to the drive. </li>
</ol>
<p>Here’s snippet of C# code that does that. </p>
<pre class="code">String error;
ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot;user &quot; </span>+ userName + <span style="color: #a31515">&quot; &quot; </span>+ password + <span style="color: #a31515">&quot; /add&quot;</span>, <span style="color: blue">out </span>error, 10000);

ExecuteCommand(<span style="color: #a31515">&quot;netsh.exe&quot;</span>, <span style="color: #a31515">&quot;firewall set service type=fileandprint mode=enable scope=all&quot;</span>, <span style="color: blue">out </span>error, 10000);

ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; share &quot; </span>+ shareName + <span style="color: #a31515">&quot;=&quot; </span>+ path + <span style="color: #a31515">&quot; /Grant:&quot;
                    </span>+ userName + <span style="color: #a31515">&quot;,full&quot;</span>, <span style="color: blue">out </span>error, 10000);</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The shell commands are executed by the routine <i>ExecuteCommand</i>.</p>
<pre class="code"><span style="color: blue">public static int </span>ExecuteCommand(<span style="color: blue">string </span>exe, <span style="color: blue">string </span>arguments, <span style="color: blue">out string </span>error, <span style="color: blue">int </span>timeout)
      {
          Process p = <span style="color: blue">new </span>Process();
          <span style="color: blue">int </span>exitCode;
          p.StartInfo.FileName = exe;
          p.StartInfo.Arguments = arguments;
          p.StartInfo.CreateNoWindow = <span style="color: blue">true</span>;
          p.StartInfo.UseShellExecute = <span style="color: blue">false</span>;
          p.StartInfo.RedirectStandardError = <span style="color: blue">true</span>;
          p.Start();
          error = p.StandardError.ReadToEnd();
          p.WaitForExit(timeout);
          exitCode = p.ExitCode;
          p.Close();

          <span style="color: blue">return </span>exitCode;
      }</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>We haven’t touched on how to mount the drive because that is covered in several places including <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/03/29/windows-azure-drive-demo-at-mix-2010.aspx">here</a>. </p>
<h5><b>Mapping the network drive on the client</b></h5>
<p>When the clients start up, they locate the instance of the SMB Server and then identify the address of the SMB endpoint on the server. Next they execute a shell command to map the share served by the SMB server to a drive letter specified by the configuration setting <i>localpath. </i>Note that <i>sharename, username </i>and<i> password</i> must match the settings on the SMB server. </p>
<pre class="code">var server = RoleEnvironment.Roles[<span style="color: #a31515">&quot;SMBServer&quot;</span>].Instances[0];
machineIP = server.InstanceEndpoints[<span style="color: #a31515">&quot;SMB&quot;</span>].IPEndpoint.Address.ToString();machineIP = <span style="color: #a31515">&quot;\\\\&quot; </span>+ machineIP + <span style="color: #a31515">&quot;\\&quot;</span>;

<span style="color: blue">string </span>error;
ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; use &quot; </span>+ localPath + <span style="color: #a31515">&quot; &quot; </span>+ machineIP + shareName + <span style="color: #a31515">&quot; &quot; </span>+ password + <span style="color: #a31515">&quot; /user:&quot;</span>+ userName, <span style="color: blue">out </span>error, 20000);</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Once the share has been mapped to a local drive letter, the clients can write whatever they want to the share, just as they would to a local drive.&#160;&#160; <a href="http://11011.net/software/vspaste"></a></p>
<p>Note: Since the clients may come up before the server is ready, the clients may have to retry or alternatively poll the server on some other port for status before attempting to map the drive. The prototype retries in a loop until it succeeds or times out.</p>
<h5><b>Enabling High Availability </b></h5>
<p>With a single server role instance, the file share will be unavailable when the role is being upgraded. If you need to mitigate that, you can create a few warm stand-by instances of the server role thus ensuring that there is always one server role instance available to share the Azure Drive to clients.</p>
<p>Another approach would be to make each of your roles a potential host for the SMB share. Each role instance could potentially run an SMB service, but only one of them would get the mounted Azure Drive behind SMB service. The roles can then iterate over all the role instances attempting to map the SMB share with each role instance. The mapping will succeed when the client connects to the instance that has the drive mounted. </p>
<p>Another scheme is to have the role instance that successfully mounted the drive inform the other role instances so that the clients can query to find the <i>active </i>server instance.</p>
<p><b>Sharing Local Drives within a role instance </b></p>
<p>It’s also possible to <i>share</i> a <a href="http://msdn.microsoft.com/en-us/library/ee758708.aspx">local resource drive</a> mounted in a role instance among multiple role instances using similar steps. The key difference though is that writes to the local storage resource are not durable while writes to Azure Drives are persisted and available even after the role instances are shutdown.</p>
<p>Dinesh Haridas</p>
<p>&#160;</p>
<h5><b>Sample Code</b></h5>
<p>Here’s the code for the Server and Client in its entirety for easy reference. </p>
<p><b>Server – WorkerRole.cs</b></p>
<p>This file contains the code for the SMB server worker role. In the <i>OnStart()</i> method, the role instance initializes tracing before mounting the Azure Drive. It gets the settings for storage credentials, drive name and drive size from the Service Configuration. Once the drive is mounted, the role instance creates a user account, enables SMB traffic through the firewall and then shares the drive. These operations are performed by executing shell commands using the <i>ExecuteCommand() </i>method described earlier.<i> </i>For simplicity, parameters like account name, password and the share name for the drive are derived from the Service Configuration. <u></u></p>
<pre class="code"><span style="color: blue">using </span>System;
<span style="color: blue">using </span>System.Collections.Generic;
<span style="color: blue">using </span>System.Diagnostics;
<span style="color: blue">using </span>System.Linq;
<span style="color: blue">using </span>System.Net;
<span style="color: blue">using </span>System.Threading;
<span style="color: blue">using </span>Microsoft.WindowsAzure;
<span style="color: blue">using </span>Microsoft.WindowsAzure.Diagnostics;
<span style="color: blue">using </span>Microsoft.WindowsAzure.ServiceRuntime;
<span style="color: blue">using </span>Microsoft.WindowsAzure.StorageClient;

<span style="color: blue">namespace </span>SMBServer
{
    <span style="color: blue">public class </span>WorkerRole : RoleEntryPoint
    {
        <span style="color: blue">public static string </span>driveLetter = <span style="color: blue">null</span>;
        <span style="color: blue">public static </span>CloudDrive drive = <span style="color: blue">null</span>;

        <span style="color: blue">public override void </span>Run()
        {
            Trace.WriteLine(<span style="color: #a31515">&quot;SMBServer entry point called&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

            <span style="color: blue">while </span>(<span style="color: blue">true</span>)
            {
                Thread.Sleep(10000);
            }
        }

        <span style="color: blue">public override bool </span>OnStart()
        {
            <span style="color: green">// Set the maximum number of concurrent connections 
            </span>ServicePointManager.DefaultConnectionLimit = 12;

            <span style="color: green">// Initialize logging and tracing
            </span>DiagnosticMonitorConfiguration dmc = DiagnosticMonitor.GetDefaultInitialConfiguration();
            dmc.Logs.ScheduledTransferLogLevelFilter = LogLevel.Verbose;
            dmc.Logs.ScheduledTransferPeriod = TimeSpan.FromMinutes(1);
            DiagnosticMonitor.Start(<span style="color: #a31515">&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot;</span>, dmc);
            Trace.WriteLine(<span style="color: #a31515">&quot;Diagnostics Setup complete&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

           
            CloudStorageAccount account = CloudStorageAccount.Parse(RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;StorageConnectionString&quot;</span>));
            <span style="color: blue">try
            </span>{
                CloudBlobClient blobClient = account.CreateCloudBlobClient();
                CloudBlobContainer driveContainer = blobClient.GetContainerReference(<span style="color: #a31515">&quot;drivecontainer&quot;</span>);
                driveContainer.CreateIfNotExist();

                String driveName = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;driveName&quot;</span>);
                LocalResource localCache = RoleEnvironment.GetLocalResource(<span style="color: #a31515">&quot;AzureDriveCache&quot;</span>);
                CloudDrive.InitializeCache(localCache.RootPath, localCache.MaximumSizeInMegabytes);

                drive = <span style="color: blue">new </span>CloudDrive(driveContainer.GetBlobReference(driveName).Uri, account.Credentials);
                <span style="color: blue">try
                </span>{
                    drive.Create(<span style="color: blue">int</span>.Parse(RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;driveSize&quot;</span>)));
                }
                <span style="color: blue">catch </span>(CloudDriveException ex)
                {
                    Trace.WriteLine(ex.ToString(), <span style="color: #a31515">&quot;Warning&quot;</span>);
                }

                driveLetter = drive.Mount(localCache.MaximumSizeInMegabytes, DriveMountOptions.None);

                <span style="color: blue">string </span>userName = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserName&quot;</span>);
                <span style="color: blue">string </span>password = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserPassword&quot;</span>);

                <span style="color: green">// Modify path to share a specific directory on the drive
                </span><span style="color: blue">string </span>path = driveLetter;
                <span style="color: blue">string </span>shareName = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;shareName&quot;</span>);
                <span style="color: blue">int </span>exitCode;
                <span style="color: blue">string </span>error;

                <span style="color: green">//Create the user account    
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot;user &quot; </span>+ userName + <span style="color: #a31515">&quot; &quot; </span>+ password + <span style="color: #a31515">&quot; /add&quot;</span>, <span style="color: blue">out </span>error, 10000);
                <span style="color: blue">if </span>(exitCode != 0)
                {
                    <span style="color: green">//Log error and continue since the user account may already exist
                    </span>Trace.WriteLine(<span style="color: #a31515">&quot;Error creating user account, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Warning&quot;</span>);
                }

                <span style="color: green">//Enable SMB traffic through the firewall
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;netsh.exe&quot;</span>, <span style="color: #a31515">&quot;firewall set service type=fileandprint mode=enable scope=all&quot;</span>, <span style="color: blue">out </span>error, 10000);
                <span style="color: blue">if </span>(exitCode != 0)
                {
                    Trace.WriteLine(<span style="color: #a31515">&quot;Error setting up firewall, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Error&quot;</span>);
                    <span style="color: blue">goto </span>Exit;
                }

                <span style="color: green">//Share the drive
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; share &quot; </span>+ shareName + <span style="color: #a31515">&quot;=&quot; </span>+ path + <span style="color: #a31515">&quot; /Grant:&quot;
                    </span>+ userName + <span style="color: #a31515">&quot;,full&quot;</span>, <span style="color: blue">out </span>error, 10000);

               <span style="color: blue">if </span>(exitCode != 0)
                {
                    <span style="color: green">//Log error and continue since the drive may already be shared
                    </span>Trace.WriteLine(<span style="color: #a31515">&quot;Error creating fileshare, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Warning&quot;</span>);
                }

                Trace.WriteLine(<span style="color: #a31515">&quot;Exiting SMB Server OnStart&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);
            }
            <span style="color: blue">catch </span>(Exception ex)
            {
                Trace.WriteLine(ex.ToString(), <span style="color: #a31515">&quot;Error&quot;</span>);
                Trace.WriteLine(<span style="color: #a31515">&quot;Exiting&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);
                <span style="color: blue">throw</span>;
            }
            
            Exit:
            <span style="color: blue">return base</span>.OnStart();
        }

        <span style="color: blue">public static int </span>ExecuteCommand(<span style="color: blue">string </span>exe, <span style="color: blue">string </span>arguments, <span style="color: blue">out string </span>error, <span style="color: blue">int </span>timeout)
        {
            Process p = <span style="color: blue">new </span>Process();
            <span style="color: blue">int </span>exitCode;
            p.StartInfo.FileName = exe;
            p.StartInfo.Arguments = arguments;
            p.StartInfo.CreateNoWindow = <span style="color: blue">true</span>;
            p.StartInfo.UseShellExecute = <span style="color: blue">false</span>;
            p.StartInfo.RedirectStandardError = <span style="color: blue">true</span>;
            p.Start();
            error = p.StandardError.ReadToEnd();
            p.WaitForExit(timeout);
            exitCode = p.ExitCode;
            p.Close();

            <span style="color: blue">return </span>exitCode;
        }

        <span style="color: blue">public override void </span>OnStop()
        {
            <span style="color: blue">if </span>(drive != <span style="color: blue">null</span>)
            {
                drive.Unmount();
            }
            <span style="color: blue">base</span>.OnStop();
        }
    }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>&#160;</p>
<p><b>Client – WorkerRole.cs</b></p>
<p>This file contains the code for the SMB client worker role. The <i>OnStart</i> method initializes tracing for the role instance. In the <i>Run() </i>method, each client maps the drive shared by the server role using the <i>MapNetworkDrive()</i> method before writing log records at ten second intervals to the share in a loop.</p>
<p>In the <i>MapNetworkDrive() </i>method the client first determines the IP address and port number for the SMB endpoint on the server role instance before executing the shell command <i>net use</i> to connect to it. As in the case of the server role, the routine <i>ExecuteCommand() </i>is used to execute shell commands. Since the server may start up after the client, the client retries in a loop sleeping 10 seconds between retries and gives up after about 17 minutes. Between retries the client also deletes any stale <i>mounts </i>of the same share<i>.</i></p>
<pre class="code"><span style="color: blue">using </span>System;
<span style="color: blue">using </span>System.Collections.Generic;
<span style="color: blue">using </span>System.Diagnostics;
<span style="color: blue">using </span>System.Linq;
<span style="color: blue">using </span>System.Net;
<span style="color: blue">using </span>System.Threading;
<span style="color: blue">using </span>Microsoft.WindowsAzure;
<span style="color: blue">using </span>Microsoft.WindowsAzure.Diagnostics;
<span style="color: blue">using </span>Microsoft.WindowsAzure.ServiceRuntime;
<span style="color: blue">using </span>Microsoft.WindowsAzure.StorageClient;

<span style="color: blue">namespace </span>SMBClient
{
    <span style="color: blue">public class </span>WorkerRole : RoleEntryPoint
    {
        <span style="color: blue">public const int </span>tenSecondsAsMS = 10000;
        <span style="color: blue">public override void </span>Run()
        {
            <span style="color: green">// The code here mounts the drive shared out by the server worker role
            // Each client role instance writes to a log file named after the role instance in the logfile directory

            </span>Trace.WriteLine(<span style="color: #a31515">&quot;SMBClient entry point called&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);
            <span style="color: blue">string </span>localPath = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;localPath&quot;</span>);
            <span style="color: blue">string </span>shareName = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;shareName&quot;</span>);
            <span style="color: blue">string </span>userName = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserName&quot;</span>);
            <span style="color: blue">string </span>password = RoleEnvironment.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserPassword&quot;</span>);

            <span style="color: blue">string </span>logDir = localPath + <span style="color: #a31515">&quot;\\&quot; </span>+ <span style="color: #a31515">&quot;logs&quot;</span>;
            <span style="color: blue">string </span>fileName = RoleEnvironment.CurrentRoleInstance.Id + <span style="color: #a31515">&quot;.txt&quot;</span>;
            <span style="color: blue">string </span>logFilePath = System.IO.Path.Combine(logDir, fileName);

            <span style="color: blue">try
            </span>{

                <span style="color: blue">if </span>(MapNetworkDrive(localPath, shareName, userName, password) == <span style="color: blue">true</span>)
                {
                    System.IO.Directory.CreateDirectory(logDir);

                    <span style="color: green">// do work on the mounted drive here
                    </span><span style="color: blue">while </span>(<span style="color: blue">true</span>)
                    {
                        <span style="color: green">// write to the log file
                        </span>System.IO.File.AppendAllText(logFilePath, DateTime.Now.TimeOfDay.ToString() + Environment.NewLine);
                        Thread.Sleep(tenSecondsAsMS);
                    }

                }
                Trace.WriteLine(<span style="color: #a31515">&quot;Failed to mount&quot; </span>+ shareName, <span style="color: #a31515">&quot;Error&quot;</span>);
            }
            <span style="color: blue">catch </span>(Exception ex)
            {
                Trace.WriteLine(ex.ToString(), <span style="color: #a31515">&quot;Error&quot;</span>);
                <span style="color: blue">throw</span>;
            }

        }

        <span style="color: blue">public static bool </span>MapNetworkDrive(<span style="color: blue">string </span>localPath, <span style="color: blue">string </span>shareName, <span style="color: blue">string </span>userName, <span style="color: blue">string </span>password)
        {
            <span style="color: blue">int </span>exitCode = 1;

            <span style="color: blue">string </span>machineIP = <span style="color: blue">null</span>;
            <span style="color: blue">while </span>(exitCode != 0)
            {
                <span style="color: blue">int </span>i = 0;
                <span style="color: blue">string </span>error;

                var server = RoleEnvironment.Roles[<span style="color: #a31515">&quot;SMBServer&quot;</span>].Instances[0];
                machineIP = server.InstanceEndpoints[<span style="color: #a31515">&quot;SMB&quot;</span>].IPEndpoint.Address.ToString();
                machineIP = <span style="color: #a31515">&quot;\\\\&quot; </span>+ machineIP + <span style="color: #a31515">&quot;\\&quot;</span>;
                exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; use &quot; </span>+ localPath + <span style="color: #a31515">&quot; &quot; </span>+ machineIP + shareName + <span style="color: #a31515">&quot; &quot; </span>+ password + <span style="color: #a31515">&quot; /user:&quot;
                    </span>+ userName, <span style="color: blue">out </span>error, 20000);

                <span style="color: blue">if </span>(exitCode != 0)
                {
                    Trace.WriteLine(<span style="color: #a31515">&quot;Error mapping network drive, retrying in 10 seoconds error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Information&quot;</span>);
                    <span style="color: green">// clean up stale mounts and retry 
                    </span>ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; use &quot; </span>+ localPath + <span style="color: #a31515">&quot;  /delete&quot;</span>, <span style="color: blue">out </span>error, 20000);
                    Thread.Sleep(10000);
                    i++;
                    <span style="color: blue">if </span>(i &gt; 100) <span style="color: blue">break</span>;
                }
            }

            <span style="color: blue">if </span>(exitCode == 0)
            {
                Trace.WriteLine(<span style="color: #a31515">&quot;Success: mapped network drive&quot; </span>+ machineIP + shareName, <span style="color: #a31515">&quot;Information&quot;</span>);
                <span style="color: blue">return true</span>;
            }
            <span style="color: blue">else
                return false</span>;
        }

        <span style="color: blue">public static int </span>ExecuteCommand(<span style="color: blue">string </span>exe, <span style="color: blue">string </span>arguments, <span style="color: blue">out string </span>error, <span style="color: blue">int </span>timeout)
        {
            Process p = <span style="color: blue">new </span>Process();
            <span style="color: blue">int </span>exitCode;
            p.StartInfo.FileName = exe;
            p.StartInfo.Arguments = arguments;
            p.StartInfo.CreateNoWindow = <span style="color: blue">true</span>;
            p.StartInfo.UseShellExecute = <span style="color: blue">false</span>;
            p.StartInfo.RedirectStandardError = <span style="color: blue">true</span>;
            p.Start();
            error = p.StandardError.ReadToEnd();
            p.WaitForExit(timeout);
            exitCode = p.ExitCode;
            p.Close();

            <span style="color: blue">return </span>exitCode;
        }

        <span style="color: blue">public override bool </span>OnStart()
        {
            <span style="color: green">// Set the maximum number of concurrent connections 
            </span>ServicePointManager.DefaultConnectionLimit = 12;

            DiagnosticMonitorConfiguration dmc = DiagnosticMonitor.GetDefaultInitialConfiguration();
            dmc.Logs.ScheduledTransferLogLevelFilter = LogLevel.Verbose;
            dmc.Logs.ScheduledTransferPeriod = TimeSpan.FromMinutes(1);
            DiagnosticMonitor.Start(<span style="color: #a31515">&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot;</span>, dmc);
            Trace.WriteLine(<span style="color: #a31515">&quot;Diagnostics Setup comlete&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

            <span style="color: blue">return base</span>.OnStart();
        }
    } 
}
 </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><b>ServiceDefinition.csdef</b></p>
<pre class="code">&lt;?xml version=<span style="color: #a31515">&quot;1.0&quot; </span>encoding=<span style="color: #a31515">&quot;utf-8&quot;</span>?&gt;
&lt;ServiceDefinition name=<span style="color: #a31515">&quot;AzureDemo&quot; </span>xmlns=<span style="color: #a31515">&quot;http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceDefinition&quot;</span>&gt;
  &lt;WorkerRole name=<span style="color: #a31515">&quot;SMBServer&quot;</span>&gt;
    &lt;Runtime executionContext=<span style="color: #a31515">&quot;elevated&quot;</span>&gt;
    &lt;/Runtime&gt;
    &lt;Imports&gt;
      &lt;Import moduleName=<span style="color: #a31515">&quot;Diagnostics&quot; </span>/&gt;
    &lt;/Imports&gt;
    &lt;ConfigurationSettings&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;StorageConnectionString&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;driveName&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;driveSize&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserName&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserPassword&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;shareName&quot; </span>/&gt;
    &lt;/ConfigurationSettings&gt;
    &lt;LocalResources&gt;
      &lt;LocalStorage name=<span style="color: #a31515">&quot;AzureDriveCache&quot; </span>cleanOnRoleRecycle=<span style="color: #a31515">&quot;true&quot; </span>sizeInMB=<span style="color: #a31515">&quot;300&quot; </span>/&gt;
    &lt;/LocalResources&gt;
    &lt;Endpoints&gt;
      &lt;InternalEndpoint name=<span style="color: #a31515">&quot;SMB&quot; </span>protocol=<span style="color: #a31515">&quot;tcp&quot; </span>port=<span style="color: #a31515">&quot;445&quot; </span>/&gt;
    &lt;/Endpoints&gt;
  &lt;/WorkerRole&gt;
  &lt;WorkerRole name=<span style="color: #a31515">&quot;SMBClient&quot;</span>&gt;
    &lt;Imports&gt;
      &lt;Import moduleName=<span style="color: #a31515">&quot;Diagnostics&quot; </span>/&gt;
    &lt;/Imports&gt;
    &lt;ConfigurationSettings&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserName&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserPassword&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;shareName&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;localPath&quot; </span>/&gt;
    &lt;/ConfigurationSettings&gt;
  &lt;/WorkerRole&gt;
&lt;/ServiceDefinition&gt;</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><b>ServiceConfiguration.cscfg</b></p>
<pre class="code">&lt;?xml version=<span style="color: #a31515">&quot;1.0&quot; </span>encoding=<span style="color: #a31515">&quot;utf-8&quot;</span>?&gt;
&lt;ServiceConfiguration serviceName=<span style="color: #a31515">&quot;AzureDemo&quot; </span>xmlns=<span style="color: #a31515">&quot;http://schemas.microsoft.com/ServiceHosting/2008/10/ServiceConfiguration&quot; </span>osFamily=<span style="color: #a31515">&quot;1&quot; </span>osVersion=<span style="color: #a31515">&quot;*&quot;</span>&gt;
  &lt;Role name=<span style="color: #a31515">&quot;SMBServer&quot;</span>&gt;
    &lt;Instances count=<span style="color: #a31515">&quot;1&quot; </span>/&gt;
    &lt;ConfigurationSettings&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;StorageConnectionString&quot; </span>value=<span style="color: #a31515">&quot;DefaultEndpointsProtocol=http;AccountName=yourstorageaccount;AccountKey=yourkey&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; </span>value=<span style="color: #a31515">&quot;DefaultEndpointsProtocol=https;AccountName=yourstorageaccount;AccountKey=yourkey&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;driveName&quot; </span>value=<span style="color: #a31515">&quot;drive2&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;driveSize&quot; </span>value=<span style="color: #a31515">&quot;1000&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserName&quot; </span>value=<span style="color: #a31515">&quot;fileshareuser&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserPassword&quot; </span>value=<span style="color: #a31515">&quot;SecurePassw0rd&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;shareName&quot; </span>value=<span style="color: #a31515">&quot;sharerw&quot; </span>/&gt;
    &lt;/ConfigurationSettings&gt;
  &lt;/Role&gt;
  &lt;Role name=<span style="color: #a31515">&quot;SMBClient&quot;</span>&gt;
    &lt;Instances count=<span style="color: #a31515">&quot;2&quot; </span>/&gt;
    &lt;ConfigurationSettings&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot; </span>value=<span style="color: #a31515">&quot;DefaultEndpointsProtocol=https;AccountName=yourstorageaccount;AccountKey=yourkey&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserName&quot; </span>value=<span style="color: #a31515">&quot;fileshareuser&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;fileshareUserPassword&quot; </span>value=<span style="color: #a31515">&quot;SecurePassw0rd&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;shareName&quot; </span>value=<span style="color: #a31515">&quot;sharerw&quot; </span>/&gt;
      &lt;Setting name=<span style="color: #a31515">&quot;localPath&quot; </span>value=<span style="color: #a31515">&quot;K:&quot; </span>/&gt;
    &lt;/ConfigurationSettings&gt;
  &lt;/Role&gt;
&lt;/ServiceConfiguration&gt;</pre>
<p>&#160;</p>
<h3><b><em>The below was added on 11/17/11 </em></b></h3>
<p><b>High Availability Sample</b></p>
<p>We can modify this sample to increase the availability of the share by having multiple “Server” worker roles. First, we will modify the instance count on the server role to be 2:</p>
<pre class="code"><span style="color: blue">&lt;</span><span style="color: #a31515">Role </span><span style="color: red">name</span><span style="color: blue">=</span>&quot;<span style="color: blue">SMBServer</span>&quot;<span style="color: blue">&gt;
  &lt;</span><span style="color: #a31515">Instances </span><span style="color: red">count</span><span style="color: blue">=</span>&quot;<span style="color: blue">1</span>&quot; <span style="color: blue">/&gt;
</span></pre>
<p>&#160;</p>
<p><b>High Availability Server</b></p>
<p>Next, we need to modify the server to compete to mount the drive. The server that successfully mounts the drive will share it out as before. The other server will sit in a loop attempting to mount the drive. To support remote <a href="http://msdn.microsoft.com/en-us/library/windowsazure/ee691972.aspx">breaking</a> of the lease, we will also have the server that owns the lease check whether it still has the lease. To do this, I’ve added a new function “CompeteForMount” to the server.</p>
<p></p>
<pre class="code"><span style="color: blue">private void </span>CompeteForMount()
{
    <span style="color: blue">for </span>(; ; )
    {
        <span style="color: blue">try
        </span>{
            driveLetter = drive.Mount(localCache.MaximumSizeInMegabytes, DriveMountOptions.None);
        }
        <span style="color: blue">catch </span>(CloudDriveException)
        {
            <span style="color: green">// Wait 10 seconds, and try again
            </span>Thread.Sleep(10000);
            <span style="color: blue">continue</span>;
        }</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Then we will move all the firewall and sharing code from OnStart() into this new method. After that, we will go into a loop making sure the drive is still mounted.</p>
<p>&#160;</p>
<pre class="code"><span style="color: blue">for </span>(; ; )
{
    <span style="color: blue">try
    </span>{
        drive.Mount(localCache.MaximumSizeInMegabytes, DriveMountOptions.None);
        Thread.Sleep(10000);
    }
    <span style="color: blue">catch </span>(Exception)
    {
        <span style="color: green">// Go back and remount it
        </span><span style="color: blue">break</span>;
    }
}</pre>
<p>Finally, if the drive does get un-mounted, we should also remove the drive share.</p>
<p>&#160;</p>
<pre class="code">exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; share /d &quot; </span>+ path, <span style="color: blue">out </span>error, 10000);

<span style="color: blue">if </span>(exitCode != 0)
{
    <span style="color: green">//Log error and continue
    </span>Trace.WriteLine(<span style="color: #a31515">&quot;Error creating fileshare, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Warning&quot;</span>);
}</pre>
<p>This method will be called from Run() rather than going into a Sleep loop.</p>
<p><b></b></p>
<p><b>High Availability Client</b></p>
<p>On the client, we need to iterate through the servers to find the one that has shared out the drive and mount that. We can do that inside the MapNetworkDrive function:<br/>
  <br/><b></b></p>
<pre class="code"><span style="color: blue">bool </span>found = <span style="color: blue">false</span>;

<span style="color: blue">int </span>countServers = RoleEnvironment.Roles[<span style="color: #a31515">&quot;SMBServer&quot;</span>].Instances.Count;
<span style="color: blue">for </span>(<span style="color: blue">int </span>instance = 0; instance &lt; countServers; instance++)
{
    var server = RoleEnvironment.Roles[<span style="color: #a31515">&quot;SMBServer&quot;</span>].Instances[instance];</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Finally, the call to AppendAllText() in the client code will throw an exception when the drive becomes unavailable. That exception will cause the client to exit, and the client will be restarted and attach to the new server. We could further refine the client code by catching this exception and going back to the reconnect loop.</p>
<p><b>High Availability Server – WorkerRole.cs</b></p>
<p>The following is a full listing of the high availability server worker role.</p>
<pre class="code"><span style="color: blue">using </span>System;
<span style="color: blue">using </span>System.Collections.Generic;
<span style="color: blue">using </span>System.Diagnostics;
<span style="color: blue">using </span>System.Linq;
<span style="color: blue">using </span>System.Net;
<span style="color: blue">using </span>System.Threading;
<span style="color: blue">using </span>Microsoft.WindowsAzure;
<span style="color: blue">using </span>Microsoft.WindowsAzure.Diagnostics;
<span style="color: blue">using </span>Microsoft.WindowsAzure.ServiceRuntime;
<span style="color: blue">using </span>Microsoft.WindowsAzure.StorageClient;

<span style="color: blue">namespace </span>SMBServer
{
    <span style="color: blue">public class </span><span style="color: #2b91af">WorkerRole </span>: <span style="color: #2b91af">RoleEntryPoint
    </span>{
        <span style="color: blue">public static string </span>driveLetter = <span style="color: blue">null</span>;
        <span style="color: blue">public static </span><span style="color: #2b91af">CloudDrive </span>drive = <span style="color: blue">null</span>;
        <span style="color: blue">public static </span><span style="color: #2b91af">LocalResource </span>localCache = <span style="color: blue">null</span>;

        <span style="color: blue">public override void </span>Run()
        {
            Trace.WriteLine(<span style="color: #a31515">&quot;SMBServer entry point called&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

            CompeteForMount();
        }

        <span style="color: blue">public override bool </span>OnStart()
        {
            <span style="color: green">// Set the maximum number of concurrent connections 
            </span>ServicePointManager.DefaultConnectionLimit = 12;

            <span style="color: green">// Initialize logging and tracing
            </span><span style="color: #2b91af">DiagnosticMonitorConfiguration </span>dmc = <span style="color: #2b91af">DiagnosticMonitor</span>.GetDefaultInitialConfiguration();
            dmc.Logs.ScheduledTransferLogLevelFilter = <span style="color: #2b91af">LogLevel</span>.Verbose;
            dmc.Logs.ScheduledTransferPeriod = TimeSpan.FromMinutes(1);
            <span style="color: #2b91af">DiagnosticMonitor</span>.Start(<span style="color: #a31515">&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot;</span>, dmc);
            Trace.WriteLine(<span style="color: #a31515">&quot;Diagnostics Setup complete&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

            SetupDriveObject();

            Trace.WriteLine(<span style="color: #a31515">&quot;Exiting SMB Server OnStart&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

            <span style="color: blue">return base</span>.OnStart();
        }

        <span style="color: blue">private void </span>SetupDriveObject()
        {
            <span style="color: #2b91af">CloudStorageAccount </span>account = <span style="color: #2b91af">CloudStorageAccount</span>.Parse(<span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;StorageConnectionString&quot;</span>));

            <span style="color: blue">try
            </span>{
                <span style="color: #2b91af">CloudBlobClient </span>blobClient = account.CreateCloudBlobClient();
                <span style="color: #2b91af">CloudBlobContainer </span>driveContainer = blobClient.GetContainerReference(<span style="color: #a31515">&quot;drivecontainer&quot;</span>);
                driveContainer.CreateIfNotExist();

                String driveName = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;driveName&quot;</span>);
                localCache = <span style="color: #2b91af">RoleEnvironment</span>.GetLocalResource(<span style="color: #a31515">&quot;AzureDriveCache&quot;</span>);
                <span style="color: #2b91af">CloudDrive</span>.InitializeCache(localCache.RootPath, localCache.MaximumSizeInMegabytes);

                drive = <span style="color: blue">new </span><span style="color: #2b91af">CloudDrive</span>(driveContainer.GetBlobReference(driveName).Uri, account.Credentials);
                <span style="color: blue">try
                </span>{
                    drive.Create(<span style="color: blue">int</span>.Parse(<span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;driveSize&quot;</span>)));
                }
                <span style="color: blue">catch </span>(<span style="color: #2b91af">CloudDriveException </span>ex)
                {
                    Trace.WriteLine(ex.ToString(), <span style="color: #a31515">&quot;Warning&quot;</span>);
                }
            }
            <span style="color: blue">catch </span>(Exception ex)
            {
                Trace.WriteLine(ex.ToString(), <span style="color: #a31515">&quot;Error&quot;</span>);
                Trace.WriteLine(<span style="color: #a31515">&quot;Exiting&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);
                <span style="color: blue">throw</span>;
            }
        }

        <span style="color: blue">private void </span>CompeteForMount()
        {
            <span style="color: blue">for </span>(; ; )
            {
                <span style="color: blue">try
                </span>{
                    driveLetter = drive.Mount(localCache.MaximumSizeInMegabytes, <span style="color: #2b91af">DriveMountOptions</span>.None);
                }
                <span style="color: blue">catch </span>(<span style="color: #2b91af">CloudDriveException</span>)
                {
                    <span style="color: green">// Wait 10 seconds, and try again
                    </span>Thread.Sleep(10000);
                    <span style="color: blue">continue</span>;
                }

                <span style="color: blue">string </span>userName = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserName&quot;</span>);
                <span style="color: blue">string </span>password = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserPassword&quot;</span>);

                <span style="color: green">// Modify path to share a specific directory on the drive
                </span><span style="color: blue">string </span>path = driveLetter;
                <span style="color: blue">string </span>shareName = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;shareName&quot;</span>);
                <span style="color: blue">int </span>exitCode;
                <span style="color: blue">string </span>error;

                <span style="color: green">//Create the user account    
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot;user &quot; </span>+ userName + <span style="color: #a31515">&quot; &quot; </span>+ password + <span style="color: #a31515">&quot; /add&quot;</span>, <span style="color: blue">out </span>error, 10000);
                <span style="color: blue">if </span>(exitCode != 0)
                {
                    <span style="color: green">//Log error and continue since the user account may already exist
                    </span>Trace.WriteLine(<span style="color: #a31515">&quot;Error creating user account, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Warning&quot;</span>);
                }

                <span style="color: green">//Enable SMB traffic through the firewall
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;netsh.exe&quot;</span>, <span style="color: #a31515">&quot;firewall set service type=fileandprint mode=enable scope=all&quot;</span>, <span style="color: blue">out </span>error, 10000);
                <span style="color: blue">if </span>(exitCode != 0)
                {
                    <span style="color: blue">throw new </span>Exception(<span style="color: #a31515">&quot;Error setting up firewall, error msg:&quot; </span>+ error);
                }

                <span style="color: green">//Share the drive
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; share &quot; </span>+ shareName + <span style="color: #a31515">&quot;=&quot; </span>+ path + <span style="color: #a31515">&quot; /Grant:&quot;
                    </span>+ userName + <span style="color: #a31515">&quot;,full&quot;</span>, <span style="color: blue">out </span>error, 10000);

                <span style="color: blue">if </span>(exitCode != 0)
                {
                    <span style="color: green">//Log error and continue since the drive may already be shared
                    </span>Trace.WriteLine(<span style="color: #a31515">&quot;Error creating fileshare, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Warning&quot;</span>);
                }

                <span style="color: green">//Now, spin checking if the drive is still accessible.
                </span><span style="color: blue">for </span>(; ; )
                {
                    <span style="color: blue">try
                    </span>{
                        drive.Mount(localCache.MaximumSizeInMegabytes, <span style="color: #2b91af">DriveMountOptions</span>.None);
                        Thread.Sleep(10000);
                    }
                    <span style="color: blue">catch </span>(Exception)
                    {
                        <span style="color: green">// Go back and remount it
                        </span><span style="color: blue">break</span>;
                    }
                }

                <span style="color: green">//Drive is not accessible.  Remove the share
                </span>exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; share /d &quot; </span>+ path, <span style="color: blue">out </span>error, 10000);

                <span style="color: blue">if </span>(exitCode != 0)
                {
                    <span style="color: green">//Log error and continue
                    </span>Trace.WriteLine(<span style="color: #a31515">&quot;Error creating fileshare, error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Warning&quot;</span>);
                }
            }
        }

        <span style="color: blue">public static int </span>ExecuteCommand(<span style="color: blue">string </span>exe, <span style="color: blue">string </span>arguments, <span style="color: blue">out string </span>error, <span style="color: blue">int </span>timeout)
        {
            Process p = <span style="color: blue">new </span>Process();
            <span style="color: blue">int </span>exitCode;
            p.StartInfo.FileName = exe;
            p.StartInfo.Arguments = arguments;
            p.StartInfo.CreateNoWindow = <span style="color: blue">true</span>;
            p.StartInfo.UseShellExecute = <span style="color: blue">false</span>;
            p.StartInfo.RedirectStandardError = <span style="color: blue">true</span>;
            p.Start();
            error = p.StandardError.ReadToEnd();
            p.WaitForExit(timeout);
            exitCode = p.ExitCode;
            p.Close();

            <span style="color: blue">return </span>exitCode;
        }

        <span style="color: blue">public override void </span>OnStop()
        {
            <span style="color: blue">if </span>(drive != <span style="color: blue">null</span>)
            {
                drive.Unmount();
            }
            <span style="color: blue">base</span>.OnStop();
        }
    }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p><b>High Availability Client – WorkerRole.cs</b></p>
<p>The following is a listing of the high availability client.</p>
<pre class="code"><span style="color: blue">using </span>System;
<span style="color: blue">using </span>System.Collections.Generic;
<span style="color: blue">using </span>System.Diagnostics;
<span style="color: blue">using </span>System.Linq;
<span style="color: blue">using </span>System.Net;
<span style="color: blue">using </span>System.Threading;
<span style="color: blue">using </span>Microsoft.WindowsAzure;
<span style="color: blue">using </span>Microsoft.WindowsAzure.Diagnostics;
<span style="color: blue">using </span>Microsoft.WindowsAzure.ServiceRuntime;
<span style="color: blue">using </span>Microsoft.WindowsAzure.StorageClient;

<span style="color: blue">namespace </span>SMBClient
{
    <span style="color: blue">public class </span><span style="color: #2b91af">WorkerRole </span>: <span style="color: #2b91af">RoleEntryPoint
    </span>{
        <span style="color: blue">public const int </span>tenSecondsAsMS = 10000;
        <span style="color: blue">public override void </span>Run()
        {
            <span style="color: green">// The code here mounts the drive shared out by the server worker role
            // Each client role instance writes to a log file named after the role instance in the logfile directory

            </span><span style="color: #2b91af">Trace</span>.WriteLine(<span style="color: #a31515">&quot;SMBClient entry point called&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);
            <span style="color: blue">string </span>localPath = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;localPath&quot;</span>);
            <span style="color: blue">string </span>shareName = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;shareName&quot;</span>);
            <span style="color: blue">string </span>userName = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserName&quot;</span>);
            <span style="color: blue">string </span>password = <span style="color: #2b91af">RoleEnvironment</span>.GetConfigurationSettingValue(<span style="color: #a31515">&quot;fileshareUserPassword&quot;</span>);

            <span style="color: blue">string </span>logDir = localPath + <span style="color: #a31515">&quot;\\&quot; </span>+ <span style="color: #a31515">&quot;logs&quot;</span>;
            <span style="color: blue">string </span>fileName = <span style="color: #2b91af">RoleEnvironment</span>.CurrentRoleInstance.Id + <span style="color: #a31515">&quot;.txt&quot;</span>;
            <span style="color: blue">string </span>logFilePath = System.IO.<span style="color: #2b91af">Path</span>.Combine(logDir, fileName);

            <span style="color: blue">try
            </span>{

                <span style="color: blue">if </span>(MapNetworkDrive(localPath, shareName, userName, password) == <span style="color: blue">true</span>)
                {
                    System.IO.<span style="color: #2b91af">Directory</span>.CreateDirectory(logDir);

                    <span style="color: green">// do work on the mounted drive here
                    </span><span style="color: blue">while </span>(<span style="color: blue">true</span>)
                    {
                        <span style="color: green">// write to the log file
                        </span>System.IO.<span style="color: #2b91af">File</span>.AppendAllText(logFilePath, <span style="color: #2b91af">DateTime</span>.Now.TimeOfDay.ToString() + <span style="color: #2b91af">Environment</span>.NewLine);
                        
                        <span style="color: green">// If the file/share becomes inaccessible, AppendAllText will throw an exception and
                        // the worker role will exit, and then get restarted, and then it fill find the new share
                        
                        </span><span style="color: #2b91af">Thread</span>.Sleep(tenSecondsAsMS);
                    }

                }
                <span style="color: #2b91af">Trace</span>.WriteLine(<span style="color: #a31515">&quot;Failed to mount&quot; </span>+ shareName, <span style="color: #a31515">&quot;Error&quot;</span>);
            }
            <span style="color: blue">catch </span>(<span style="color: #2b91af">Exception </span>ex)
            {
                <span style="color: #2b91af">Trace</span>.WriteLine(ex.ToString(), <span style="color: #a31515">&quot;Error&quot;</span>);
                <span style="color: blue">throw</span>;
            }

        }

        <span style="color: blue">public static bool </span>MapNetworkDrive(<span style="color: blue">string </span>localPath, <span style="color: blue">string </span>shareName, <span style="color: blue">string </span>userName, <span style="color: blue">string </span>password)
        {
            <span style="color: blue">int </span>exitCode = 1;

            <span style="color: blue">string </span>machineIP = <span style="color: blue">null</span>;
            <span style="color: blue">while </span>(exitCode != 0)
            {
                <span style="color: blue">int </span>i = 0;
                <span style="color: blue">string </span>error;
                <span style="color: blue">bool </span>found = <span style="color: blue">false</span>;

                <span style="color: blue">int </span>countServers = <span style="color: #2b91af">RoleEnvironment</span>.Roles[<span style="color: #a31515">&quot;SMBServer&quot;</span>].Instances.Count;
                <span style="color: blue">for </span>(<span style="color: blue">int </span>instance = 0; instance &lt; countServers; instance++)
                {
                    <span style="color: blue">var </span>server = <span style="color: #2b91af">RoleEnvironment</span>.Roles[<span style="color: #a31515">&quot;SMBServer&quot;</span>].Instances[instance];
                    machineIP = server.InstanceEndpoints[<span style="color: #a31515">&quot;SMB&quot;</span>].IPEndpoint.Address.ToString();
                    machineIP = <span style="color: #a31515">&quot;\\\\&quot; </span>+ machineIP + <span style="color: #a31515">&quot;\\&quot;</span>;
                    exitCode = ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; use &quot; </span>+ localPath + <span style="color: #a31515">&quot; &quot; </span>+ machineIP + shareName + <span style="color: #a31515">&quot; &quot; </span>+ password + <span style="color: #a31515">&quot; /user:&quot;
                        </span>+ userName, <span style="color: blue">out </span>error, 20000);

                    <span style="color: blue">if </span>(exitCode != 0)
                    {
                        <span style="color: #2b91af">Trace</span>.WriteLine(<span style="color: #a31515">&quot;Error mapping network drive, retrying in 10 seoconds error msg:&quot; </span>+ error, <span style="color: #a31515">&quot;Information&quot;</span>);
                        <span style="color: green">// clean up stale mounts and retry 
                        </span>ExecuteCommand(<span style="color: #a31515">&quot;net.exe&quot;</span>, <span style="color: #a31515">&quot; use &quot; </span>+ localPath + <span style="color: #a31515">&quot;  /delete&quot;</span>, <span style="color: blue">out </span>error, 20000);
                    }
                    <span style="color: blue">else
                    </span>{
                        found = <span style="color: blue">true</span>;
                        <span style="color: blue">break</span>;
                    }
                }

                <span style="color: blue">if </span>(!found)
                {
                    <span style="color: #2b91af">Thread</span>.Sleep(10000);

                    i++;
                    <span style="color: blue">if </span>(i &gt; 100)
                    {
                        <span style="color: blue">break</span>;
                    }
                }
            }

            <span style="color: blue">if </span>(exitCode == 0)
            {
                <span style="color: #2b91af">Trace</span>.WriteLine(<span style="color: #a31515">&quot;Success: mapped network drive&quot; </span>+ machineIP + shareName, <span style="color: #a31515">&quot;Information&quot;</span>);
                <span style="color: blue">return true</span>;
            }
            <span style="color: blue">else
                return false</span>;
        }

        <span style="color: blue">public static int </span>ExecuteCommand(<span style="color: blue">string </span>exe, <span style="color: blue">string </span>arguments, <span style="color: blue">out string </span>error, <span style="color: blue">int </span>timeout)
        {
            <span style="color: #2b91af">Process </span>p = <span style="color: blue">new </span><span style="color: #2b91af">Process</span>();
            <span style="color: blue">int </span>exitCode;
            p.StartInfo.FileName = exe;
            p.StartInfo.Arguments = arguments;
            p.StartInfo.CreateNoWindow = <span style="color: blue">true</span>;
            p.StartInfo.UseShellExecute = <span style="color: blue">false</span>;
            p.StartInfo.RedirectStandardError = <span style="color: blue">true</span>;
            p.Start();
            error = p.StandardError.ReadToEnd();
            p.WaitForExit(timeout);
            exitCode = p.ExitCode;
            p.Close();

            <span style="color: blue">return </span>exitCode;
        }

        <span style="color: blue">public override bool </span>OnStart()
        {
            <span style="color: green">// Set the maximum number of concurrent connections 
            </span><span style="color: #2b91af">ServicePointManager</span>.DefaultConnectionLimit = 12;

            <span style="color: #2b91af">DiagnosticMonitorConfiguration </span>dmc = <span style="color: #2b91af">DiagnosticMonitor</span>.GetDefaultInitialConfiguration();
            dmc.Logs.ScheduledTransferLogLevelFilter = <span style="color: #2b91af">LogLevel</span>.Verbose;
            dmc.Logs.ScheduledTransferPeriod = <span style="color: #2b91af">TimeSpan</span>.FromMinutes(1);
            <span style="color: #2b91af">DiagnosticMonitor</span>.Start(<span style="color: #a31515">&quot;Microsoft.WindowsAzure.Plugins.Diagnostics.ConnectionString&quot;</span>, dmc);
            <span style="color: #2b91af">Trace</span>.WriteLine(<span style="color: #a31515">&quot;Diagnostics Setup comlete&quot;</span>, <span style="color: #a31515">&quot;Information&quot;</span>);

            <span style="color: blue">return base</span>.OnStart();
        }
    }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-drives/" rel="tag">Windows Azure Drives</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (22)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-2711">
				<div id="div-comment-2711" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Peter kellner</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2711">
			April 25, 2011 at 11:59 am</a>		</div>

		<p>What about getting to the drive from a windows client?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2701">
				<div id="div-comment-2701" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Dinesh Haridas</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2701">
			April 26, 2011 at 12:13 am</a>		</div>

		<p>Currently we don&#39;t support accessing Azure Drives from outside the cloud.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2691">
				<div id="div-comment-2691" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">David Rodriguez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2691">
			April 26, 2011 at 4:13 pm</a>		</div>

		<p>Hi Dinesh, </p>
<p>I understand that this code can&#39;t be run on development environment, since sharing a folder (or a the drive) on an X-Drive in development is not supported, raising an error &quot;Device or folder does not exist&quot; (see NET HELPMSG 2116) when trying to share. Is this true or I&#39;m losing something? When I try to share the same folder through a windows explorer, I have the same error.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2681">
				<div id="div-comment-2681" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Dinesh Haridas</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2681">
			April 26, 2011 at 9:10 pm</a>		</div>

		<p>David, thats correct. This sample won&#39;t work in the development environment because the drive created in the storage emulator cannot be shared. You will run into the same issue with Windows Explorer too.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2671">
				<div id="div-comment-2671" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">David Rodriguez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2671">
			April 27, 2011 at 8:49 am</a>		</div>

		<p>Hum&#8230;ok, then I&#39;ll introduce some conditional compiling like #ifdebug or something similar to do a hard-coded path sharing on development environment to workaround the issue.</p>
<p>Thanks for your confirmation 🙂 </p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2651">
				<div id="div-comment-2651" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">David Rodriguez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2651">
			May 2, 2011 at 5:58 pm</a>		</div>

		<p>Hi again Dinesh,</p>
<p>Take a look of the job based on the idea that you commented here. 🙂</p>
<p><a rel="nofollow" target="_new" href="http://bit.ly/DNNAzureSMB">http://bit.ly/DNNAzureSMB</a></p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2641">
				<div id="div-comment-2641" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">yazeem</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2641">
			June 30, 2011 at 10:23 am</a>		</div>

		<p>Hi,</p>
<p>Is it necessary to call MapNetworkDrive(..) every time Web Role wants to connect to SMBServer? If we create a static variable in our WebRole and after calling MapNetworkDrive(..) shared path is stored in that static variable, then our WebRole can use that path in static variable to perform drive operations.</p>
<p>I want to know is this a right approach as i have tested it and its working fine. For how long the connection persists if we use it from static variable ?</p>
<p>Also if we use the path stored in static variable whether SMBServer will be involved in further communications with xdrive ?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2631">
				<div id="div-comment-2631" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Dinesh Haridas</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2631">
			July 2, 2011 at 4:58 pm</a>		</div>

		<p>MapNetworkDrive needs to be called only when the share is first being mapped to a drive letter on the client. Once thats done the client can continue to access the share without calling the MapNetworkDrive routine.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2621">
				<div id="div-comment-2621" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">David Rodriguez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2621">
			July 22, 2011 at 6:10 am</a>		</div>

		<p>Hum&#8230;I&#39;ve check that the link of the DNN Azure project is broken. The final solution is on Codeplex here for more info <a rel="nofollow" target="_new" href="http://dnnazureaccelerator.codeplex.com/">dnnazureaccelerator.codeplex.com</a></p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-benjguin odd alt thread-odd thread-alt depth-1" id="comment-2611">
				<div id="div-comment-2611" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Benjamin+GUINEBERTIERE&amp;size=extralarge&amp;version=8e95cb97-3292-4cce-977d-0534abecfaee" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="https://social.msdn.microsoft.com/profile/Benjamin+GUINEBERTIERE" rel="external nofollow" class="url">Benjamin GUINEBERTIERE</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2611">
			November 16, 2011 at 1:58 pm</a>		</div>

		<p>If the SMBServer single instance fails, then all the other instances loose their access to the drive and this will last until Windows Azure restarts a new SMBServer instance which may take ~8 to 15 minutes. That&#39;s a long downtime for a DNN web site for instance if this happens once or twice a month&#8230;</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2601">
				<div id="div-comment-2601" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2601">
			November 17, 2011 at 8:03 pm</a>		</div>

		<p>Hi Benjamin,</p>
<p>Yes, with a single SMB server instance the downtime could be significant. &nbsp;As mentioned in the original post, you can improve on the implementation by having multiple server instances running. &nbsp;I added a &#39;High Availability&quot; sample to demonstrate how you can get a faster recovery.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Windows Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2591">
				<div id="div-comment-2591" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Aaron Hayon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2591">
			February 22, 2012 at 10:43 am</a>		</div>

		<p>There seems to be one issue with the above implementation. &nbsp;The user you set up will have a password that will expire based on the default group policy. &nbsp;Is there a way create the user where the password never expires? &nbsp;I know that you can use the /expire:never parameter for net.exe but that does not set the password to never expire.</p>
<p>Any Ideas?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2581">
				<div id="div-comment-2581" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2581">
			March 19, 2012 at 9:08 am</a>		</div>

		<p>Hi Aaron,</p>
<p>The system policy is that passwords expire in about a month. &nbsp;You can change that (see &#39;net accounts /?&#39;) for a VMRole, but for Web and Worker roles, the policy will get changed back. &nbsp;Another option is to update the password with &#39;net user &lt;username&gt; &lt;password&gt;&#39; on a regular basis. &nbsp;If you do go this route, I would recommend creating a way that you can change the password from time to time for defense-in-depth security.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Windows Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2571">
				<div id="div-comment-2571" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Cristhian Amaya</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2571">
			March 29, 2012 at 8:26 am</a>		</div>

		<p>Hi,</p>
<p>I have a Web Role connected to SMBServer, when I log in via RDP all works fine, but the web application not have access to the disk, even sharing drive to Everyone with all permissions.</p>
<p>Any ideas?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2561">
				<div id="div-comment-2561" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2561">
			March 30, 2012 at 12:49 pm</a>		</div>

		<p>Hi Cristhian,</p>
<p>&quot;Net use&quot; connects to the server in the user context in which you call it. &nbsp;Since the webrole runs with limited access, you have to put the &quot;net use&quot; call into that context. I would recommend trying it from Application_Start.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Windows Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2551">
				<div id="div-comment-2551" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">AzureDeveloper</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2551">
			October 12, 2012 at 12:13 am</a>		</div>

		<p>Hi,</p>
<p>My webrole is configured as the SMB server. I even ran the net use command from Application_Start. I am getting this error &quot;System error 1332 has occurred.No mapping between account names and security IDs was done&quot;. Can you help me out?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2541">
				<div id="div-comment-2541" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/b4543eb0abb0edb9aeddab3f069c1c9b?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/b4543eb0abb0edb9aeddab3f069c1c9b?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/aidas.stalmokas_4000_sis.lt/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">aidas.stalmokas@sis.lt</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2541">
			April 23, 2013 at 7:44 am</a>		</div>

		<p>Hi,</p>
<p>I just tried to implement this approach.</p>
<p>The CLIENT role started working only with executionContext=&quot;elevated&quot; like on SERVER (otherwise SecurityException was thrown).</p>
<p>But now I have stuck with some unexpected behaviour:</p>
<p>1) SERVER mounts a drive to &quot;b:&quot;. Trying to check if directory &quot;b:\logs&quot; ehsists (in a loop each 60 secs) returns FALSE 🙁 . &nbsp;Is it OK? How can view the content of the DRIVE?</p>
<p>2) I deployed project with 3 instances of ClientRole. Each mounts a share to M:, creates logs catalog and creates/updates its TXT file. This part is working with some strange fact that I see file really in E:logs catalog. And i see only one file per instance. Tried to write code to look for files which should be created from another instances &#8211; File.Exists(???) returns FALSE.</p>
<p>3) I downloaded the DRIVE with &quot;Azure storage explore&quot;, mounted to local disk on Win7 and &#8230; see it is EMPTY. </p>
<p>All these facts are not working the way anybody would expect.</p>
<p>AM I DOING SOMTHING WRONG?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2531">
				<div id="div-comment-2531" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2531">
			April 26, 2013 at 9:23 am</a>		</div>

		<p>Hi Aidas,</p>
<p>I would recommend logging into one of your client instances and running &quot;net use&quot; on the command line, which will list the shares your have mounted. &nbsp;This might help clarify what is happening with your implementation.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Windows Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2521">
				<div id="div-comment-2521" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">James</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2521">
			May 1, 2013 at 9:08 am</a>		</div>

		<p>We are having the same issue as Aidas Stalmokas in that our two instances (one the server and one the client) get different views of the mounted drive. File.Exists returns false for a particular file on the client but true on the server. I suspect there may be some interaction between the azure cloud drive cacheing and the SMB protocol (possible oplocks related)? I have googled around the SMB protocol and there are many reported issues with multiple clients reading/writing to the same file shared over SMB. I am considering resorting to NFS or another sharing protocol. I would love to know if MS are able to reproduce this problem and if they have any suggestions as to the underlying issues&#8230;a potential workaround or resolution would be nice!</p>
<p>Kind Regards,</p>
<p>James.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2511">
				<div id="div-comment-2511" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2511">
			May 2, 2013 at 2:50 pm</a>		</div>

		<p>Hi James,</p>
<p>Can you give me more specifics of your scenario:</p>
<p> &nbsp; Are these worker roles or web roles?</p>
<p> &nbsp; Which is the SMB server with the drive mounted, and which is the client?</p>
<p> &nbsp; Which flavor of the OS are you running?</p>
<p> &nbsp; Which SDK are you using?</p>
<p> &nbsp; Have you connected to the machines and checked the files and shares using &#39;dir&#39; and &#39;net use&#39;?</p>
<p> &nbsp; Which data center are you deployed to?</p>
<p>I believe there may be a small delay (seconds) between when you create a file from one client and when another client will detect it with File.Exists. &nbsp;This is the normal behavior of SMB, as the clients cache the directory contents for a short period to reduce round trips to the server and improve performance. &nbsp;However, by the time you connect to the machine later, the files should be visible. &nbsp;Another option is to disable this cache. &nbsp;For that, see: <a rel="nofollow" target="_new" href="http://technet.microsoft.com/en-us/library/ff686200(v=WS.10).aspx">technet.microsoft.com/&#8230;/ff686200(v=WS.10).aspx</a></p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Windows Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2501">
				<div id="div-comment-2501" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">David Hernandez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2501">
			November 18, 2013 at 1:25 pm</a>		</div>

		<p>How about using Windows DFS for high availability? I guess this is a more standard way to implement a fault tolerant network share, and more robust tan a warm stand-by servers&#8230;.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2491">
				<div id="div-comment-2491" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Jay</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/04/16/using-smb-to-share-a-windows-azure-drive-among-multiple-role-instances/#comment-2491">
			July 24, 2014 at 1:07 am</a>		</div>

		<p>I have an MVC application that I deploy to azure as a cloud service as a web role as follows:</p>
<p>public class WebRole : RoleEntryPoint</p>
<p>{</p>
<p> &nbsp; &nbsp;public override bool OnStart()</p>
<p> &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;// For information on handling configuration changes</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;// see the MSDN topic at <a rel="nofollow" target="_new" href="http://go.microsoft.com/fwlink/?LinkId=166357">go.microsoft.com/fwlink</a>.</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;try</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Retrieve an object that points to the local storage resource.</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;LocalResource localResource = RoleEnvironment.GetLocalResource(&quot;TempZipDirectory&quot;); // Todo name from config instread of hardcoding it</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;string path = localResource.RootPath;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;CreateVirtualDirectory(&quot;SCORM&quot;, localResource.RootPath);</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;catch (RoleEnvironmentException e)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// Debug.WriteLine(&quot;Exception caught in RoleEntryPoint:OnStart: &quot; &amp; ex.Message, &quot;Critical&quot;)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;return base.OnStart();</p>
<p> &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp;public static void CreateVirtualDirectory(string VDirName, string physicalPath)</p>
<p> &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;try</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (VDirName[0] != &#39;/&#39;)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;VDirName = &quot;/&quot; + VDirName;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;using (var serverManager = new ServerManager())</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;string siteName = RoleEnvironment.CurrentRoleInstance.Id + &quot;_&quot; + &quot;Web&quot;;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//Site theSite = serverManager.Sites[siteName];</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Site theSite = serverManager.Sites[0];</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;foreach (var app in theSite.Applications)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;if (app.Path == VDirName)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// already exists</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return;</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;Microsoft.Web.Administration.VirtualDirectory vDir = theSite.Applications[0].VirtualDirectories.Add(VDirName, physicalPath);</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;serverManager.CommitChanges();</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;catch (Exception ex)</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;System.Diagnostics.EventLog.WriteEntry(&quot;Application&quot;, ex.Message, System.Diagnostics.EventLogEntryType.Error);</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;//System.Diagnostics.EventLog.WriteEntry(&quot;Application&quot;, ex.InnerException.Message, System.Diagnostics.EventLogEntryType.Error);</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p> &nbsp; &nbsp;}</p>
<p>How can I combine this approach so that I can set the SMB share as the virtual directory onstart of each of my instances. Currently they are configured to point to a folder on the local role environment, this was fine in single instance but on high availability I am getting issues with files not being found when users jump across instances from the instance to which the files where initially uploaded</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F04%2F16%2Fusing-smb-to-share-a-windows-azure-drive-among-multiple-role-instances%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->