---
layout: windowsazurestorage
title: Protecting Your Blobs Against Application Errors
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-17" class="post-17 post type-post status-publish format-standard hentry category-uncategorized tag-windows-azure-blobs">

	<header class="entry-header single">
		<h1 class="entry-title">Protecting Your Blobs Against Application Errors</h1>		<div class="rating-wrap">
		<div id="star-rating-17" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="17" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2010-04-29T22:12:00+00:00">April 29, 2010</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/&quot;, &quot;text&quot;: &quot;Protecting Your Blobs Against Application Errors&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/&quot;, &quot;text&quot;: &quot;Protecting Your Blobs Against Application Errors&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>A question we get asked is the following - Do applications need to backup data stored in Windows Azure Storage if Windows Azure Storage already stores multiple replicas of the data? For business continuity, it can be important to protect the data against errors in the application, which may erroneously modify the data.</p>
<p>The replication of data in Windows Azure Storage will not protect against application errors since these are problems at the application layer which will get committed on the replicas that Windows Azure Storage maintains. Currently, many application developers implement their own backup strategy. The purpose of this post is to briefly cover a few strategies that one can use to backup data. We will classify backup strategies based on blob service here, and table service in a later post.</p>
<h5>Backing up Blob Data</h5>
<p>To create backups in blob service, one first creates a snapshot of the blob. This creates a read only version of the blob. The snapshot blob can be read, copied or deleted but never modified. The great news here is that for a snapshot, you will be charged only for the unique blocks or pages that differ from the base blob (i.e. the blob to which the snapshot belongs to). What this implies is that if the base blob is never modified, you will be charged only for a single copy of the blocks/pages.</p>
<p>The following code shows how to create a snapshot of a blob:</p>
<pre class="code"><span style="color: #2b91af">CloudBlobClient </span>blobClient = <span style="color: blue">new </span><span style="color: #2b91af">CloudBlobClient</span>(baseUri, credentials);
<span style="color: #2b91af">CloudBlobContainer </span>cloudContainer = blobClient.GetContainerReference(containerName);
<span style="color: #2b91af">CloudBlob </span>cloudBlob = cloudContainer.GetBlobReference(<span style="color: #a31515">&quot;docs/mix2010.ppt&quot;</span>);
<span style="color: #2b91af">CloudBlob </span>backupSnapshot = cloudBlob.CreateSnapshot(); <br/> <br/> </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>&#160;</p>
<p>When you create a snapshot, the snapshot blob gets assigned a unique timestamp This timestamp is returned in the x-ms-snapshot and provides the blob snapshot name. The snapshot name has the same name as the original blob, just extended with the snapshot datetime. For example: The following Uri can be used to address the snapshot:</p>
<p><a href="http://account.blob.core.windows.net/container/docs/mix2010.ppt?snapshot=2010-03-07T00%3A12%3A14.1496934Z">http://account.blob.core.windows.net/container/docs/mix2010.ppt?<b>snapshot=2010-03-07T00%3A12%3A14.1496934Z</b> </a></p>
<p>When creating a snapshot you can store new metadata with the snapshot blob at the time the snapshot is created, but after the snapshot is created you cannot modify the metadata nor the blob. If no metadata is provided when performing the snapshot, then the metadata from the base blob is copied over to the snapshot blob.</p>
<p>If we want to take a snapshot and make it the current read/writeable version of the blob we can do that by copying the snapshot to be the current version of the blob using “CopyBlob”. </p>
<pre class="code"><span style="color: #2b91af">CloudBlobClient </span>blobClient = <span style="color: blue">new </span><span style="color: #2b91af">CloudBlobClient</span>(baseUri, credentials);
<span style="color: #2b91af">CloudBlobContainer </span>cloudContainer = blobClient.GetContainerReference(containerName);
<span style="color: #2b91af">CloudBlob </span>baseBlob = cloudContainer.GetBlobReference(baseBlobName);
<span style="color: #2b91af">CloudBlob </span>backupSnapshot = cloudContainer.GetBlobReference(snapshotBlobName);
baseBlob.CopyFrom(backupSnapshot); <br/> <br/> </pre>
<p>To delete a blob with snapshots, you need to also delete all the snapshots. A single delete request can achieve deleting the blob and snapshots by using the x-ms-delete-snapshots header which can be set to </p>
<ul>
<li>include - delete the base blob and snapshots </li>
<li>only - delete only the snapshots </li>
</ul>
<p>If the blob has snapshots, and you try to delete the blob without using the “x-ms-delete-snapshots: include” option, then the delete will fail. The Storage Client library by default will not send the include header which results in the error being returned. If you want to delete a blob with it snapshots, specify the DeleteSnapshotsOption in BlobRequestOptions as follows:</p>
<pre class="code">blob.Delete(<span style="color: blue">new </span>BlobRequestOptions()
{
<span style="color: #2b91af">DeleteSnapshotsOption </span>= <span style="color: #2b91af">DeleteSnapshotsOption</span>.IncludeSnapshots
}); <br/> </pre>
<p>Since snapshots cannot be retained when the container or base blob is deleted, a backup strategy that uses snapshots has to be careful that it does not incorrectly use delete container or delete blob that specifies the x-ms-delete-snapshots header. </p>
<h5>Blob Backup Strategy</h5>
<p>Let us now go over one of the strategies that can be used to create backups. Please note that this is just a simple strategy and you may want to tweak it as per your needs.</p>
<p>We will assume that every container that needs to be backed up will be marked with a metadata “shouldbackup”. The backup job then iterates through each container and for each container that has the metadata set, it will snapshot all base blobs that have changed since the last snapshot. We will also ensure that at most N snapshots are maintained and that any snapshot which is more than X days old are deleted if it is not the only backup snapshot (where N and X are configurable when running the backup). To differentiate between snapshots that the backup process creates from what the user may create, we will add a metadata field “isbackedup” to the snapshot when it is created. This seems like a simple enough strategy that ensures that we have a snapshot available for recovery.</p>
<p>We will break down the above strategy into a few crucial modules. Some are extensions to what the current Storage Client provides: </p>
<ol>
<li><b>List all containers</b> - this utilizes the listing capability that the Storage client provides. One can improve speed by processing containers in parallel, which we will leave as an exercise. </li>
<li><b>Create a snapshot for backup</b> – this provides all the metadata that the snapshot should have. The CreateSnapshot API in the StorageClient does not send metadata information and therefore all metadata from base blob is copied over to the snapshot but we want to add the new metadata “isbackedup” to the snapshot. </li>
<li><b>Group snapshots with base blob</b> – provide a structure that maintains the relationship between the base blob and its snapshots so that we can enforce the rules such as retain atmost N backups etc. This involves listing all blobs and group each base blob with its snapshots. The current library allows you to list snapshot and base blobs but does not provide a relationship between the base blob and the snapshot. We need to list them and build the relation as we iterate. </li>
<li><strong>Garbage collect backup snapshots</strong> - delete the oldest snapshot when snapshot count &gt; N or if the snapshot is older than X days if it is not the only snapshot. </li>
</ol>
<p>Code for container listing :</p>
<pre class="code"><span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">Lists all containers and back all the base blobs in each container
</span><span style="color: gray">/// &lt;/summary&gt;
/// &lt;param name=&quot;blobClient&quot;&gt;&lt;/param&gt;
</span><span style="color: blue">public static void </span>BackupAllBlobs(<span style="color: #2b91af">CloudBlobClient </span>blobClient)
{
    <span style="color: blue">if </span>(blobClient == <span style="color: blue">null</span>)
    {
        <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">&quot;blobClient&quot;</span>);
    }    
    <span style="color: blue">try
    </span>{
        <span style="color: green">// list containers and backup each container
      </span><span style="color: #2b91af">ResultContinuation </span>continuation = <span style="color: blue">null</span>;   
        <span style="color: blue">do
        </span>{
            <span style="color: #2b91af">ResultSegment</span>&lt;<span style="color: #2b91af">CloudBlobContainer</span>&gt; containers = blobClient.ListContainersSegmented(
                <span style="color: blue">null</span>, <span style="color: #2b91af">ContainerListingDetails</span>.Metadata, 0, continuation);
            continuation = containers.ContinuationToken;

            <span style="color: blue">foreach </span>(<span style="color: #2b91af">CloudBlobContainer </span>container <span style="color: blue">in </span>containers.Results)
            {
                <span style="color: blue">if </span>(!<span style="color: blue">string</span>.IsNullOrEmpty(container.Attributes.Metadata[<span style="color: #a31515">&quot;shouldbackup&quot;</span>]))
                {
                      BackupBlobsInContainer(container);
                }
            }
        } <span style="color: blue">while </span>(continuation != <span style="color: blue">null</span>);
    }
    <span style="color: blue">catch </span>(<span style="color: #2b91af">Exception </span>e)
    {
        <span style="color: green">// log exception details for debugging
        </span><span style="color: blue">throw</span>;
    }
} <br/> </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The following code lists all the blobs in the container and builds the BlobSnapshotInfo structure which maintains the relationship between the base blob and all its snapshots. When we list the blobs in the container, the snapshots precede the base blob and the snapshots are listed in the ascending order of the snapshot timestamp. We use this listing characteristic to build the BlobSnapshotInfo structure. </p>
<pre class="code"><span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">Lists all blobs in a container and create a snapshot if required. It will build a BlobSnapshotInfo structure
</span><span style="color: gray">/// </span><span style="color: green">to maintain the relationship between base blob and snapshot. 
</span><span style="color: gray">/// &lt;/summary&gt;
/// &lt;param name=&quot;state&quot;&gt;&lt;/param&gt;
</span><span style="color: blue">private static void </span>BackupBlobsInContainer(<span style="color: #2b91af">CloudBlobContainer </span>container)
{
    <span style="color: green">// list all blobs and snapshots here
    </span><span style="color: #2b91af">BlobRequestOptions </span>options = <span style="color: blue">new </span><span style="color: #2b91af">BlobRequestOptions</span>()
        {
            BlobListingDetails = <span style="color: #2b91af">BlobListingDetails</span>.Snapshots | <span style="color: #2b91af">BlobListingDetails</span>.Metadata,
            UseFlatBlobListing = <span style="color: blue">true
        </span>};

    <span style="color: #2b91af">ResultContinuation </span>continuation = <span style="color: blue">null</span>;

   <span style="color: green">// We will maintain a BlobSnapshotInfo structure here and make use of the fact that snapshots and blobs 
   // share the same name and hence they will be grouped together in the listing. Snapshots precede base blob in the
   // listing. We therefore create a dummy base blob and then set it when we get the real base blob.
   // It also maintains information about those snapshots that have the isbackup metadata set.
    </span>BlobSnapshotInfo currentBackupInfo = <span style="color: blue">null</span>;
    <span style="color: blue">do
    </span>{
        <span style="color: #2b91af">ResultSegment</span>&lt;<span style="color: #2b91af">IListBlobItem</span>&gt; blobListSegment = container.ListBlobsSegmented(0, continuation, options);
        continuation = blobListSegment.ContinuationToken;

        <span style="color: blue">foreach </span>(<span style="color: #2b91af">CloudBlob </span>blob <span style="color: blue">in </span>blobListSegment.Results)
        {
            <span style="color: green">// if this blob does not belong to current backup info, it implies
            // that the base blob may be deleted. 
            </span><span style="color: blue">if </span>(currentBackupInfo != <span style="color: blue">null </span>&amp;&amp; !<span style="color: #2b91af">Uri</span>.Equals(currentBackupInfo.BaseBlob.Uri, blob.Uri))
            {
                <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: blue">string</span>.Format(
                    CultureInfo.InvariantCulture,  <span style="color: #a31515">&quot;The current blob '{0}' does not match current blob info '{1}'&quot;</span>,
                    blob.Uri.AbsolutePath,  currentBackupInfo.BaseBlob.Uri.AbsolutePath));
            }
            <span style="color: blue">if </span>(currentBackupInfo == <span style="color: blue">null</span>)
            {
                <span style="color: green">// we do not have a backup info yet. Let us create one by using a dummy base blob
                // if this is not a base blob
                </span><span style="color: #2b91af">CloudBlob </span>baseBlob = blob;
                <span style="color: blue">if </span>(blob.SnapshotTime.HasValue)
                {
                    <span style="color: #2b91af">Uri </span>uri = <span style="color: blue">new </span><span style="color: #2b91af">Uri</span>(blob.ServiceClient.BaseUri, blob.Uri.AbsolutePath);
                    baseBlob = <span style="color: blue">new </span><span style="color: #2b91af">CloudBlob</span>(uri.AbsoluteUri);
                }

                currentBackupInfo = <span style="color: blue">new </span>BlobSnapshotInfo(baseBlob);
            }
            <span style="color: blue">if </span>(blob.SnapshotTime.HasValue)
            {
                <span style="color: blue">string </span>isBackup = blob.Attributes.Metadata[BlobSnapshotInfo.IsBackupMetadata];
                <span style="color: blue">if </span>(<span style="color: blue">string</span>.IsNullOrEmpty(isBackup))
                {
                    <span style="color: green">// this is one of users snapshot
                    </span><span style="color: blue">continue</span>;
                }

                currentBackupInfo.AddSnapshot(blob);
            }
            <span style="color: blue">else
            </span>{
                <span style="color: green">// the blob is always listed after all snapshots - so we can now process it to 
                // see if snapshot is required and then set it back to null
                </span>currentBackupInfo.BaseBlob = blob;
                currentBackupInfo.SnapshotIfRequired();
                currentBackupInfo = <span style="color: blue">null</span>;
            }
        }
    } <span style="color: blue">while </span>(continuation != <span style="color: blue">null</span>);
} <br/> </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>We shall now describe the BlobSnapshotInfo structure in detail. This class is used to maintain the relationship between base blob and its snapshots. It maintains ‘N’ snapshots and when the next snapshot is added, it will delete the oldest snapshot. It also deletes any snapshots older than X days unless it is the only snapshot available. It uses a blob extension method to create the snapshot with required metadata. CreateSnapshot implementation is described a little later.</p>
<pre class="code"><span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">A class to maintain relationships between base blobs and their snapshots. 
</span><span style="color: gray">/// </span><span style="color: green">It also does the bookkeeping such that we do not have more than N snapshots (i.e. MaxSnapshots) and
</span><span style="color: gray">/// </span><span style="color: green">we do not keep snapshots older than X days (i.e. MaxDaysToRetainDeletedBlobSnapshots)  
</span><span style="color: gray">/// </span><span style="color: green">unless it is the last snapshot
</span><span style="color: gray">/// &lt;/summary&gt;
</span><span style="color: blue">internal class </span><span style="color: #2b91af">BlobSnapshotInfo
</span>{
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">metadata maintained on the snapshot to indicate that it was created by the backup
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">internal const string </span>IsBackupMetadata = <span style="color: #a31515">&quot;isbackedup&quot;</span>;
    <span style="color: blue">internal const int </span>MaxSnapshots = 3;
    <span style="color: blue">internal readonly static </span><span style="color: #2b91af">TimeSpan </span>MaxDaysToRetainDeletedBlobSnapshots = <span style="color: #2b91af">TimeSpan</span>.FromDays(2);

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">We will maintain at most </span><span style="color: gray">&lt;paramref name=&quot;BlobBackupInfo.MaxSnapshots&quot;/&gt; </span><span style="color: green">snapshots. 
    </span><span style="color: gray">/// </span><span style="color: green">This can be configured as required by apps
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">private </span><span style="color: #2b91af">SortedList</span>&lt;<span style="color: #2b91af">DateTime</span>, <span style="color: #2b91af">CloudBlob</span>&gt; snapshotList = <br/>            <span style="color: blue">new </span><span style="color: #2b91af">SortedList</span>&lt;<span style="color: #2b91af">DateTime</span>, <span style="color: #2b91af">CloudBlob</span>&gt;(<span style="color: #2b91af">BlobSnapshotInfo</span>.MaxSnapshots);
    <span style="color: blue">private </span><span style="color: #2b91af">CloudBlob </span>baseBlob;

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Constructor 
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;baseBlob&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">internal </span>BlobSnapshotInfo(<span style="color: #2b91af">CloudBlob </span>baseBlob)
    {
        <span style="color: blue">if </span>(baseBlob == <span style="color: blue">null </span>|| baseBlob.SnapshotTime != <span style="color: blue">null</span>)
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">&quot;baseBlob&quot;</span>);
        }
        <span style="color: blue">this</span>.baseBlob = baseBlob;
    }
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Returns all snapshots in sorted order in ascending order of the snapshot time
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">internal </span><span style="color: #2b91af">IList</span>&lt;<span style="color: #2b91af">CloudBlob</span>&gt; SnapshotList
    {
        <span style="color: blue">get
        </span>{
            <span style="color: blue">return this</span>.snapshotList.Values;
        }
    }
    <span style="color: gray">/// &lt;summary&gt;
    /// 
    /// &lt;/summary&gt;
    /// &lt;param name=&quot;baseBlob&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">internal </span><span style="color: #2b91af">CloudBlob </span>BaseBlob
    {
        <span style="color: blue">get
        </span>{
            <span style="color: blue">return this</span>.baseBlob;
        }
        <span style="color: blue">set
        </span>{
            <span style="color: blue">if </span>(<span style="color: blue">value </span>== <span style="color: blue">null</span>)
            {
                <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">&quot;baseBlob&quot;</span>);
            }
            <span style="color: blue">if </span>(<span style="color: blue">value</span>.SnapshotTime.HasValue)
            {
                <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: blue">string</span>.Format(
                    CultureInfo.InvariantCulture,  <span style="color: #a31515">&quot;Blob '{0}' is a snapshot and not a base blob&quot;</span>, <span style="color: blue">value</span>.Uri.AbsoluteUri));
            }
            <span style="color: blue">if </span>(!<span style="color: #2b91af">Uri</span>.Equals(<span style="color: blue">value</span>.Uri, <span style="color: blue">this</span>.baseBlob.Uri))
            {
                <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: blue">string</span>.Format(
                    CultureInfo.InvariantCulture, <span style="color: #a31515">&quot;Blob '{0}' is not the same as current base blob '{1}'&quot;</span>,
                    <span style="color: blue">value</span>.Uri.AbsoluteUri, <span style="color: blue">this</span>.baseBlob.Uri.AbsoluteUri));
            }

            <span style="color: blue">this</span>.baseBlob = <span style="color: blue">value</span>;
        }
    }
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Create a snapshot only if the blob has been modified since last snapshot.
    </span><span style="color: gray">/// </span><span style="color: green">Maintain at most N snapshots and delete a snapshot if it is older than X days.
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">internal void </span>SnapshotIfRequired()
    {
        <span style="color: blue">if </span>(<span style="color: blue">this</span>.baseBlob == <span style="color: blue">null</span>)
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">&quot;Base blob should be set for creating snapshot.&quot;</span>);
        }
        <span style="color: #2b91af">CloudBlob </span>lastSnapshot = <span style="color: blue">this</span>.snapshotList.LastOrDefault().Value;
        <span style="color: #2b91af">BlobRequestOptions </span>snapshotRequestOption = <span style="color: blue">new </span><span style="color: #2b91af">BlobRequestOptions</span>();

        <span style="color: green">// we will retry 10 times and this would wait sufficiently large period
        </span>snapshotRequestOption.RetryPolicy = <span style="color: #2b91af">RetryPolicies</span>.RetryExponential(10, <span style="color: #2b91af">RetryPolicies</span>.DefaultClientBackoff);

        <span style="color: blue">if </span>(lastSnapshot == <span style="color: blue">null </span>||
            <span style="color: blue">this</span>.baseBlob.Properties.LastModifiedUtc &gt; lastSnapshot.SnapshotTime.Value)
        {
            <span style="color: blue">try
            </span>{
                <span style="color: green">// fetch the metadata on base blob which we will copy over to snapshot
                </span><span style="color: blue">this</span>.baseBlob.FetchAttributes();

                <span style="color: green">// We will add our backup specific metadata to the ones already existing on the blob
                </span>NameValueCollection metadata = <span style="color: blue">new </span>NameValueCollection(<span style="color: blue">this</span>.baseBlob.Attributes.Metadata);
                metadata.Add(<span style="color: #2b91af">BlobSnapshotInfo</span>.IsBackupMetadata, <span style="color: #a31515">&quot;true&quot;</span>);

                <span style="color: green">// Our extension method that allows creating snapshots using the metadata
                </span><span style="color: #2b91af">CloudBlob </span>snapShot = <span style="color: blue">this</span>.baseBlob.CreateSnapshot(metadata, snapshotRequestOption);

                <span style="color: green">// Add the snapshot that removes the odlest snapshot if required
                </span><span style="color: blue">this</span>.AddSnapshotImpl(snapShot);
            }
            <span style="color: blue">catch </span>(<span style="color: #2b91af">Exception </span>e)
            {
                <span style="color: green">// log this error for debugging            
                </span><span style="color: blue">throw</span>;
            }
        }
        <span style="color: green">// We will delete a snapshot if it exceeds N days unless it is the only backup we have. 
        </span><span style="color: blue">while </span>(snapshotList.Count &gt; 1)    
        {
            <span style="color: #2b91af">CloudBlob </span>snapshot = <span style="color: blue">this</span>.snapshotList.First().Value;
            <span style="color: #2b91af">TimeSpan </span>diff = <span style="color: #2b91af">DateTime</span>.UtcNow.Subtract(snapshot.SnapshotTime.Value);
            <span style="color: blue">if </span>(diff &lt; <span style="color: #2b91af">BlobSnapshotInfo</span>.MaxDaysToRetainDeletedBlobSnapshots)
            {
                 <span style="color: blue">break</span>;
            }          
            DeleteOldestSnapshot();
        }
    }
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Add snapshot to the list of snapshots and delete if the max count has been exceeded
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;snapshot&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">internal void </span>AddSnapshot(<span style="color: #2b91af">CloudBlob </span>snapshot)
    {
        <span style="color: blue">if </span>(snapshot == <span style="color: blue">null </span>|| !snapshot.SnapshotTime.HasValue)
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">&quot;snapshot&quot;</span>);
        }
        <span style="color: blue">if </span>(!IsSnapshotOfBaseBlob(<span style="color: blue">this</span>.baseBlob, snapshot))
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: blue">string</span>.Format(
                CultureInfo.InvariantCulture,
                <span style="color: #a31515">&quot;The snapshot '{0}'does not belong to base blob '{1}'.&quot;</span>, snapshot.Uri, <span style="color: blue">this</span>.BaseBlob.Uri));
        }

        AddSnapshotImpl(snapshot);
    }

    <span style="color: blue">private void </span>AddSnapshotImpl(<span style="color: #2b91af">CloudBlob </span>snapshot)
    {
        <span style="color: green">// add the snapshot
        </span><span style="color: blue">this</span>.snapshotList.Add(snapshot.SnapshotTime.Value, snapshot);

        <span style="color: green">// if we have more than required snapshots, remove the first snapshot. We assume that 
        // only a single thread works on a given base blob at a time, so we do not acquire locks.
        </span><span style="color: blue">if </span>(<span style="color: blue">this</span>.snapshotList.Count &gt; <span style="color: #2b91af">BlobSnapshotInfo</span>.MaxSnapshots)
        {
            DeleteOldestSnapshot();
        }
    }
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Delete the oldest snapshot. The oldest snapshot should be the first <br/>    /// in the list as it is sorted by datetime.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;snapshot&quot;&gt;&lt;/param&gt;
    </span><span style="color: blue">private void </span>DeleteOldestSnapshot()
    {
        <span style="color: #2b91af">CloudBlob </span>snapshot = snapshotList.First().Value;       
        <span style="color: blue">try
        </span>{
            <span style="color: green">// we use DeleteIfExists so that a successful retry will not throw an exception. 
            // Also, we will ignore any exception since it will be cleaned up next time
            </span>snapshot.DeleteIfExists();
        }
        <span style="color: blue">catch </span>(<span style="color: #2b91af">Exception </span>e)
        {
            <span style="color: green">// log this error and do nothing since the next backup process will try deleting this again
        </span>}
        <span style="color: green">// remove the snapshot always even if we failed to remove it from the store
        </span>snapshotList.RemoveAt(0);
    }
    <span style="color: blue">private static bool </span>IsSnapshotOfBaseBlob(<span style="color: #2b91af">CloudBlob </span>baseBlob, <span style="color: #2b91af">CloudBlob </span>snapshot)
    {
        <span style="color: green">// the uri segment should match if the snapshot belongs to base blob
        </span><span style="color: blue">return </span><span style="color: #2b91af">Uri</span>.Equals(baseBlob.Uri, snapshot.Uri);
    }
} <br/> </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The Snapshot creation process here is improved to take a collection of metadata to set on the snapshot blob. Since a snapshot blob is read only, this can only be done at the time of creating the snapshot. Since metadata is provided during creation, the service will not copy any existing metadata, it is the responsibility of the caller to retrieve the metadata from base blob and then add any more metadata that is needed on the snapshot. </p>
<pre class="code"> <span style="color: gray">/// &lt;summary&gt;
 /// </span><span style="color: green">Create a snapshot and provide all the metadata during creation 
 </span><span style="color: gray">/// &lt;/summary&gt;
 /// &lt;param name=&quot;blob&quot;&gt;&lt;/param&gt;
 /// &lt;param name=&quot;metadata&quot;&gt;&lt;/param&gt;
 /// &lt;param name=&quot;options&quot;&gt;&lt;/param&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 </span><span style="color: blue">public static </span><span style="color: #2b91af">CloudBlob </span>CreateSnapshot(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, NameValueCollection metadata, <span style="color: #2b91af">BlobRequestOptions </span>options)
 {
     <span style="color: blue">if </span>(blob == <span style="color: blue">null</span>)
     {
         <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">&quot;blob&quot;</span>);
     }

     <span style="color: blue">if </span>(blob.SnapshotTime.HasValue)
     {
         <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">&quot;Cannot snapshot a snapshot blob.&quot;</span>);
     }

     <span style="color: #2b91af">ShouldRetry </span>shouldRetry = options.RetryPolicy();

     <span style="color: blue">int </span>currentRetryCount = -1;
     <span style="color: #2b91af">TimeSpan </span>delay;
     <span style="color: blue">for </span>(; ; )
     {
         currentRetryCount++;

         <span style="color: blue">try
         </span>{
             <span style="color: #2b91af">TimeSpan </span>timeout = options.Timeout.HasValue ? options.Timeout.Value : <span style="color: #2b91af">TimeSpan</span>.FromSeconds(30);
             <span style="color: blue">return </span>blob.CreateSnapshot(metadata, timeout);
         }
         <span style="color: blue">catch </span>(<span style="color: #2b91af">InvalidOperationException </span>e)
         {
             <span style="color: green">// TODO: Log the exception here for debugging

             // Check if we need to retry using the required policy
             </span><span style="color: blue">if </span>(!IsExceptionRetryable(e) || !shouldRetry(currentRetryCount, e, <span style="color: blue">out </span>delay))
             {
                 <span style="color: blue">throw</span>;
             }

             System.Threading.<span style="color: #2b91af">Thread</span>.Sleep(delay);
         }
     }
 }

 <span style="color: blue">private static </span><span style="color: #2b91af">CloudBlob </span>CreateSnapshot(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, NameValueCollection metadata, <span style="color: #2b91af">TimeSpan </span>timeout)
 {
     <span style="color: #2b91af">HttpWebRequest </span>request = BlobRequest.Snapshot(blob.Uri, (<span style="color: blue">int</span>)timeout.TotalSeconds);
     request.Headers[<span style="color: #a31515">&quot;If-Match&quot;</span>] = blob.Attributes.Properties.ETag;
     request.Timeout = (<span style="color: blue">int</span>)timeout.TotalMilliseconds + 2000;
     <span style="color: blue">foreach </span>(<span style="color: blue">string </span>key <span style="color: blue">in </span>metadata.Keys)
     {
        <span style="color: green">// Add all the metadata and prefix it with x-ms-meta
         </span>request.Headers.Add(<span style="color: #a31515">&quot;x-ms-meta-&quot; </span>+ key, metadata[key]);
     }
     
     blob.ServiceClient.Credentials.SignRequest(request);
     
     <span style="color: blue">using</span>(<span style="color: #2b91af">HttpWebResponse </span>response = (<span style="color: #2b91af">HttpWebResponse</span>)request.GetResponse())
     {
         <span style="color: green">// Fetch attributes after the response is received
         </span><span style="color: blue">string </span>time = BlobResponse.GetSnapshotTime(response);
         <span style="color: blue">string </span>snapshotAddress =  <span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;{0}?snapshot={1}&quot;</span>, blob.Uri.AbsoluteUri, time);
         <span style="color: #2b91af">CloudBlob </span>snapshotBlob = blob.Container.GetBlobReference(snapshotAddress);
         snapshotBlob.FetchAttributes();
         <span style="color: blue">return </span>snapshotBlob;
     }
}

 <span style="color: gray">/// &lt;summary&gt;
 /// </span><span style="color: green">Retry on all exceptions except 2xx, 3xx, 4xx
 </span><span style="color: gray">/// </span><span style="color: green">The 2xx is there for Table batch operations in which teh status code can be 202 even when 
 </span><span style="color: gray">/// </span><span style="color: green">the call failed
 </span><span style="color: gray">/// &lt;/summary&gt;
 /// &lt;param name=&quot;currentRetryCount&quot;&gt;&lt;/param&gt;
 /// &lt;param name=&quot;lastException&quot;&gt;&lt;/param&gt;
 /// &lt;param name=&quot;retryInterval&quot;&gt;&lt;/param&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 </span><span style="color: blue">public static bool </span>IsExceptionRetryable(<span style="color: #2b91af">Exception </span>lastException)
 {
     <span style="color: blue">int </span>statusCode = GetStatusCodeFromException(lastException);

     <span style="color: green">// Let us not retry if 2xx, 3xx, 4xx, 501 and 505 errors 
     </span><span style="color: blue">if </span>(statusCode == -1
         || (statusCode &gt;= 200 &amp;&amp; statusCode &lt; 500)
         || statusCode == (<span style="color: blue">int</span>)<span style="color: #2b91af">HttpStatusCode</span>.NotImplemented
         || statusCode == (<span style="color: blue">int</span>)<span style="color: #2b91af">HttpStatusCode</span>.HttpVersionNotSupported)
     {
         <span style="color: blue">return false</span>;
     }

     <span style="color: blue">return true</span>;
 }

 <span style="color: gray">/// &lt;summary&gt;
 /// </span><span style="color: green">Get the status code from exception. This can be sued for Table, Queue and Blob service
 </span><span style="color: gray">/// &lt;/summary&gt;
 /// &lt;param name=&quot;e&quot;&gt;&lt;/param&gt;
 /// &lt;returns&gt;&lt;/returns&gt;
 </span><span style="color: blue">private static int </span>GetStatusCodeFromException(<span style="color: #2b91af">Exception </span>e)
 {
    <span style="color: green">// Handle DataService request and client exceptions for Table service
     </span>DataServiceRequestException dsre = e <span style="color: blue">as </span>DataServiceRequestException;
     <span style="color: blue">if </span>(dsre != <span style="color: blue">null</span>)
     {
         <span style="color: green">// Retrieve the status code:
         //  - if we have an operation response, then it is the status code of that operation response. 
         //     We can only have one response on failure and we can ignore the batch status
         //  - otherwise it is the batch status code 
         </span>OperationResponse opResponse = dsre.Response.FirstOrDefault();
         <span style="color: blue">if </span>(opResponse != <span style="color: blue">null</span>)
         {
             <span style="color: blue">return </span>opResponse.StatusCode;
         }

         <span style="color: blue">return </span>dsre.Response.BatchStatusCode;
     }

     DataServiceClientException dsce = e <span style="color: blue">as </span>DataServiceClientException;
     <span style="color: blue">if </span>(dsce != <span style="color: blue">null</span>)
     {
         <span style="color: blue">return </span>dsce.StatusCode;
     }

     <span style="color: #2b91af">WebException </span>we = e <span style="color: blue">as </span><span style="color: #2b91af">WebException</span>;
     <span style="color: blue">if </span>(we != <span style="color: blue">null</span>)
     {
         <span style="color: #2b91af">HttpWebResponse </span>response = we.Response <span style="color: blue">as </span><span style="color: #2b91af">HttpWebResponse</span>;

         <span style="color: green">// if we do not get a response, we will assume bad gateway. This is not completely true, but since it 
         // is better to retry on such errors, we make up an error code here
         </span><span style="color: blue">return </span>response != <span style="color: blue">null </span>? (<span style="color: blue">int</span>)response.StatusCode : (<span style="color: blue">int</span>)<span style="color: #2b91af">HttpStatusCode</span>.BadGateway;
     }

     <span style="color: green">// let us not retry on any other exceptions
     </span><span style="color: blue">return </span>-1;
 } <br/> </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h5>&#160;</h5>
<h5>Blob Restore</h5>
<p>Now that we have the backup process in place, it is only fair to show how one can utilize these backups for recovery. For brevity, we will skip the container and blob iteration and just show a code example for recovering a blob by restoring it to the latest available snapshot. If a snapshot exists we just use the latest one. One can extend the below code easily to have a date time check. So for example: revert to a latest snapshot that was taken 2010-04-22 or earlier. </p>
<pre class="code"><span style="color: blue">void </span>RevertToLatestSapshot(<span style="color: #2b91af">CloudBlob </span>blob)
{
      <span style="color: #2b91af">IEnumerable</span>&lt;BlobEntry&gt; snapshots = blob.GetSnapshotsForBlob (
<span style="color: #2b91af">RetryPolicies</span>.RetryExponential(5, <span style="color: #2b91af">RetryPolicies</span>.DefaultClientBackoff));
      BlobEntry latestSnapshot = snapshots.LastOrDefault();
      <span style="color: blue">if </span>(latestSnapshot == <span style="color: blue">null</span>)
      {
           <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">&quot;There are no snapshots for the blob.&quot;</span>);
      }
 
       <span style="color: green">// we will backup to latest snapshot irrespective of whether it was created by the backup process
      </span><span style="color: #2b91af">CloudBlob </span>snapshotBlob = blob.Container.GetBlobReference(latestSnapshot.Attributes.Uri.AbsoluteUri);
      blob.CopyFromBlob(snapshotBlob);
 }

 <span style="color: blue">public static </span><span style="color: #2b91af">IEnumerable</span>&lt;BlobEntry&gt; GetSnapshotsForBlob(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob)
 {
        <span style="color: #2b91af">SortedList</span>&lt;<span style="color: #2b91af">DateTime</span>, BlobEntry&gt; snapshots = <span style="color: blue">new </span><span style="color: #2b91af">SortedList</span>&lt;<span style="color: #2b91af">DateTime</span>, BlobEntry&gt;();

        <span style="color: green">// we need the prefix of the blob excluding the container name. We will use this prefix for listing
        // blobs
        </span><span style="color: #2b91af">Uri </span>parentUri = <span style="color: blue">new </span><span style="color: #2b91af">Uri</span>(blob.Container.Uri.AbsoluteUri + <span style="color: #a31515">&quot;/&quot;</span>);
        <span style="color: blue">string </span>prefix = parentUri.MakeRelativeUri(blob.Uri).ToString();
        
        BlobListingContext context = <span style="color: blue">new </span>BlobListingContext(prefix, <span style="color: blue">null</span>, <span style="color: blue">null</span>, <span style="color: #2b91af">BlobListingDetails</span>.Snapshots);

        <span style="color: #2b91af">HttpWebRequest </span>request = BlobRequest.List(blob.Container.Uri, 30, context);
        request.Timeout = (<span style="color: blue">int</span>)<span style="color: #2b91af">TimeSpan</span>.FromSeconds(40).TotalMilliseconds;
        blob.ServiceClient.Credentials.SignRequest(request);

        <span style="color: blue">using </span>(<span style="color: #2b91af">HttpWebResponse </span>response = (<span style="color: #2b91af">HttpWebResponse</span>)request.GetResponse())
        {
            ListBlobsResponse listResponse = BlobResponse.List(response);
            <span style="color: blue">foreach </span>(BlobEntry entry <span style="color: blue">in </span>listResponse.Blobs)
            {
                <span style="color: blue">if </span>(entry.Attributes.Snapshot.HasValue)
                {
                    snapshots.Add(entry.Attributes.Snapshot.Value, entry);
                }
            }
        }

        <span style="color: blue">return </span>snapshots.Values.AsEnumerable();
 } <br/> </pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Some improvements that one can do to the above code are:</p>
<p>1. Process blobs and containers in parallel for faster backups and restore.</p>
<p>2. The above code does not continue after an error. It will be good to store progress information about the blobs/containers, and continue the backup if the role fails and to log any issues that may come up during backup. You may also define an exception and use it to capture more information rather than using InvalidOperation, etc. </p>
<p>3. GetSnapshotsForBlob should handle continuation token and retry on intermittent errors.</p>
<p>
  <br/>Jai Haridas</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/04/29/protecting-your-blobs-against-application-errors/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F04%2F29%2Fprotecting-your-blobs-against-application-errors%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->