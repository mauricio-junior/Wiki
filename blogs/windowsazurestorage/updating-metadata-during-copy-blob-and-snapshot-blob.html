---
layout: windowsazurestorage
title: Updating Metadata during Copy Blob and Snapshot Blob
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-25" class="post-25 post type-post status-publish format-standard hentry category-uncategorized tag-issues-fixed tag-windows-azure-blobs">

	<header class="entry-header single">
		<h1 class="entry-title">Updating Metadata during Copy Blob and Snapshot Blob</h1>		<div class="rating-wrap">
		<div id="star-rating-25" class="wds-ratings" data-rating="5" data-userrating="0" data-postid="25" data-container="body" data-toggle="tooltip" title="1 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2010-05-24T22:27:00+00:00">May 24, 2010</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/&quot;, &quot;text&quot;: &quot;Updating Metadata during Copy Blob and Snapshot Blob&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/&quot;, &quot;text&quot;: &quot;Updating Metadata during Copy Blob and Snapshot Blob&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p class="MsoNormal" style="margin: 0in 0in 0pt;"><span style="font-family: 'Calibri','sans-serif'; font-size: 14pt; mso-ascii-theme-font: minor-latin; mso-hansi-theme-font: minor-latin; mso-bidi-theme-font: minor-latin;"><strong><em>This issue has been resolved for copy blob operations in the Windows Azure SDK&nbsp; 1.3 release which can be downloaded </em></strong><a href="http://msdn.microsoft.com/en-us/windowsazure/cc974146.aspx"><strong><em>here</em></strong></a><strong><em>. The snapshot issue will be resolved in a future release.<o:p></o:p></em></strong></span></p>
<p>When you <a href="http://msdn.microsoft.com/en-us/library/dd894037.aspx">copy</a> or <a href="http://msdn.microsoft.com/en-us/library/ee691971.aspx">snapshot</a> a blob in the Windows Azure Blob Service, you can specify the metadata to be stored on the snapshot or the destination blob. If no metadata is provided in the request, the server will copy the metadata from the source blob (the blob to copy from or to snapshot). However, if metadata is provided, the service will not copy the metadata from the source blob and just store the new metadata provided. Additionally, you cannot change the metadata of a snapshot after it has been created.</p>
<p>The current Storage Client Library in the Windows Azure SDK allows you to specify the metadata to send for CopyBlob, but there is an issue that causes the updated metadata not actually to be sent to the server. This can cause the application to incorrectly believe that it has updated the metadata on CopyBlob when it actually hasn&rsquo;t been updated. </p>
<p>Until this is fixed in a future version of the SDK, you will need to use your own extension method if you want to update the metadata during CopyBlob. The extension method will take in metadata to send to the server. Then if the application wants to add more metadata to the existing metadata of the blob being copied, the application would then first fetch metadata on the source blob and then send all the metadata including the new ones to the extension CopyBlob operation. </p>
<p>In addition, the SnapshotBlob operation in the SDK does not allow sending metadata. For SnapshotBlob, we gave an extension method that does this in our post on <a href="http://blogs.msdn.com/windowsazurestorage/archive/2010/04/30/protecting-your-blobs-against-application-errors.aspx">protecting blobs from application errors</a>. This can be easily extended for &ldquo;CopyBlob&rdquo; too and we have the code at the end of this post, which can be copied into the same extension class.</p>
<p>We now explain the issue with CopyBlob using some code examples. If you want to update the metadata of the destination of the CopyBlob, you would want to set the metadata on the destination blob instance before invoking CopyBlob, as shown below. In the current SDK when doing this, the metadata is not sent to the server. This results in the server copying all the metadata from the source to destination. But on the client end, the destination instance continues to have the new metadata set by the application. The following code shows the problem:</p>
<pre class="code"><span style="color: #2b91af">CloudBlob </span>destinationBlob = cloudContainer.GetBlobReference(<span style="color: #a31515">"mydocs/PDC09_draft2.ppt"</span>);
           
<span style="color: green">// set metadata &ldquo;version&rdquo; on destinationBlob so that once copied, the destinationBlob instance 
// should only have &ldquo;version&rdquo; as the metadata
</span>destinationBlob.Attributes.Metadata.Add(<span style="color: #a31515">"version"</span>, <span style="color: #a31515">"draft2"</span>);

<span style="color: green">// BUG: CopyBlob does not send &ldquo;version&rdquo; in the REST protocol so server goes ahead and copies 
// any metadata present in the sourceBlob
</span>destinationBlob.CopyFromBlob(sourceBlob);</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Solution: The solution is to use the CopyBlob extension method at the end of this post as follows:</p>
<pre class="code"><p><span style="color: #2b91af">CloudBlob </span>destinationBlob = cloudContainer.GetBlobReference(<span style="color: #a31515">"mydocs/PDC09_draft2.ppt"</span>);
       
<span style="color: green">// Get the metadata from source blob if you want to copy them too to the destination blob and add 
// the new version metadata
</span>NameValueCollection metadata = <span style="color: blue">new </span>NameValueCollection();
            metadata.Add(sourceBlob.Metadata);
            metadata.Add(<span style="color: #a31515">"version"</span>, <span style="color: #a31515">"draft2"</span>);

<span style="color: #2b91af">BlobRequestOptions </span>options = <span style="color: blue">new </span><span style="color: #2b91af">BlobRequestOptions</span>()
    {
        Timeout = <span style="color: #2b91af">TimeSpan</span>.FromSeconds(45),
        RetryPolicy = <span style="color: #2b91af">RetryPolicies</span>.RetryExponential(
        <span style="color: #2b91af">RetryPolicies</span>.DefaultClientRetryCount, <span style="color: #2b91af">RetryPolicies</span>.DefaultClientBackoff)
    };

<span style="color: green">// Send the metadata too with the copy operation
</span>destinationBlob.CopyBlob(
    sourceBlob, 
    metadata, 
    Microsoft.WindowsAzure.StorageClient.Protocol.<span style="color: #2b91af">ConditionHeaderKind</span>.None, 
    <span style="color: blue">null </span><span style="color: green">/*sourceConditionValues*/</span>, 
    <span style="color: blue">null </span><span style="color: green">/*leaseId*/</span>, 
    options);</p></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Another issue to be aware of is that if a CopyFromBlob operation results in the metadata being copied from source to destination, an application developer may expect the destination blob instance to have the metadata set. However, since the copy operation does not return the metadata, the operation does not set the metadata on the destination blob instance in your application. The application will therefore need to call FetchAttributes explicitly to retrieve the metadata from the server as shown in the following:</p>
<p>// Let us assume sourceBlob already has metadata &ldquo;author&rdquo; set and we are just copying the blob</p>
<pre class="code"><span style="color: green">// Let us assume sourceBlob already has metadata &ldquo;author&rdquo; set and we are just copying the blob
</span><span style="color: #2b91af">CloudBlob </span>destinationBlob = cloudContainer.GetBlobReference(<span style="color: #a31515">"mydocs/PDC09_draft3.ppt"</span>);
      
destinationBlob.CopyFromBlob(sourceBlob);

<span style="color: green">// before FetchAttributes is called, destinationBlob instance has no metadata even though the 
// server has copied metadata from the source blob.
</span>destinationBlob.FetchAttributes();
<span style="color: green">// Now destinationBlob instance has the metadata &ldquo;author&rdquo; available.
</span></pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>&nbsp;</p>
<p>Jai Haridas</p>
<p>&nbsp;</p>
<p>Here is the code for Copy Blob extension method.</p>
<pre class="code"><span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">Copy blob with new metadata 
</span><span style="color: gray">/// &lt;/summary&gt;
</span><span style="color: blue">public static </span><span style="color: #2b91af">CloudBlob </span>CopyBlob(
    <span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>destinationBlob, 
    <span style="color: #2b91af">CloudBlob </span>sourceBlob, 
    NameValueCollection destinationBlobMetadata, 
    ConditionHeaderKind sourceConditions,
    <span style="color: blue">string </span>sourceConditionValues,
    <span style="color: blue">string </span>leaseId,
    <span style="color: #2b91af">BlobRequestOptions </span>options)
{
    <span style="color: blue">if </span>(sourceBlob == <span style="color: blue">null</span>)
    {
        <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"sourceBlob"</span>);
    }

    <span style="color: blue">if </span>(destinationBlob == <span style="color: blue">null</span>)
    {
        <span style="color: blue">throw new </span><span style="color: #2b91af">ArgumentNullException</span>(<span style="color: #a31515">"destinationBlob"</span>);
    }

    <span style="color: #2b91af">ShouldRetry </span>shouldRetry = options.RetryPolicy == <span style="color: blue">null </span>? 
        <span style="color: #2b91af">RetryPolicies</span>.RetryExponential(<span style="color: #2b91af">RetryPolicies</span>.DefaultClientRetryCount, 
        <span style="color: #2b91af">RetryPolicies</span>.DefaultClientBackoff)() : options.RetryPolicy();

    <span style="color: blue">int </span>currentRetryCount = -1;
           <span style="color: blue">for </span>(; ; )
    {
        currentRetryCount++;

        <span style="color: blue">try
        </span>{
            <span style="color: #2b91af">TimeSpan </span>timeout = options.Timeout.HasValue ? options.Timeout.Value : <span style="color: #2b91af">TimeSpan</span>.FromSeconds(30);
            <span style="color: blue">return </span>BlobExtensions.CopyBlob(
                        destinationBlob, 
                        sourceBlob, 
                        destinationBlobMetadata, 
                        timeout, 
                        sourceConditions, 
                        sourceConditionValues, 
                        leaseId);
        }
        <span style="color: blue">catch </span>(<span style="color: #2b91af">InvalidOperationException </span>e)
        {
            <span style="color: green">// TODO: Log the exception here for debugging

            // Check if we need to retry using the required policy
            </span><span style="color: #2b91af">TimeSpan </span>delay;
            <span style="color: blue">if </span>(!IsExceptionRetryable(e) || !shouldRetry(currentRetryCount, e, <span style="color: blue">out </span>delay))
            {
                <span style="color: blue">throw</span>;
            }

            System.Threading.<span style="color: #2b91af">Thread</span>.Sleep((<span style="color: blue">int</span>)delay.TotalMilliseconds);
        }
    }
}

<span style="color: blue">private static </span><span style="color: #2b91af">CloudBlob </span>CopyBlob(
    <span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>destinationBlob, 
    <span style="color: #2b91af">CloudBlob </span>sourceBlob, 
    NameValueCollection destinationBlobMetadata, 
    <span style="color: #2b91af">TimeSpan </span>timeout, 
    ConditionHeaderKind sourceConditions,
    <span style="color: blue">string </span>sourceConditionValues,
    <span style="color: blue">string </span>leaseId)
{
    StringBuilder canonicalName = <span style="color: blue">new </span>StringBuilder();
    canonicalName.AppendFormat(
        CultureInfo.InvariantCulture,
        <span style="color: #a31515">"/{0}{1}"</span>,
        sourceBlob.ServiceClient.Credentials.AccountName,
        sourceBlob.Uri.AbsolutePath);

    <span style="color: blue">if </span>(sourceBlob.SnapshotTime.HasValue)
    {
        canonicalName.AppendFormat(<span style="color: #a31515">"?snapshot={0}"</span>, sourceBlob.SnapshotTime.Value.ToString(
                <span style="color: #a31515">"yyyy'-'MM'-'dd'T'HH':'mm':'ss'.'fffffff'Z'"</span>, CultureInfo.InvariantCulture));
    }

    <span style="color: #2b91af">HttpWebRequest </span>request = BlobRequest.CopyFrom(
        destinationBlob.Uri, 
        (<span style="color: blue">int</span>)timeout.TotalSeconds, 
        canonicalName.ToString(),
        <span style="color: blue">null </span>,
        sourceConditions, 
        sourceConditionValues, 
        leaseId);
    
    <span style="color: green">// Adding 2 seconds to have the timeouton webrequest slightly more than the timeout we set for the server to 
    // complete the operation
    </span>request.Timeout = (<span style="color: blue">int</span>)timeout.TotalMilliseconds + 2000;
    
    <span style="color: blue">if </span>(destinationBlobMetadata != <span style="color: blue">null</span>)
    {
        <span style="color: blue">foreach </span>(<span style="color: blue">string </span>key <span style="color: blue">in </span>destinationBlobMetadata.Keys)
        {
            request.Headers.Add(<span style="color: #a31515">"x-ms-meta-" </span>+ key, destinationBlobMetadata[key]);
        }
    }
    
    destinationBlob.ServiceClient.Credentials.SignRequest(request);

    <span style="color: blue">using </span>(<span style="color: #2b91af">HttpWebResponse </span>response = (<span style="color: #2b91af">HttpWebResponse</span>)request.GetResponse())
    {
        destinationBlob.FetchAttributes();
        <span style="color: blue">return </span>destinationBlob;
    }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-fixed/" rel="tag">Issues - Fixed</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/24/updating-metadata-during-copy-blob-and-snapshot-blob/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F05%2F24%2Fupdating-metadata-during-copy-blob-and-snapshot-blob%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->