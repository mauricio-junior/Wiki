---
layout: windowsazurestorage
title: Windows Azure Drives with Full IIS in SDK 1.3
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-50" class="post-50 post type-post status-publish format-standard hentry category-uncategorized tag-issues-known tag-windows-azure-drives">

	<header class="entry-header single">
		<h1 class="entry-title">Windows Azure Drives with Full IIS in SDK 1.3</h1>		<div class="rating-wrap">
		<div id="star-rating-50" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="50" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2011-02-15T21:21:00+00:00">February 15, 2011</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#comments">5</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/&quot;, &quot;text&quot;: &quot;Windows Azure Drives with Full IIS in SDK 1.3&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/&quot;, &quot;text&quot;: &quot;Windows Azure Drives with Full IIS in SDK 1.3&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>With the Windows Azure SDK 1.3 it is now possible to run web roles with Full IIS. If you are unfamiliar with Full IIS you might want to look at this <a href="http://blogs.msdn.com/b/windowsazure/archive/2010/12/02/new-full-iis-capabilities-differences-from-hosted-web-core.aspx">blog</a> which captures the differences between Full IIS and Hosted Web Core (HWC) the only option available with prior SDKs. Additionally you may find this <a href="http://blogs.msdn.com/b/windowsazure/archive/2010/12/08/how-to-resolve-setconfigurationsettingpublisher-needs-to-be-called-before-fromconfigurationsetting-can-be-used-after-moving-to-windows-azure-sdk-1-3.aspx">blog</a>, which drills into the impact on the storage configuration setting publisher useful too. The content from those blogs provides context for the rest of this article.</p>
<p>In this post we&rsquo;ll discuss coding patterns for Windows Azure Drive APIs recommended for use with full IIS. All of these guidelines should work for Hosted Web Core as well. In this context we&rsquo;ll also discuss one known issue with .Net 4.0. In addition we call out issues that have surfaced with SDK 1.3 and workarounds for them. </p>
<h4>Perform Drive Initialization in the Global.asax file</h4>
<p>In Full IIS, the OnStart() method in the web role and Page_Load() run in different processes. Consequently a drive letter saved to a global variable in the OnStart method is unavailable to the Page_Load() method. To address this, we recommend that applications perform all drive initialization actions including setting up the cache, creating and mounting the drives in the <a href="http://msdn.microsoft.com/en-us/library/ms178473.aspx">Application_Start()</a> method of the <a href="http://msdn.microsoft.com/en-us/library/1xaas8a2(v=vs.71).aspx">Global.asax</a> file. This approach is also suitable for Hosted Web Core.</p>
<p><b>Caveats for .Net 4.0</b></p>
<p>With .Net 4.0 there is a known <a href="https://connect.microsoft.com/VisualStudio/feedback/details/578670/httputility-htmlencode-fails-in-application-start-with-response-is-not-available-in-this-context">issue</a> that will cause all Storage Client API calls for Blobs, Tables and Queues to fail if they are invoked in Application_Start(). The exception surfaced in this case is <i>HttpException (0x80004005): Response is not available in this context&rdquo; from Global.ApplicationStart</i>&rdquo; <i>on .NET 4.0.</i></p>
<p>This issue will be addressed in an upcoming service pack for .Net 4.0. Until then one way to mitigate this issue, is to move all Windows Azure Blob, Table and Queue API calls to some other location like the OnStart() method or to another method in the Global.asax file depending on when the calls need to be executed. It should be noted that the OnStart() method will always execute <b>before</b> Application_Start().</p>
<p>You might also choose to stay with IIS Hosted Web Core until the issue is addressed in the next .Net 4.0 service pack. You can disable Full IIS in an existing project by commenting out the <i>Sites </i>element in the <i>ServiceDefinition.csdef.</i></p>
<h4>In the Storage Emulator with Full IIS, Drives are not visible across user contexts</h4>
<p>In the development environment, a drive that is mounted in one user context is not visible in another user context, and the OnStart() and Application_Start methods do not run in the same user contexts. For example if a drive is mounted in the OnStart method and the drive letter passed to the IIS process through some IPC means, the simulated drive will be unavailable in the IIS process when running in the development environment. </p>
<p>When running in the cloud, drives mounted are visible across the entire role instance. Note that with IIS HWC, Page_Load and OnStart are always in the same process and consequently this is not an issue.</p>
<h4>Storage Emulator workarounds for Full IIS &amp; SDK 1.3</h4>
<p><span style="font-size: medium;"><strong><em><span style="font-size: small;">Update 3/09/011:&nbsp; The below 3 storage emulator issues have been&nbsp;fixed in the </span></em></strong></span><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=7a1089b6-4050-4307-86c4-9dadaa5ed018"><span style="font-size: medium;"><strong><em><span style="font-size: small;">Windows Azure SDK 1.4 release March 2011</span></em></strong></span></a><span style="font-size: medium;"><strong><em><span style="font-size: small;">. </span></em></strong></span></p>
<p><span style="font-size: medium;"><strong><em><span style="font-size: small;"><span style="font-family: Verdana;"><o:p></o:p></span></span></em></strong></span>These are a few issues that have surfaced with SDK 1.3 and full IIS that we&rsquo;ll cover in this section. It should be noted that none of these issues occur with IIS Hosted Web Core. </p>
<ol>
<li>When running in the Windows Azure Emulator, ERROR_UNSUPPORTED_OS is returned from CloudDrive.InitializeCache() when called from Application_Start().
<p>To work around this issue, set the environment variable <i>AZURE_DRIVE_DEV_PATH</i> to a suitable directory on your system. This directory is used by the Azure Storage Emulator to store Windows Azure Drives. </p>
<p>To do this, right click on &ldquo;My Computer&rdquo;, choose Properties, then Advanced System Settings, then Environment Variables, click &ldquo;New&hellip;&rdquo; under &ldquo;System Variables&rdquo;, name the variable AZURE_DRIVE_DEV_PATH, and set the value to a directory on your machine (e.g. &ldquo;C:\AzureDriveDevPath&rdquo;). You should create this path yourself so that any process you create can access it. To propagate this variable to the appropriate processes, you need to reboot your machine. </li>
<li>When running with Full IIS on the Windows Azure Emulator on x86 (not x64), the following error is surfaced &ldquo;Could not load file or assembly &lsquo;mswacdmi.dll&rsquo; or one of its dependencies.&rdquo;
<p>The workaround is to add the path <i>C:\Program Files\Windows Azure SDK\v1.3\bin\runtimes\storage\simulation\x86</i> to your system path environment variable. After adding this path, reboot your <a name="_GoBack"></a>machine. </li>
<li>When running with Full IIS on the Windows Azure Emulator and calling CloudDrive.Snapshot(), the following error is surfaced &lsquo;Unknown Error HRESULT=800040005&rsquo;.
<p>This issue crops up because the Storage Emulator uses &lsquo;backup&rsquo; semantics to make snapshots, but Full IIS runs as the &lsquo;NETWORK_SERVICE&rsquo; user which does not have &lsquo;backup&rsquo; rights. </p>
<p>To work around this problem, you can add &lsquo;NETWORK_SERVICE&rsquo; to your &lsquo;Backup Operators&rsquo; group. To do so, right click on &ldquo;Computer&rdquo; or &ldquo;My Computer&rdquo; and choose &ldquo;Manage&rdquo;. Go to &ldquo;Local Users and Groups&rdquo;, click on &ldquo;Groups&rdquo; and then double click on &ldquo;Backup Operators&rdquo;. Push &ldquo;Add&rdquo;, then &ldquo;Locations&rdquo; and select your computer at the top, and push &ldquo;ok&rdquo;. Now type &lsquo;NETWORK SERVICE&rsquo; without the quotes into the box, and push &ldquo;Ok&rdquo;. Finally, push &ldquo;Ok&rdquo; again. You should remove &lsquo;NETWORK SERVICE&rsquo; from &lsquo;Backup Operators&rsquo; when you no longer need this workaround.</li>
</ol>
<p>Dinesh Haridas</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-known/" rel="tag">Issues - Known</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-drives/" rel="tag">Windows Azure Drives</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (5)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F15%2Fwindows-azure-drives-with-full-iis-in-sdk-1-3%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-63">
				<div id="div-comment-63" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Marc Kuperstein</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#comment-63">
			February 16, 2011 at 6:02 pm</a>		</div>

		<p>Dinesh, appreciate the update &#8211; however, when I switch to IIS in dev fabric I am failing to create a XDrive with an exception of 0x80070003</p>
<p>Works with HWC in dev fabric and I followed 1 &amp; 3 on your list.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F15%2Fwindows-azure-drives-with-full-iis-in-sdk-1-3%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-64">
				<div id="div-comment-64" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Dinesh</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#comment-64">
			February 17, 2011 at 10:04 pm</a>		</div>

		<p>Marc, can you verify that the environment variable AZURE_DRIVE_DEV_PATH points to a valid drive on your system. </p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F15%2Fwindows-azure-drives-with-full-iis-in-sdk-1-3%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-170">
				<div id="div-comment-170" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/ee9c00f7a3ee6335f52a9b086414979c?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/ee9c00f7a3ee6335f52a9b086414979c?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">using.import.include@hotmail.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#comment-170">
			September 4, 2012 at 3:25 am</a>		</div>

		<p>i have fixed HttpException (0x80004005) issue using <a rel="nofollow" target="_new" href="http://support.microsoft.com/kb/2468871">support.microsoft.com/&#8230;/2468871</a> fix&#8230;</p>
<p>But now i am getting &nbsp;&quot;Unable to connect to the remote server &#8211; &nbsp;A socket operation was attempted to an unreachable network 168.63.*.*:443&quot; instead of &nbsp;&quot;HttpRequst is not availble in this context&quot; error&#8230; (But i can connect to the Destination Host in WorkerRole)</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F15%2Fwindows-azure-drives-with-full-iis-in-sdk-1-3%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-171">
				<div id="div-comment-171" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">jaidevh1@hotmail.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#comment-171">
			September 8, 2012 at 6:23 pm</a>		</div>

		<p>@Bin Hex, can you share some context here as to when you see this error? Is this when you try to establish connection with IIS service running on VM with Azure Drive? Or is this outbound connections?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F15%2Fwindows-azure-drives-with-full-iis-in-sdk-1-3%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-172">
				<div id="div-comment-172" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Bin Hex</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/15/windows-azure-drives-with-full-iis-in-sdk-1-3/#comment-172">
			September 18, 2012 at 4:11 am</a>		</div>

		<p>Jai, The 2468871 fix solved the issue, Though outbound connection to that IP was not working due to our Network Proxy&#8230; I have resolved it by unblocking access to that IP address&#8230;</p>
<p>But i couldn&#39;t get one part&#8230; Before fixing our network proxy, i can connect to the *.core.windows.net in my Worker Role but i couldn&#39;t connect the same in my WebRole&#8230;Blindly unblocking the port fixed my problem&#8230;</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F15%2Fwindows-azure-drives-with-full-iis-in-sdk-1-3%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->