---
layout: windowsazurestorage
title: Windows Azure Storage Client Library&#58; Rewinding stream position less than BlobStream.ReadAheadSize can result in lost bytes from BlobStream.Read()
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-53" class="post-53 post type-post status-publish format-standard hentry category-uncategorized tag-issues-fixed tag-windows-azure-blobs tag-windows-azure-storage-client-library">

	<header class="entry-header single">
		<h1 class="entry-title">Windows Azure Storage Client Library: Rewinding stream position less than BlobStream.ReadAheadSize can result in lost bytes from BlobStream.Read()</h1>		<div class="rating-wrap">
		<div id="star-rating-53" class="wds-ratings" data-rating="4" data-userrating="0" data-postid="53" data-container="body" data-toggle="tooltip" title="1 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2011-02-27T10:34:00+00:00">February 27, 2011</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/&quot;, &quot;text&quot;: &quot;Windows Azure Storage Client Library: Rewinding stream position less than BlobStream.ReadAheadSize can result in lost bytes from BlobStream.Read()&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/&quot;, &quot;text&quot;: &quot;Windows Azure Storage Client Library: Rewinding stream position less than BlobStream.ReadAheadSize can result in lost bytes from BlobStream.Read()&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p class="MsoNormal"><span style="font-family: 'Verdana','sans-serif'; color: #333333; font-size: 9pt; mso-ansi-language: EN;" lang="EN"><strong><em><br/><span style="font-size: medium;">Update 3/09/011:&nbsp; The bug is fixed in the </span></em></strong><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=7a1089b6-4050-4307-86c4-9dadaa5ed018"><strong><em><span style="font-size: medium;">Windows Azure SDK March 2011 release</span></em></strong></a><strong><em><span style="font-size: medium;">. <o:p></o:p></span></em></strong></span></p>
<p>In the current Windows Azure storage client library, BlobStream.Read() may read less than the requested number of bytes if the user rewinds the stream position. This occurs when using the seek operation to a position which is equal or less than BlobStream.ReadAheadSize byte(s) away from the previous start position. Furthermore, in this case, if BlobStream.Read() is called again to read the remaining bytes, data from an incorrect position will be read into the buffer.</p>
<h4>What does ReadAheadSize property do?</h4>
<p>BlobStream.ReadAheadSize is used to define how many extra bytes to prefetch in a get blob request when BlobStream.Read() is called. This design is suppose to ensure that the storage client library does not need to send another request to the blob service if BlobStream.Read() is called again to read N bytes from the current position, where N &lt; BlobStream.ReadAheadSize. It is an optimization for reading blobs in the forward direction, which reduces the number of the get blob requests to the blob service when reading a Blob.</p>
<p>This bug impacts users only if their scenario involves rewinding the stream to read, i.e. using Seek operation to seek to a position BlobStream.ReadAheadSize bytes less than the previous byte offset.</p>
<p>The root cause of this issue is that the number of bytes to read is incorrectly calculated in the storage client library when the stream position is rewound by N bytes using Seek, where N &lt;=BlobStream.ReadAheadSize bytes away from the previous read&rsquo;s start offset. (Note, if the stream is rewound more than BlobStream.ReadAheadSize bytes away from the previous start offset, the stream reads work as expected.)</p>
<p>To understand this issue better, let us explain this using an example of user code that exhibits this bug.</p>
<p>We begin with getting a BlobStream that we can use to read the blob, which is 16MB in size. We set the ReadAheadSize to 16 bytes. We then seek to offset 100 and read 16 bytes of data. :</p>
<pre class="code">BlobStream stream = blob.OpenRead();
stream.ReadAheadSize = 16;
<span style="color: blue;">int </span>bufferSize = 16;
<span style="color: blue;">int </span>readCount;
<span style="color: blue;">byte</span>[] buffer1 = <span style="color: blue;">new byte</span>[bufferSize];
stream.Seek(100, System.IO.SeekOrigin.Begin);
readCount = stream.Read(buffer1, 0, bufferSize);</pre>
</p>
<p>BlobStream.Read() works as expected in which buffer1 is filled with 16 bytes of the blob data from offset 100. Because of ReadAheadSize set to 16, the Storage Client issues a read request for 32 bytes of data as seen in the request trace as seen in the &ldquo;x-ms-range&rdquo; header set to 100-131 in the request trace. The response as we see in the content-length, returns the 32 bytes:</p>
<p>Request and response trace:</p>
<p><b>Request header: <br/></b>GET http://foo.blob.core.windows.net/test/blob?timeout=90 HTTP/1.1 <br/>x-ms-version: 2009-09-19 <br/>User-Agent: WA-Storage/0.0.0.0 <br/><span style="background-color: #ffff00;">x-ms-range: bytes=100-131 <br/></span>&hellip;</p>
<p><b>Response header: <br/></b>HTTP/1.1 206 Partial Content <br/><span style="background-color: #00ffff;">Content-Length: 32 <br/></span>Content-Range: bytes 100-131/16777216 <br/>Content-Type: application/octet-stream <br/>&hellip;</p>
<p>We will now rewind the stream to 10 bytes away from the previous read&rsquo;s start offset (previous start offset was at 100 and so the new offset is 90). It is worth noting that 10 is &lt; ReadAheadSize which exhibits the problem (note, if we had set the seek to be &gt; ReadAheadSize back from 100, then everything would work as expected). We then issue a Read for 16 bytes starting from offset 90.</p>
<pre class="code"><span style="color: blue;">byte</span>[] buffer2 = <span style="color: blue;">new byte</span>[bufferSize];
stream.Seek(90, System.IO.SeekOrigin.Begin);
readCount = stream.Read(buffer2, 0, bufferSize);</pre>
</p>
<p>BlobStream.Read() does not work as expected here. It is called to read 16 bytes of the blob data from offset 90 into buffer2, but only 9 bytes of blob data is downloaded because the Storage Client has a bug in calculating the size it needs to read as seen in the trace below. We see that x-ms-range is set to 9 bytes (range = 90-98 rather than 90-105) and the content-length in the response set to 9.</p>
<p>Request and response trace:</p>
<p><b>Request header: <br/></b>GET http://foo.blob.core.windows.net/test/blob?timeout=90 HTTP/1.1 <br/>x-ms-version: 2009-09-19 <br/>User-Agent: WA-Storage/0.0.0.0 <br/><span style="background-color: #ffff00;">x-ms-range: bytes=90-98 <br/></span>&hellip;</p>
<p><b>Response header: <br/></b>HTTP/1.1 206 Partial Content <br/><span style="background-color: #00ffff;">Content-Length: 9 <br/></span>Content-Range: bytes 90-98/16777216 <br/>Content-Type: application/octet-stream <br/>&hellip;</p>
<p>Now, since the previous request for reading 16 bytes just returned 9 bytes, the client will issue another Read request to continue reading the remaining 7 bytes,</p>
<pre class="code">readCount = stream.Read(buffer2, readCount, bufferSize &ndash; readCount);</pre>
</p>
<p>BlobStream.Read() still does not work as expected. It is called to read the remaining 7 bytes into buffer2 but the whole blob is downloaded as seen in the request and response trace below. As seen in the request, due to bug in Storage client, an incorrect range is sent to the service which then returns the entire blob data resulting in an incorrect data being read into the buffer. The request trace shows that the range is invalid: 99-98. The invalid range causes the Windows Azure Blob service to return the entire content as seen in the response trace. Since the client does not check to see the range and it was expecting the starting offset to be 99, it copies the 7 bytes from the beginning of the stream which is incorrect.</p>
<p>Request and response trace:</p>
<p><b>Request header: <br/></b>GET http://foo.blob.core.windows.net/test/blob?timeout=90 HTTP/1.1x-ms-version: 2009-09-19 <br/>User-Agent: WA-Storage/0.0.0.0 <br/><span style="background-color: #ffff00;">x-ms-range: bytes=<span style="background-color: #ff9900;"><span style="background-color: #ffff00;">99-98</span> <br/></span></span>&hellip;</p>
<p><b>Response header: <br/></b>HTTP/1.1 200 OK <br/><span style="background-color: #00ffff;">Content-Length: 16777216 <br/></span>Content-Type: application/octet-stream <br/>&hellip;</p>
<h4>Mitigation</h4>
<p>The workaround is to set the value of BlobStream.ReadAheadSize to 0 before BlobStream.Read() is called if a rewind operation is required:</p>
<pre class="code">BlobStream stream = blob.OpenRead();
stream.ReadAheadSize = 0;</pre>
</p>
<p>As we explained above, the property BlobStream.ReadAheadSize is an optimization which can reduce the number of the requests to send when reading blobs in the forward direction, and setting it to 0 removes that benefit.</p>
<h4>Summary</h4>
<p>To summarize, the bug in the client library can result in data from an incorrect offset to be read. This happens only when the user code seeks to a position less than the previous offset where the distance is &lt; ReadAheadSize. The bug will be fixed a future release of the Windows Azure SDK and we will post a link to the download here once it is released<a name="_GoBack"></a>.</p>
<p>Justin Yu</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-fixed/" rel="tag">Issues - Fixed</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-storage-client-library/" rel="tag">Windows Azure Storage Client Library</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/02/27/windows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F02%2F27%2Fwindows-azure-storage-client-library-rewinding-stream-position-less-than-blobstream-readaheadsize-can-result-in-lost-bytes-from-blobstream-read%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->