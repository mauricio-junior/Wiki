---
layout: windowsazurestorage
title: Exploring Windows Azure Drives, Disks, and Images
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-104" class="post-104 post type-post status-publish format-standard hentry category-uncategorized">

	<header class="entry-header single">
		<h1 class="entry-title">Exploring Windows Azure Drives, Disks, and Images</h1>		<div class="rating-wrap">
		<div id="star-rating-104" class="wds-ratings" data-rating="5" data-userrating="0" data-postid="104" data-container="body" data-toggle="tooltip" title="3 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 5 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2012-06-27T23:14:00+00:00">June 27, 2012</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/#comments">3</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/&quot;, &quot;text&quot;: &quot;Exploring Windows Azure Drives, Disks, and Images&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/&quot;, &quot;text&quot;: &quot;Exploring Windows Azure Drives, Disks, and Images&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>With the preview of <a href="https://www.windowsazure.com/en-us/home/scenarios/virtual-machines/">Windows Azure Virtual Machines</a>, we have two new special types of blobs stored in Windows Azure Storage: Windows Azure Virtual Machine Disks and Window Azure Virtual Machine Images. And of course we also have the existing preview of <a href="http://blogs.msdn.com/b/windowsazure/archive/2010/02/02/beta-release-of-windows-azure-drive.aspx">Windows Azure Drives</a>. In the rest of this post, we will refer to these as storage, disks, images, and drives. This post explores what drives, disks, and images are and how they interact with storage.</p>
<h4>Virtual Hard Drives (VHDs)</h4>
<p>Drives, disks, and images are all <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd323654(v=vs.85).aspx"><b>VHDs</b></a> stored as page blobs within your storage account. There are actually several slightly different <a href="http://go.microsoft.com/fwlink/?LinkId=137171"><b>VHD formats</b></a>: fixed, dynamic, and differencing. Currently, Windows Azure only supports the format named &lsquo;fixed&rsquo;. This format lays the logical disk out linearly within the file format, such that disk offset X is stored at blob offset X. At the end of the blob, there is a small footer that describes the properties of the VHD. All of this stored in the page blob adheres to the standard VHD format, so you can take this VHD and mount it on your server on-premises if you choose to. Often, the fixed format wastes space because most disks have large unused ranges in them. However, we store our &lsquo;fixed&rsquo; VHDs as a <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/04/11/using-windows-azure-page-blobs-and-how-to-efficiently-upload-and-download-page-blobs.aspx">page blob</a>, which is a sparse format, so we get the benefits of both the &lsquo;fixed&rsquo; and &lsquo;expandable&rsquo; disks at the same time.</p>
<h4>Uploading VHDs to Windows Azure Storage</h4>
<p>You can upload your VHD into your storage account to use it for either PaaS or IaaS. When you are uploading your VHD into storage, you will want to use a tool that understands that page blobs are sparse, and only uploads the portions of the VHD that have actual data in them. Also, if you have dynamic VHDs, you want to use a tool that will convert your dynamic VHD into a fixed VHD as it is doing the upload. <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg466228.aspx">CSUpload</a> will do both of these things for you, and it is included as part of the <a href="http://www.windowsazure.com/en-us/develop/downloads/">Windows Azure SDK</a>.</p>
<h4>Persistence and Durability</h4>
<p>Since drives, disks, and images are all stored in storage, your data will be persisted even when your virtual machine has to be moved to another physical machine. This means your data gets to take advantage of the <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2011/11/20/windows-azure-storage-a-highly-available-cloud-storage-service-with-strong-consistency.aspx">durability offered by the Windows Azure Storage architecture</a>, where all of your non-buffered and flushed writes to the disk/drive are replicated 3 times in storage to make it durable before returning success back to your application.</p>
<h4>Drives (PaaS)</h4>
<p>Drives are used by the PaaS roles (<a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg432976">Worker Role, Web Role</a>, and <a href="http://msdn.microsoft.com/en-us/library/windowsazure/gg433107">VM Role</a>) to mount a VHD and assign a drive letter. There are many details about how you use these drives <a href="http://blogs.msdn.com/b/windowsazure/archive/2010/02/02/beta-release-of-windows-azure-drive.aspx">here</a>. Drives are implemented with a kernel mode driver that runs within your VM, so your disk IO to and from the drive in the VM will cause network IO to and from the VM to your page blob in Windows Azure Storage. The follow diagram shows the driver running inside the VM, communicating with storage through the VM&rsquo;s virtual network adapter.</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/8400.azuredrive_04359190.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/8400.azuredrive_5F00_04359190.jpg"><img style="display: inline; background-image: none;" title="azuredrive" border="0" alt="azuredrive" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/6443.azuredrive_thumb_0E86B5F0.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/6443.azuredrive_5F00_thumb_5F00_0E86B5F0.jpg" width="554" height="327"/></a></p>
<p>PaaS roles are allowed to mount up to 16 drives per role.</p>
<h4>Disks (IaaS)</h4>
<p>When you create a Windows Azure Virtual Machine, the platform will attach at least one disk to the VM for your operating system disk. This disk will also be a VHD stored as a page blob in storage. As you write to the disk in the VM, the changes to the disk will be made to the page blob inside storage. You can also <a href="https://www.windowsazure.com/en-us/manage/windows/how-to-guides/attach-a-disk/">attach additional disks</a> to your VM as data disks, and these will be stored in storage as page blobs as well.</p>
<p>Unlike for drives, the code that communicates with storage on behalf of your disk is not within your VM, so doing IO to the disk will not cause network activity in the VM, although it will cause network activity on the physical node. The following diagram shows how the driver runs in the host operating system, and the VM communicates through the disk interface to the driver, which then communicates through the host network adapter to storage.</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/0576.azuredrive_0E1A82FB.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/0576.azuredrive_5F00_0E1A82FB.jpg"><img style="display: inline; background-image: none;" title="azuredrive" border="0" alt="azuredrive" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/5873.azuredrive_thumb_5B4A7C86.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/5873.azuredrive_5F00_thumb_5F00_5B4A7C86.jpg" width="557" height="329"/></a></p>
<p>There are limits to the number of disks a virtual machine can mount, varying from 16 data disks for an extra-large virtual machine, to one data disk for an extra small virtual machine. Details can be found <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156003">here</a>.</p>
<p><b>IMPORTANT: </b>The Windows Azure platform holds an <a href="http://msdn.microsoft.com/en-us/library/windowsazure/ee691972.aspx">infinite lease</a> on all the page blobs that it considers disks in your storage account so that you don&rsquo;t accidently delete the underlying page blob, container, nor the storage account while the VM is using the VHD. If you want to delete the underlying page blob, the container it is within, or the storage account, you will need to detach the disk from the VM first as shown here:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/3704.detatchdisk_21C76C8F.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/3704.detatchdisk_5F00_21C76C8F.jpg"><img style="display: inline; background-image: none;" title="detatchdisk" border="0" alt="detatchdisk" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/4774.detatchdisk_thumb_41764657.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/4774.detatchdisk_5F00_thumb_5F00_41764657.jpg" width="570" height="54"/></a></p>
<p>And then select the disk you want to detach and then delete:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/8400.detachdiskfromvm_6125201F.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/8400.detachdiskfromvm_5F00_6125201F.jpg"><img style="display: inline; background-image: none;" title="detachdiskfromvm" border="0" alt="detachdiskfromvm" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/1145.detachdiskfromvm_thumb_04DE47BA.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/1145.detachdiskfromvm_5F00_thumb_5F00_04DE47BA.jpg" width="405" height="286"/></a></p>
<p>Then you need to remove the disk from the portal:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/7827.vmdisks_248D2182.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/7827.vmdisks_5F00_248D2182.jpg"><img style="display: inline; background-image: none;" title="vmdisks" border="0" alt="vmdisks" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/1157.vmdisks_thumb_0405E1D0.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/1157.vmdisks_5F00_thumb_5F00_0405E1D0.jpg" width="561" height="99"/></a></p>
<p>and then you can select &lsquo;delete disk&rsquo; from the bottom of the window:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/5355.deletedisk_5F74544B.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/5355.deletedisk_5F00_5F74544B.jpg"><img style="display: inline; background-image: none;" title="deletedisk" border="0" alt="deletedisk" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/1638.deletedisk_thumb_5135DB5B.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/1638.deletedisk_5F00_thumb_5F00_5135DB5B.jpg" width="334" height="65"/></a></p>
<p><b>Note</b>: when you delete the disk you are not deleting the disk (VHD page blob) in your storage account. You are only disassociating it from the images that can be used for Windows Azure Virtual Machines. After you have done all of the above, you will be able to delete the disk from your storage account, using Windows Azure Storage REST APIs or storage explorers.<b></b></p>
<h4>Images (IaaS)</h4>
<p>Windows Azure uses the concept of an &ldquo;Image&rdquo; to describe a template VHD that can be used to create one or more Virtual Machines. Windows Azure and some partners provide images that can be used to create Virtual Machines. You can also create images for yourself by <a href="https://www.windowsazure.com/en-us/manage/windows/how-to-guides/capture-an-image/">capturing an image</a> of an existing Windows Azure Virtual Machine, or you can <a href="https://www.windowsazure.com/en-us/manage/windows/common-tasks/upload-a-vhd/">upload a sysprep&rsquo;d image</a> to your storage account. An image is also in the VHD format, but the platform will not write to the image. Instead, when you create a Virtual Machine from an image, the system will create a copy of that image&rsquo;s page blob in your storage account, and that copy will be used for the Virtual Machine&rsquo;s operating system disk.</p>
<p><b>IMPORTANT: </b>Windows Azure holds an infinite lease on all the page blobs, the blob container and the storage account that it considers images in your storage account. Therefore, to delete the underlying page blob, you need to delete the image from the portal by going to the &ldquo;Virtual Machines&rdquo; section, clicking on &ldquo;Images&rdquo;:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/0564.vmimages_70E4B523.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/0564.vmimages_5F00_70E4B523.jpg"><img style="display: inline; background-image: none;" title="vmimages" border="0" alt="vmimages" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/0552.vmimages_thumb_09745274.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/0552.vmimages_5F00_thumb_5F00_09745274.jpg" width="553" height="144"/></a></p>
<p>Then you select your image and press &ldquo;Delete Image&rdquo; at the bottom of the screen. This will disassociate the VHD from your set of registered images, but it does not delete the page blob from your storage account. At that point, you will be able to delete the image from your storage account.</p>
<h4>Temporary Disk</h4>
<p>There is another disk present in all web roles, worker roles, VM Roles, and Windows Azure Virtual Machines, called the temporary disk. This is a physical disk on the node that can be used for scratch space. Data on this disk will be lost when the VM is moved to another physical machine, which can happen during upgrades, patches, and when Windows Azure detects something is wrong with the node you are running on. The sizes offered for the temporary disk are defined <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj156003">here</a>.</p>
<p>The temporary disk is the ideal place to store your operating system&rsquo;s pagefile.<b></b></p>
<p><b>IMPORTANT:</b> The temporary disk is not persistent. You should only write data onto this disk that you are willing to lose at any time.</p>
<h3>Billing</h3>
<p>Windows Azure Storage charges for <a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/07/09/understanding-windows-azure-storage-billing-bandwidth-transactions-and-capacity.aspx">Bandwidth, Transactions, and Storage Capacity</a>. The per-unit costs of each can be found <a href="https://www.windowsazure.com/en-us/pricing/details/">here</a>.</p>
<h4>Bandwidth</h4>
<p>We recommend mounting drives from within the same location (e.g., US East) as the storage account they are stored in, as this offers the best performance, and also will not incur bandwidth charges. With disks, you are required to use them within the same location the disk is stored.</p>
<h4>Transactions</h4>
<p>When connected to a VM, disk IOs from both drives and disks will be satisfied from storage (unless one of the layers of cache described below can satisfy the request first). Small disk IOs will incur one Windows Azure Storage transaction per IO. Larger disk IOs will be split into smaller IOs, so they will incur more transaction charges. The breakdown for this is:</p>
<ul>
<li>Drives</li>
<ul>
<li>IO &lt; 2 megabytes will be 1 transaction</li>
<li>IO &gt;= 2 megabytes will be broken into transactions of 2MBs or smaller</li>
</ul>
<li>Disks</li>
<ul>
<li>IO &lt; 128 kilobytes will be 1 transaction</li>
<li>IO &gt;= 128 kilobytes will be broken into transactions of 128KBs or smaller</li>
</ul>
</ul>
<p>In addition, operating systems often perform a little read-ahead for small sequential IOs (typically less than 64 kilobytes), which may result in larger sized IOs to drives/disks than the IO size being issued by the application. If the prefetched data is used, then this can result in fewer transactions to your storage account than the number of IOs issued by your application.</p>
<h4>Storage Capacity</h4>
<p>Windows Azure Storage stores pages blobs and thus VHDs in sparse format, and therefore only charges for data within the VHD that has actually been written to during the life of the VHD. Therefore, we recommend using &lsquo;quick format&rsquo; because this will avoid storing large ranges of zeros within the page blob. When creating a VHD you can choose the quick format option by specifying the below:</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/3782.quickformat_421EFC81.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/3782.quickformat_5F00_421EFC81.jpg"><img style="display: inline; background-image: none;" title="quickformat" border="0" alt="quickformat" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/6332.quickformat_thumb_6FA01C44.jpg" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-01-36-55-metablogapi/6332.quickformat_5F00_thumb_5F00_6FA01C44.jpg" width="556" height="425"/></a></p>
<p>It is also important to note that when you delete files within the file system used by the VHD, most operating systems do not clear or zero these ranges, so you can still be paying capacity charges within a blob for the data that you deleted via a disk/drive.</p>
<h3>Caches, Caches, and more Caches</h3>
<p>Drives and disks both support on-disk caching and some limited in-memory caching. Many layers of the operating system as well as application libraries do in-memory caching as well. This section highlights some of the caching choices you have as an application developer.</p>
<p>Caching can be used to improve performance, as well as to reduce transaction costs. The following table outlines some of the caches that are available for use with disks and drives. Each is described in more detail below the table.</p>
<table border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td valign="top" width="115">&nbsp;</td>
<td valign="top" width="138">
<p>Type</p>
</td>
<td valign="top" width="181">
<p>Purpose</p>
</td>
<td valign="top" width="204">
<p>Data Persistence</p>
</td>
</tr>
<tr>
<td valign="top" width="115">
<p>FileStream</p>
</td>
<td valign="top" width="138">
<p>Memory</p>
</td>
<td valign="top" width="181">
<p>Improves performance and reduces IOs for sequential reads and writes.</p>
</td>
<td valign="top" width="204">
<p>Writes are not automatically persisted. Call &ldquo;Flush&rdquo; to persist writes.</p>
</td>
</tr>
<tr>
<td valign="top" width="115">
<p>Operating System Caching</p>
</td>
<td valign="top" width="138">
<p>Memory</p>
</td>
<td valign="top" width="181">
<p>Improves performance and reduces IOs for random and sequential reads and writes.</p>
</td>
<td valign="top" width="204">
<p>Writes are not automatically persisted. Use &ldquo;Write through&rdquo; file handles, or &ldquo;Flush&rdquo; to persist writes.</p>
</td>
</tr>
<tr>
<td valign="top" width="115">
<p>Window Azure Drive Caches</p>
</td>
<td valign="top" width="138">
<p>Memory And Disk</p>
</td>
<td valign="top" width="181">
<p>Reduces read transactions to storage. Can improve performance for sequential IO, depending on workload.</p>
</td>
<td valign="top" width="204">
<p>Writes are automatically persisted. Use &ldquo;Write through&rdquo; file handles, or &ldquo;Flush&rdquo; to know writes are persisted.</p>
</td>
</tr>
<tr>
<td valign="top" width="115">
<p>Windows Azure Virtual Machine Disk Caches</p>
</td>
<td valign="top" width="138">
<p>Memory And Disk</p>
</td>
<td valign="top" width="181">
<p>Reduces transactions to storage. Can improve performance for sequential IO, depending on workload. Improves boot time.</p>
</td>
<td valign="top" width="204">
<p>Writes are automatically persisted. Use &ldquo;Write through&rdquo; file handles, or &ldquo;Flush&rdquo; to know writes are persisted.</p>
</td>
</tr>
<tr>
<td valign="top" width="115">
<p>No Disk or Drive Cache</p>
</td>
<td valign="top" width="138">
<p>N/A</p>
</td>
<td valign="top" width="181">
<p>Can improve performance for random and sequential IO, depending on workload.</p>
</td>
<td valign="top" width="204">
<p>Writes are automatically persisted. Use &ldquo;Write through&rdquo; file handles, or &ldquo;Flush&rdquo; to know writes are persisted.</p>
</td>
</tr>
</tbody>
</table>
<h4>FileStream (applies to both disks and drives)</h4>
<p>.NET framework&rsquo;s <a href="http://msdn.microsoft.com/en-us/library/y0bs3w9t">FileStream</a> class will cache reads and writes in memory to reduce IOs to the disk. Some of the FileStream constructors take a cache size, and others will choose the default 8k cache size for you. You can not specify that the class use no memory cache, as the minimum cache size is 8 bytes. You can force the buffer to be written to disk by calling the <a href="http://msdn.microsoft.com/en-us/library/ee474552">FileStream.Flush(bool)</a> API.</p>
<h4>Operating System Caching (applies to both disks and drives)</h4>
<p>The operating system itself will do in-memory buffering for both reads and writes, unless you explicitly turn it off when you open a file using <strong>FILE_FLAG_WRITE_THROUGH</strong> and/or <strong>FILE_FLAG_NO_BUFFERING</strong>. An in-depth discussion of the in memory caching behavior of windows is available <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85).aspx#caching_behavior">here</a>.</p>
<h4>Windows Azure Drive Caches</h4>
<p>Drives allow you to choose whether to use the node&rsquo;s local temporary disk as a read cache, or to use no cache at all. The space for a drive&rsquo;s cache is allocated from your web role or worker role&rsquo;s temporary disk. This cache is write-through, so writes are always committed immediately to storage. Reads will be satisfied either from the local disk, or from storage.</p>
<p>Using the drive local cache can improve sequential IO read performance when the reads &lsquo;hit&rsquo; the cache. Sequential reads will hit the cache if:</p>
<ol>
<li>The data has been read before. The data is cached on the first time it is read, not on first write.</li>
<li>The cache is large enough to hold all of the data.</li>
</ol>
<p>Access to the blob can often deliver a higher rate of random IOs than the local disk. However, these random IOs will incur storage transaction costs. To reduce the number of transactions to storage, you can use the local disk cache for random IOs as well. For best results, ensure that your random writes to the disk are 8KB aligned, and the IO sizes are in multiples of 8KB.</p>
<h4>Windows Azure Virtual Machine Disk Caches</h4>
<p>When deploying a Virtual Machine, the OS disk has two host caching choices:</p>
<ol>
<li>Read/Write (Default) &ndash; write back cache</li>
<li>Read - write through cache</li>
</ol>
<p>When you setup a data disk on a virtual machine, you get three host caching choices:</p>
<ol>
<li>Read/Write &ndash; write back cache</li>
<li>Read &ndash; write through cache</li>
<li>None (Default)</li>
</ol>
<p>The type of cache to use for data disks and the OS disk is not currently exposed through the portal. To set the type of host caching, you must either use the Service Management APIs (either <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj157199">Add Data Disk</a> or <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj157190">Update Data Disk</a>) or the Powershell commands (<a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj152837">Add-AzureDataDisk</a> or <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj152851">Set-AzureDataDisk</a>).</p>
<p>The read cache is stored both on disk and in memory in the host OS. The write cache is stored in memory in the host OS.</p>
<p>WARNING: If your application does not use <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa363858(v=vs.85).aspx">FILE_FLAG_WRITE_THROUGH</a>, the write cache could result in data loss because the data could be sitting in the host OS memory waiting to be written when the physical machine crashes unexpectedly.</p>
<p>Using the read cache will improve sequential IO read performance when the reads &lsquo;hit&rsquo; the cache. Sequential reads will hit the cache if:</p>
<ol>
<li>The data has been read before.</li>
<li>The cache is large enough to hold all of the data.</li>
</ol>
<p>The cache&rsquo;s size for a disk varies based on instance size and the number of disks mounted. Caching can only be enabled for up to four data disks.</p>
<h4>No Caching for Windows Azure Drives and VM Disks</h4>
<p>Windows Azure Storage can provide a higher rate of random IOs than the local disk on your node that is used for caching. If your application needs to do lots of random IOs, and throughput is important to you, then you may want to consider not using the above caches. Keep in mind, however, that IOs to Windows Azure Storage do incur transaction costs, while IOs to the local cache do not.</p>
<p>To disable your Windows Azure Drive cache, pass &lsquo;0&rsquo; for the cache size when you call the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.storageclient.clouddrive.mount.aspx">Mount</a>() API.</p>
<p>For a Virtual Machine data disk the default behavior is to not use the cache. If you have enabled the cache on a data disk, you can disable it using the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj157190">Update Data Disk</a> service management API, or the <a href="http://msdn.microsoft.com/en-us/library/windowsazure/jj152851">Set-AzureDataDisk</a> powershell command.</p>
<p>For a Virtual Machine operating system disk the default behavior is to use the cache. If your application will do lots of random IOs to data files, you may want to consider moving those files to a data disk which has the caching turned off.</p>
<p>&nbsp;</p>
<p>Andrew Edwards and Brad Calder</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (3)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2012%2F06%2F27%2Fexploring-windows-azure-drives-disks-and-images%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-159">
				<div id="div-comment-159" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/c6cfd698b42a37fd18088883963481e5?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/c6cfd698b42a37fd18088883963481e5?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Veerendrakumar.balla</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/#comment-159">
			August 8, 2012 at 11:34 am</a>		</div>

		<p>Great article with complete information on VHDs and images. </p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2012%2F06%2F27%2Fexploring-windows-azure-drives-disks-and-images%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-175">
				<div id="div-comment-175" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Sumant Sarkar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/#comment-175">
			October 10, 2012 at 9:16 am</a>		</div>

		<p>we have a Worker role and have uploaded a VHD file to the blob storage.</p>
<p>how do we create Azure drive?</p>
<p>Thanks in advance.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2012%2F06%2F27%2Fexploring-windows-azure-drives-disks-and-images%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-177">
				<div id="div-comment-177" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/27/exploring-windows-azure-drives-disks-and-images/#comment-177">
			October 16, 2012 at 9:22 am</a>		</div>

		<p>Hi Sumant,</p>
<p>First, we need to make sure your VHD is in the &#39;fixed&#39; VHD format. &nbsp;Windows Azure Drive does not support the &#39;dynamic&#39; VHD format. &nbsp;If you used &quot;csupload&quot; (<a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/windowsazure/gg466228.aspx">msdn.microsoft.com/&#8230;/gg466228.aspx</a>) to upload the VHD, it would have translated the format for you during the upload. &nbsp;If you used another tool, then please make sure it was in the correct format before you uploaded it.</p>
<p>Next, you need to add some code to your worker role to call the CloudDrive.Mount() API (see <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/windowsazure/microsoft.windowsazure.storageclient.clouddrive.mount.aspx">msdn.microsoft.com/&#8230;/microsoft.windowsazure.storageclient.clouddrive.mount.aspx</a>). &nbsp;More details can be found here: <a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/03/29/windows-azure-drive-demo-at-mix-2010.aspx">blogs.msdn.com/&#8230;/windows-azure-drive-demo-at-mix-2010.aspx</a></p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Windows Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2012%2F06%2F27%2Fexploring-windows-azure-drives-disks-and-images%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->