---
layout: windowsazurestorage
title: Windows Azure Tables&#58; Introducing Upsert and Query Projection
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-59" class="post-59 post type-post status-publish format-standard hentry category-uncategorized tag-windows-azure-tables">

	<header class="entry-header single">
		<h1 class="entry-title">Windows Azure Tables: Introducing Upsert and Query Projection</h1>		<div class="rating-wrap">
		<div id="star-rating-59" class="wds-ratings" data-rating="4" data-userrating="0" data-postid="59" data-container="body" data-toggle="tooltip" title="2 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2011-09-15T13:25:00+00:00">September 15, 2011</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comments">13</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/&quot;, &quot;text&quot;: &quot;Windows Azure Tables: Introducing Upsert and Query Projection&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/&quot;, &quot;text&quot;: &quot;Windows Azure Tables: Introducing Upsert and Query Projection&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>As part of the “2011-08-18” version, two Windows Azure Table features were introduced; Upsert, represented by the InsertOrReplace Entity and InserOrMerge Entity APIs, and Query Projection.</p>
<p>In this section, we will first provide an overview of these two features, by defining them and providing use case scenarios. Then, we will illustrate how the Storage Client Library and WCF Data Services can be used to invoke the new APIs by providing sample code based on a usage scenario that highlights both newly introduced features. </p>
<h3><a name="_Toc303160704">Upsert (InsertOrReplace Entity and InsertOrMerge Entity) Feature</a></h3>
<p>The term Upsert is a combination of update and insert. It refers to inserting an entity if the entity does not exist or updating the existing entity if it already exists. </p>
<p>Upsert requests will save an extra call to the storage system when an application wants to insert or update an entity without needing to know if the entity already exists or not. Without Upsert, the application could send up to two requests to get the same behavior i.e. an Update Entity request followed by an Insert Entity request in case the update failed with ‘entity does not exist’. As you can imagine, Upsert can significantly help performance and decrease latencies in certain scenarios (see next section for examples). </p>
<p>The two Upsert APIs provided by Windows Azure Table are InsertOrReplace Entity and InsertOrMerge Entity which are defined as follows: </p>
<ul>
<li>&#160;<a href="http://msdn.microsoft.com/en-us/library/hh452242.aspx"><b>InsertOrReplace Entity</b></a>: as the API name implies, InsertOrReplace Entity will insert the entity if the entity does not exist, or if the entity exists, replace the existing one. This means that once the operation successfully completes the table will contain the new entity with properties as defined in the InsertOrReplace Entity request, replacing the prior entity and its properties if it had previously existed. </li>
<li><a href="http://msdn.microsoft.com/en-us/library/hh452241.aspx"><b>InsertOrMerge Entity</b></a>: InsertOrMerge Entity will insert the entity if the entity does not exist or, if the entity exists, merges the provided entity properties with the already existing ones. Once the operation successfully completes, the table will contain the provided entity with updated properties provided in the request. In other words, if the entity exists, the API would have the same effect as <a href="http://msdn.microsoft.com/en-us/library/dd179392.aspx">Merge Entity</a>, where the resultant entity is a union of properties between the existing and the updated ones. </li>
</ul>
<p>As you can infer from the above, the difference between the two Upsert commands lays in the update behavior if the entity already exists. </p>
<p><b>Note:</b> Both Upsert APIs can be used in batch operations (<a href="http://msdn.microsoft.com/en-us/library/dd894038.aspx">Entity Group Transactions</a>). </p>
<h4><a name="_Toc303160705">Usage Examples</a></h4>
<p>Here are some possible scenarios for using Upsert. </p>
<h5><a name="_Toc303160706">InsertOrReplace Usage Example</a></h5>
<p>An example scenario for use of the InsertOrReplace API would be when a component is responsible for creating and updating entities and ensuring that none of the old entity properties are retained in case the entity already exists. In this case, that component will issue an InsertOrReplace request. </p>
<p>As a concrete example, consider an engine as part of an Azure application that constantly updates its data set by pulling the newest version from a data feed that it is subscribed to. That data feed could be a movie listing, real estate listing, weather updates, etc.; provided as an internet service. At a regular interval, the Azure application would pull the latest data from the feed and update its view that is stored in Windows Azure Table. The application could already have an outdated view of the dataset; in this case a replacement for these entities is needed if they already exist. The data feed could also be providing new information and therefore the application would insert those as new entities. Without upsert capabilities the Azure application would first attempt to send an unconditional Update Entity request, and on failure, which means the entity does not exist, the application would then issue an Insert Entity request. This means that the application would end up doing two requests for every entity in the data set if it does not already exist. </p>
<p>This scenario is greatly simplified by the Upsert capability, where the application would issue a single InsertOrReplace Entity request for every entity instead of two requests. Upsert in this scenario doubles the performance when the entity did not already exist. In addition, the application could boost its performance further by batching InsertOrReplace requests together as part of an entity group transaction. </p>
<h5><a name="_Toc303160707"></a><a name="_InsertOrMerge_Entity_Scenarios"></a>InsertOrMerge Usage Example</h5>
<p>The InsertOrMerge API would appeal in situations where two distinct components need to insert/update an entity in a table, while also being responsible for managing properties in the entities. In addition, these components do not want to reset or delete the other’s compo<a name="_GoBack"></a>nent specific properties if the entity already exists. </p>
<p>As an example, consider a customer information table that is updated by multiple components of a service; <i>component A</i> is a mobile application and <i>component B</i> is the website of the service accessible through the browser. Based on some user input, assume that <i>component A </i>can detect the mobile phone number of a user called John Smith and wants to insert that information into the table. In this situation, the mobile device will issue an InsertOrMerge command and expects the customer entity to be created with only John Smith’s mobile phone number if the entity does not exist, or merge the properties sent with the existing ones in case John Smith’s entity already exists. Similarly, <i>component B </i>that is running as part of the website which can collect more information from the user such as his address, email address, etc. would do the same if it wants to update John Smith’s information without removing any other previously recorded information. </p>
<p>Without Upsert, both components would have first issued an unconditional Merge Entity request and on failure, they would have sent an Insert Entity request. They would also have to deal with the edge case where both of their Insert requests collide and one of those components had to re-issue an Update Entity request again. Upsert, as you can see, will greatly simplify the code and can provide a significant performance gain. We will highlight this example through code in the subsequent sections. </p>
<h3><a name="_Toc303160708">Query Projection Feature</a></h3>
<p>Projection refers to querying a subset of an entity or entities’ properties. This is analogous to selecting a subset of the columns/properties of a certain table when querying in LINQ. It is a mechanism that would allow an application to reduce the amount of data returned by a query by specifying that only certain properties are returned in the response. For more information, you can also refer to <a href="http://msdn.microsoft.com/en-us/library/dd179421.aspx">Windows Azure Table: Query Entities</a>, <a href="http://msdn.microsoft.com/en-us/library/dd894039.aspx">Windows Azure Table: Writing LINQ Queries</a>, <a href="http://msdn.microsoft.com/en-us/library/ee473425.aspx">WCF Data Services: Query Projections</a>, and <a href="http://go.microsoft.com/fwlink/?LinkId=186076">OData: Select System Query Option ($select)</a>. </p>
<h4><a name="_Toc303160709">Usage Example</a></h4>
<p>The obvious benefit of Query Projection is to reduce the latency of retrieving data from a Windows Azure Table. There are many usage scenarios where you only want to retrieve the needed properties in a table. For example, consider the scenario where we want to retrieve only a few properties in a table for display on a web page for entities that contain hundreds of properties. In this scenario we would save both on bandwidth usage and improve performance by using Projection. </p>
<p>Another usage is for a recurring job that acts on only a few properties and updates them on a regular basis. In this case, Projection would be handy in only retrieving the entities’ properties that needs updating. This latter usage scenario will be highlighted in sample code provided in the subsequent sections. </p>
<p>In addition, the projection feature will be useful in writing code that would count the number of entities in a certain table in a more efficient manner. We are working on providing Count() in the future, but until that is available Projection is useful since it will allow the transfer of a single property back to the client instead of the full row which makes the counting job more efficient. The code that highlights this usage is demonstrated in a later section. </p>
<h3><a name="_Toc303160710">Using Storage Client Library and WCF Data Services to invoke Upsert commands and Query Projection</a></h3>
<p>In this section, we will walk you through sample code that highlights how an application can use the Storage Client Library and WCF Data Services in order to be able to send Upsert commands such as InsertOrReplace Entity or InsertOrMerge Entity<b> </b>and to do Query Projection. </p>
<p>We will use the customer scenario described in the above InsertOrMerge Usage Example section for the below sample code where a system inserts and updates customer information through two different means; a component running as a mobile application and a component running as part of a website service. </p>
<h4><a name="_Toc303160711">Sending new storage version using the Storage Client Library</a></h4>
<p>To unlock the new Windows Azure Storage Table Upsert and Query Projection features, all REST/OData requests should be tagged with the “20011-08-18” storage version as described in the MSDN documents for <a href="http://msdn.microsoft.com/en-us/library/hh452242.aspx">InsertOrReplace Entity</a>, <a href="http://msdn.microsoft.com/en-us/library/hh452241.aspx">InsertOrMerge Entity</a> and <a href="http://msdn.microsoft.com/en-us/library/dd179421.aspx">Query Entities</a>. If your application is using the .NET storage client library, you can leverage the following code that will help you make use of all current capabilities of the TableServiceContext class while being able to invoke the new Upsert and projection APIs. </p>
<p>The reason the below code is necessary is because the released library sends an older storage version “2009-09-19” that does not support these newly released features. Once a new version is released, the below code would not be needed.</p>
<pre class="code"><span style="color: blue">public class </span><span style="color: #2b91af">TableServiceContextV2 </span>: <span style="color: #2b91af">TableServiceContext
</span>{
    <span style="color: blue">private const string </span>StorageVersionHeader = <span style="color: #a31515">&quot;x-ms-version&quot;</span>;
    <span style="color: blue">private const string </span>August2011Version = <span style="color: #a31515">&quot;2011-08-18&quot;</span>;

    <span style="color: blue">public </span>TableServiceContextV2(<span style="color: blue">string </span>baseAddress, <span style="color: #2b91af">StorageCredentials </span>credentials):
        <span style="color: blue">base </span>(baseAddress, credentials)
    {
        <span style="color: blue">this</span>.SendingRequest += SendingRequestWithNewVersion;
    }

    <span style="color: blue">private void </span>SendingRequestWithNewVersion(<span style="color: blue">object </span>sender, SendingRequestEventArgs e)
    {
        <span style="color: #2b91af">HttpWebRequest </span>request = e.Request <span style="color: blue">as </span><span style="color: #2b91af">HttpWebRequest</span>;

        <span style="color: green">// Apply the new storage version as a header value
        </span>request.Headers[StorageVersionHeader] = August2011Version;
    }
}</pre>
<p>We will be using TableServiceContextV2 throughout the subsequent sections in order to make use of the new feature. </p>
<h4><a name="_Toc303160712">Sample Setup Code</a></h4>
<p>In this section we will define the schema of the “Customers” table that will be used throughout the subsequent sections and the sample code needed to fill this sample table with some initial entities. </p>
<p>Assume that the “Customers” table entity is defined as follows:</p>
<pre class="code">[DataServiceKey(<span style="color: #a31515">&quot;PartitionKey&quot;</span>, <span style="color: #a31515">&quot;RowKey&quot;</span>)]
<span style="color: blue">public class </span><span style="color: #2b91af">CustomerEntity
</span>{
    <span style="color: blue">public </span>CustomerEntity(<span style="color: blue">string </span>partitionKey, <span style="color: blue">string </span>rowKey)
    {
        <span style="color: blue">this</span>.PartitionKey = partitionKey;
        <span style="color: blue">this</span>.RowKey = rowKey;
    }

    <span style="color: blue">public </span>CustomerEntity() {}

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Customer First Name
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public string </span>PartitionKey { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Customer Last Name
    </span><span style="color: gray">/// &lt;/summary&gt;
    </span><span style="color: blue">public string </span>RowKey { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public </span><span style="color: #2b91af">DateTime </span>Timestamp { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public string </span>Address { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public string </span>Email { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public string </span>PhoneNumber { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: green">// The below 2 properties are declared as nullable since
    // they are considered optional fields in this example
    </span><span style="color: blue">public </span><span style="color: #2b91af">DateTime</span>? CustomerSince { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }

    <span style="color: blue">public int</span>? Rating { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
}</pre>
<p>We will initialize the “Customers” table using the following code:</p>
<pre class="code"><span style="color: blue">string </span>accountName = <span style="color: #a31515">&quot;someaccountname&quot;</span>;
<span style="color: blue">string </span>accountKey = <span style="color: #a31515">&quot;SOMEKEY&quot;</span>;
<span style="color: blue">string </span>customersTableName = <span style="color: #a31515">&quot;Customers&quot;</span>;

<span style="color: #2b91af">CloudStorageAccount </span>account = <span style="color: #2b91af">CloudStorageAccount</span>.Parse(<span style="color: blue">string</span>.Format(<span style="color: #a31515">&quot;TableEndpoint=http://{0}.table.core.windows.net;AccountName={0};AccountKey={1}&quot;</span>, accountName, accountKey));

<span style="color: #2b91af">CloudTableClient </span>tableClient = account.CreateCloudTableClient();
tableClient.CreateTableIfNotExist(customersTableName);

<span style="color: green">// Bootstrap the Customers table with a set of sample customer entries
</span><span style="color: #2b91af">TableServiceContext </span>bootstrapContext = <span style="color: blue">new </span>TableServiceContextV2(tableClient.BaseUri.ToString(), tableClient.Credentials);

BootstrapTable(customersTableName, bootstrapContext);</pre>
<p>And the BootstrapTable method is defined as follows:</p>
<pre class="code"><span style="color: blue">static void </span>BootstrapTable(<span style="color: blue">string </span>tableName, <span style="color: #2b91af">TableServiceContext </span>serviceContext)
{
    CustomerEntity customer1 = <span style="color: blue">new </span>CustomerEntity(<span style="color: #a31515">&quot;Walter&quot;</span>, <span style="color: #a31515">&quot;Harp&quot;</span>);
    customer1.Address = <span style="color: #a31515">&quot;1345 Fictitious St, St Buffalo, NY 98052&quot;</span>;
    customer1.CustomerSince = <span style="color: #2b91af">DateTime</span>.Parse(<span style="color: #a31515">&quot;01/05/2010&quot;</span>);
    customer1.Email = <span style="color: #a31515">&quot;Walter@contoso.com&quot;</span>;
    customer1.PhoneNumber = <span style="color: #a31515">&quot;425-555-0101&quot;</span>;
    customer1.Rating = 4;

    serviceContext.AddObject(tableName, customer1);

    CustomerEntity customer2 = <span style="color: blue">new </span>CustomerEntity(<span style="color: #a31515">&quot;Jonathan&quot;</span>, <span style="color: #a31515">&quot;Foster&quot;</span>);
    customer2.Address = <span style="color: #a31515">&quot;1234 SomeStreet St, Bellevue, WA 75001&quot;</span>;
    customer2.CustomerSince = <span style="color: #2b91af">DateTime</span>.Parse(<span style="color: #a31515">&quot;01/05/2005&quot;</span>);
    customer2.Email = <span style="color: #a31515">&quot;Jonathan@fourthcoffee.com&quot;</span>;
    customer2.Rating = 3;

    serviceContext.AddObject(tableName, customer2);

    CustomerEntity customer3 = <span style="color: blue">new </span>CustomerEntity(<span style="color: #a31515">&quot;Lisa&quot;</span>, <span style="color: #a31515">&quot;Miller&quot;</span>);
    customer3.Address = <span style="color: #a31515">&quot;4567 NiceStreet St, Seattle, WA 54332&quot;</span>;
    customer3.CustomerSince = <span style="color: #2b91af">DateTime</span>.Parse(<span style="color: #a31515">&quot;01/05/2003&quot;</span>);
    customer3.Email = <span style="color: #a31515">&quot;Lisa@northwindtraders.com&quot;</span>;
    customer3.Rating = 2;

    serviceContext.AddObject(tableName, customer3);

    serviceContext.SaveChanges();
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>&#160;</p>
<h4><a name="_Toc303160713">InsertOrMerge Entity API</a> Sample Code</h4>
<p>As per the sample code scenario, the mobile app would want to InsertOrMerge an entity for John Smith with his phone number, similarly the website engine would want to do the same but for different and distinct properties. Assume that the mobileServiceContext defined below will represent the DataServiceContext that is running as part of the mobile app and the websiteServiceContext will represent the DataServiceContext that is running as part of the website engine.</p>
<pre class="code"><span style="color: green">// The mobileServiceContext will represent the app running on a mobile phone that is responsible in updating/inserting the customer phone number
</span><span style="color: #2b91af">TableServiceContext </span>mobileServiceContext = <span style="color: blue">new </span>TableServiceContextV2(tableClient.BaseUri.ToString(), tableClient.Credentials);

<span style="color: green">// The websiteServiceContext will represent the instance of the system that is able to insert and update other information about the customer 
</span><span style="color: #2b91af">TableServiceContext </span>websiteServiceContext = <span style="color: blue">new </span>TableServiceContextV2(tableClient.BaseUri.ToString(), tableClient.Credentials);</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The WCF DataServiceContext class does not natively support an InsertOrMerge or InsertOrReplace API. As mentioned in the MSDN documents for <a href="http://msdn.microsoft.com/en-us/library/hh452241.aspx">InsertOrMerge Entity</a> and <a href="http://msdn.microsoft.com/en-us/library/hh452242.aspx">InsertOrReplace Entity</a>, the OData requests as they appear on the wire are very similar in nature to a Merge Entity and Update Entity respectively with the main difference being that the If-Match header, represented by the Etag parameter in code, is omitted. In WCF Data Services API terms, this would be analogous to first attaching (AttachTo) an entity object to the DataServiceContext without any Etag specified and then invoking the UpdateObject method. This means the DataServiceContext is not initially tracking that object and therefore will omit sending any If-Match header when the SaveChanges method is called. The fact that an entity is being updated without an If-Match header signals to Windows Azure Tables that this is an Upsert request. </p>
<p><b>Note: </b>Prior to version “20011-08-18”, Windows Azure Table will reject any MERGE or PUT requests made against it where the If-Match header was not specified, as those earlier versions do not support Upsert commands.<b></b> </p>
<p>The code as part of the mobile application which Upserts John Smith’s phone number would therefore look as follows:</p>
<pre class="code"><span style="color: green">// The mobile app collects the customer's phone number
</span>CustomerEntity mobileCustomer = <span style="color: blue">new </span>CustomerEntity(<span style="color: #a31515">&quot;John&quot;</span>, <span style="color: #a31515">&quot;Smith&quot;</span>);
mobileCustomer.PhoneNumber = <span style="color: #a31515">&quot;505-555-0122&quot;</span>;

<span style="color: green">// Notice how the AttachTo method is called with a null Etag which indicates that this is an Upsert Command
</span>mobileServiceContext.AttachTo(customersTableName, mobileCustomer, <span style="color: blue">null</span>);

mobileServiceContext.UpdateObject(mobileCustomer);

<span style="color: green">// No SaveChangeOptions is used, which indicates that a MERGE verb will be used. This set of steps will result in an InsertOrMerge command to be sent to Windows Azure Table
</span>mobileServiceContext.SaveChanges();</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Similarly, the website engine which may not be aware if any data already exists for John Smith, and would want to InsertOrMerge its collected data so that it does not overwrite any existing data.</p>
<pre class="code">CustomerEntity websiteCustomer = <span style="color: blue">new </span>CustomerEntity(<span style="color: #a31515">&quot;John&quot;</span>, <span style="color: #a31515">&quot;Smith&quot;</span>);
websiteCustomer.Address = <span style="color: #a31515">&quot;6789 Main St, Albuquerque, VA 98004&quot;</span>;
websiteCustomer.Email = <span style="color: #a31515">&quot;John@cohowinery.com&quot;</span>;

<span style="color: green">// Since the website system might not know if the customer entry already exists, it will also issue an InsertOrMerge command as follows
</span>websiteServiceContext.AttachTo(customersTableName, websiteCustomer);
websiteServiceContext.UpdateObject(websiteCustomer);
websiteServiceContext.SaveChanges();</pre>
<p>At this point, if both components have Upserted John Smith’s information using the InsertOrMerge API as described above, the “Customers” table will now contain a John Smith entry with his phone number, address and email recorded.</p>
<h4><a name="_Toc303160714">InsertOrReplace Entity API</a> Sample Code</h4>
<p>Assume that there is an option on the website to sync all of the customer’s data from their mail service, and the semantics the website wants is to replace all of customer’s entity with this new data if it already exists, otherwise insert the entity. In this case, any information that was already in the system needs to be replaced; otherwise, we will insert the information as provided. Therefore, the best option for the website would be to use the InsertOrReplace Entity API. </p>
<p>Since we wish to send an InsertOrReplace Entity request, we would first need to AttachTo the websiteServiceContext without providing any Etag value before calling the UpdateObject method. In addition, the SaveChanges method would need to be invoked with the SaveChangesOptions.ReplaceOnUpdate parameter to indicate that the Upsert operation should replace the existing entity in case it exists. The code for this example for a customer called David would look like this:</p>
<pre class="code">CustomerEntity mailServiceCustomer = <span style="color: blue">new </span>CustomerEntity(<span style="color: #a31515">&quot;David&quot;</span>, <span style="color: #a31515">&quot;Alexander&quot;</span>);
mailServiceCustomer.PhoneNumber = <span style="color: #a31515">&quot;333-555-0155&quot;</span>;
mailServiceCustomer.Address = <span style="color: #a31515">&quot;234 Main St, Anaheim, TX, 65000&quot;</span>;
mailServiceCustomer.Email = <span style="color: #a31515">&quot;David@wideworldimporters.com&quot;</span>;

<span style="color: green">// Note how SaveChanges is called with ReplaceOnUpdate which is the differentiation
// factor between an InsertOrMerge Entity API and InsertOrReplace Entity Api
</span>websiteServiceContext.AttachTo(customersTableName, mailServiceCustomer);
websiteServiceContext.UpdateObject(mailServiceCustomer);
websiteServiceContext.SaveChanges(SaveChangesOptions.ReplaceOnUpdate);</pre>
<p><b>Note:</b> If in a rare case, the application wants to Upsert an entity that is already tracked by the DataServiceContext, you should first detach from the context and then attach to it in order to clear out any Etag tracking before performing the rest of the above steps.</p>
<h4><a name="_Toc303160715">Query Projection Sample Code</a></h4>
<p>To demonstrate the query projection feature, we will expand on the sample code provided in the previous sections. Assume that there is an offline job that needs to update the rating for all the customers. It needs to increment the rating by one, for everyone who has been a customer since 2006. To accomplish this, it would not be efficient to read all entities’ properties; rather, it would be more efficient to only retrieve the Rating property for all entities that match the CustomerSince criteria using query projection and then update just that property as needed. Since projection will provide a partial view of all the CustomerEntity properties, the best practice is to create a new data service entity type that would only hold the properties that we are interested in.</p>
<pre class="code">[DataServiceEntity]
    <span style="color: blue">public class </span><span style="color: #2b91af">CustomerRating
    </span>{
        <span style="color: blue">public </span><span style="color: #2b91af">DateTime</span>? CustomerSince { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
        
        <span style="color: blue">public int</span>? Rating { <span style="color: blue">get</span>; <span style="color: blue">set</span>; }
    }</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Although Rating is the only needed property to perform the job, we will also retrieve CustomerSince that the job could use for debugging and logging purposes. </p>
<p>The scan job code that uses projection and update is as follows:</p>
<pre class="code"><span style="color: #2b91af">TableServiceContext </span>ratingServiceContext = <span style="color: blue">new </span>TableServiceContextV2(tableClient.BaseUri.ToString(), tableClient.Credentials);

var query = <span style="color: blue">from </span>entity <span style="color: blue">in </span>ratingServiceContext.CreateQuery&lt;CustomerRating&gt;(customersTableName)
            <span style="color: blue">where </span>entity.CustomerSince &lt; <span style="color: #2b91af">DateTime</span>.Parse(<span style="color: #a31515">&quot;01/01/2006&quot;</span>)
            <span style="color: blue">select new </span>CustomerRating
            {
                CustomerSince =  entity.CustomerSince,
                Rating = entity.Rating
            };

<span style="color: green">// Iterate over all the entities that match the query criteria and increment the rating by 1
</span><span style="color: blue">foreach </span>(CustomerRating customerRating <span style="color: blue">in </span>query)
{
    <span style="color: blue">if </span>(customerRating.Rating.HasValue)
    {
        ++customerRating.Rating;
    }
    <span style="color: blue">else
    </span>{
        <span style="color: green">// in case no rating was already set
        </span>customerRating.Rating = 1;
    }
    ratingServiceContext.UpdateObject(customerRating);
}

ratingServiceContext.SaveChanges();</pre>
<p>Even though you might not have explicitly projected PartitionKey and RowKey, the server will be returning them as part of the OData entity resource path, known as link in WCF Data Services terms. Etag (or entity timestamp) is also returned as part of the response. These 3 properties are tracked by the DataServiceContext which uses them whenever an entity update is subsequently performed. Therefore, optimistic concurrency is also guaranteed on an entity with partial view as is the case with the CustomerRating.</p>
<p>The above code could be written differently if you wanted to re-use the CustomerEntity class instead of the CustomerRating class to project on. However, we highly recommend the use of a partial view class as it is the case with the CustomerRating. This would avoid resetting any value type properties defined as int, double, datetime, etc. by mistake in case they were not defined as nullable types. Furthermore, if you use the original CustomerEntity class, updates will generate a request with all the full entity properties serialized which would consume unnecessary bandwidth since only the Rating property was intended to be updated. </p>
<p><b>Note:</b> When projecting on an entity type that defines PartitionKey and RowKey such as CustomerEntity you must project on those keys if these entities are updated in later on. </p>
<p><b>Note:</b> You can project on up to 250 properties including the partition key, row key and timestamp. </p>
<h5><a name="_Toc303160716">Entity Counting Using Projection</a></h5>
<p>Until we provide Count(),you can use projection as follows. You can select any column you wish, though a common approach is to project the PartitionKey since it is anyway returned as part of the OData query projection response.</p>
<pre class="code"><span style="color: gray">/// &lt;summary&gt;
/// </span><span style="color: green">Counts the number of entities in an Azure table
</span><span style="color: gray">/// &lt;/summary&gt;
/// &lt;param name=&quot;dataServiceContext&quot;&gt;</span><span style="color: green">The TableServiceContextV2 to use in order to issue the requests.  TableServiceContextV2 makes sure that Aug-2011 version is transmitted on the wire</span><span style="color: gray">&lt;/param&gt;
/// &lt;param name=&quot;tableName&quot;&gt;</span><span style="color: green">The table name that we wish to count its entities</span><span style="color: gray">&lt;/param&gt;
/// &lt;returns&gt;&lt;/returns&gt;
</span><span style="color: blue">public long </span>GetEntityCount(<span style="color: #2b91af">TableServiceContext </span>dataServiceContext, <span style="color: blue">string </span>tableName)
{
    <span style="color: blue">long </span>count = 0;
            
    <span style="color: blue">var </span>query = <span style="color: blue">from </span>entity <span style="color: blue">in </span>dataServiceContext.CreateQuery&lt;<span style="color: #2b91af">TableServiceEntity</span>&gt;(tableName)
                <span style="color: blue">select new
                 </span>{
                     entity.PartitionKey
                 };

    <span style="color: blue">foreach </span>(<span style="color: blue">var </span>row <span style="color: blue">in </span>query.AsTableServiceQuery())
    {
        ++count;
    }

    <span style="color: blue">return </span>count;
}</pre>
<h5><a name="_Toc303160717">Other Projection Usage and Consideration</a></h5>
<p>If you want to project on a single property, the following WCF code is <b>not</b> supported and the query will be rejected by the server since it will result in an unsupported OData request format:</p>
<pre class="code"><span style="color: green">// The below single-entity projection is not supported and will be rejected by the server
</span>var query = <span style="color: blue">from </span>entity <span style="color: blue">in </span>ratingServiceContext.CreateQuery&lt;CustomerEntity&gt;(customersTableName)
            <span style="color: blue">where </span>entity.CustomerSince &lt; <span style="color: #2b91af">DateTime</span>.Parse(<span style="color: #a31515">&quot;01/01/2006&quot;</span>)
            <span style="color: blue">select </span>entity.Rating;</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Instead, the following code needs to be used. Note that the below code also demonstrates how you can project using an anonymous non-entity type object.</p>
<pre class="code">var query = <span style="color: blue">from </span>entity <span style="color: blue">in </span>ratingServiceContext.CreateQuery&lt;CustomerEntity&gt;(customersTableName)
            <span style="color: blue">where </span>entity.CustomerSince &lt; <span style="color: #2b91af">DateTime</span>.Parse(<span style="color: #a31515">&quot;01/01/2006&quot;</span>)
            <span style="color: blue">select new
            </span>{
                entity.Rating
            };

<span style="color: green">// The below code demonstrates how the projected Rating property could be accessed
</span><span style="color: blue">foreach </span>(var partialData <span style="color: blue">in </span>query)
{
    <span style="color: #2b91af">Console</span>.WriteLine(<span style="color: #a31515">&quot;Rating: {0}&quot;</span>, partialData.Rating);
}</pre>
<p>Jean Ghanem </p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-tables/" rel="tag">Windows Azure Tables</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (13)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-2431">
				<div id="div-comment-2431" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/Jai-Haridas-_2D00_-MSFT/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">jaidevh1@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2431">
			September 17, 2011 at 10:42 am</a>		</div>

		<p>I wanted to reiterate that Storage Client library that shipped with SDK 1.5 does not use the 2011-08-18 version for x-ms-version header. These features could not make it in that because of timelines but we are working on it. However, Jean has provided extensions in this blog that you can start using today with the Storage Client library. The extension involves:</p>
<p>Extend TableServiceContext (TableServiceContextV2 in the post above) to register for SendingRequest event, in which you will change the version. From here on, use this new context instance and you will get the new version.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2421">
				<div id="div-comment-2421" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Erick T</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2421">
			September 19, 2011 at 8:31 am</a>		</div>

		<p>Can you post an example of the InsertOrReplace and InsertOrMerge functionality using the HTTP REST API (i.e., the XML version).</p>
<p>Thanks. </p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2411">
				<div id="div-comment-2411" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/Jai-Haridas-_2D00_-MSFT/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">jaidevh1@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2411">
			September 19, 2011 at 7:38 pm</a>		</div>

		<p>Hi Erick, we have a sample at <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh452241.aspx">msdn.microsoft.com/&#8230;/hh452241.aspx</a> and <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/windowsazure/hh452242.aspx">msdn.microsoft.com/&#8230;/hh452242.aspx</a>. </p>
<p>Basically InsertOrMerge/InsertOrReplace are similar to Update &#8211; Merge/Replace respectively except that the InsertOrXXX version of request does not have the If-Match header. Does that help?</p>
<p>Thanks,</p>
<p>jai</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2401">
				<div id="div-comment-2401" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">ChrisL</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2401">
			September 21, 2011 at 6:56 pm</a>		</div>

		<p>I&#39;m still holding my breath for the ability to skip rows without incurring the cost of a full table scan. &nbsp;This is useful if I have 10,000 items in a table, and I simply want a range of zero to 100 rows.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2381">
				<div id="div-comment-2381" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/10afa6f820e43141271184a6d41baf40?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/10afa6f820e43141271184a6d41baf40?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/terry_5F00_tao_4000_asus.com/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">terry_tao@asus.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2381">
			December 11, 2011 at 1:26 am</a>		</div>

		<p>when I use the code above to test InsertOrMerge operation,a ResourceNotFound error occurred.When I use the table projection code above instead,another error Inputvalid occurred.My Windows Azure SDK version is v1.6.Can anybody reply me?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2371">
				<div id="div-comment-2371" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/Jai-Haridas-_2D00_-MSFT/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">jaidevh1@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2371">
			December 12, 2011 at 9:41 am</a>		</div>

		<p>@terrytao, can you see if there is anything odd via a fiddler trace? Feel free to share the fiddler request/response with jharidas at microsoft? Also with 1.6, since it sends the required version, you can just use TableServiceContext rather than the above TableServiceContextV2.</p>
<p>Jai</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2361">
				<div id="div-comment-2361" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Ricky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2361">
			May 22, 2012 at 8:19 pm</a>		</div>

		<p>Jai, I am having the same problem as terrytao trying projections on development storage</p>
<p>I have tracked it down to </p>
<p>23/05/2012 1:12:29 PM [Error] TableDataServiceHost.ProcessException. Rethrowing exception: System.Data.Services.DataServiceException: The response requires that version 2 of the protocol be used, but the MaxProtocolVersion of the data service is set to DataServiceProtocolVersion.V1.</p>
<p> &nbsp; at System.Data.Services.DataServiceConfiguration.ValidateMaxProtocolVersion(RequestDescription requestDescription)</p>
<p>My request Headers all seem correct to specify the correct version of data services and storage client</p>
<p>DataServiceVersion: 2.0;NetFx</p>
<p>MaxDataServiceVersion: 2.0;NetFx</p>
<p>x-ms-version: 2011-08-18</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2351">
				<div id="div-comment-2351" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Ricky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2351">
			May 22, 2012 at 8:42 pm</a>		</div>

		<p>After a bit more digging the development storage doesn&#39;t support these as of yet.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2341">
				<div id="div-comment-2341" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Ricky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2341">
			May 22, 2012 at 8:45 pm</a>		</div>

		<p>I have submitted a feature request to enhance the development storage to support these newer operations</p>
<p><a rel="nofollow" target="_new" href="http://www.mygreatwindowsazureidea.com/forums/34192-windows-azure-feature-voting/suggestions/2872460-storage-emulator-maxprotocolversion-of-the-data-se">http://www.mygreatwindowsazureidea.com/&#8230;/2872460-storage-emulator-maxprotocolversion-of-the-data-se</a></p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2331">
				<div id="div-comment-2331" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/Jai-Haridas-_2D00_-MSFT/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">jaidevh1@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2331">
			May 22, 2012 at 8:49 pm</a>		</div>

		<p>@Ricky, Dev storage does not support projections and upsert as it still uses the old WCF data Service interface on server side . We are working on improving this but we do not have an ETA that we can share as of yet.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2321">
				<div id="div-comment-2321" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/8dc576574982984d894cae9b078bc31f?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/8dc576574982984d894cae9b078bc31f?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/joel.mendoza_4000_dos.myflorida.com/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">joel.mendoza@dos.myflorida.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2321">
			July 9, 2012 at 7:49 am</a>		</div>

		<p>Does anyone know when insert-or-replace will be supported on the local storage emulator?</p>
<p>cheers!</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-2311">
				<div id="div-comment-2311" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn"><a href="http://blogs.msdn.com/Jai-Haridas-_2D00_-MSFT/ProfileUrlRedirect.ashx" rel="external nofollow" class="url">jaidevh1@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2311">
			July 9, 2012 at 9:57 pm</a>		</div>

		<p>@Joel, we are working on providing this and we plan on having this available sometime during fall of this year.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-2291">
				<div id="div-comment-2291" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Luke Latham</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/15/windows-azure-tables-introducing-upsert-and-query-projection/#comment-2291">
			August 20, 2012 at 1:10 am</a>		</div>

		<p>Jai: Nevermind. I just figured it out. One ? though: I tested my batch-upsert code by only specifying serviceContext.SaveChangesWithRetries(Data.Services.Client.SaveChangesOptions.Batch). I read elsewhere that we are supposed to use serviceContext.SaveChangesWithRetries(Data.Services.Client.SaveChangesOptions.ReplaceOnUpdate Or Data.Services.Client.SaveChangesOptions.Batch). Is it ok to submit the batch-upsert to the service context without providing the option for ReplaceOnUpdate? Thanks, Luke</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F15%2Fwindows-azure-tables-introducing-upsert-and-query-projection%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->