---
layout: windowsazurestorage
title: Page Blob Writes in Windows Azure Storage Client Library does not support Streams with non-zero Position
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-44" class="post-44 post type-post status-publish format-standard hentry category-uncategorized tag-issues-fixed tag-windows-azure-blobs-page tag-windows-azure-storage-client-library">

	<header class="entry-header single">
		<h1 class="entry-title">Page Blob Writes in Windows Azure Storage Client Library does not support Streams with non-zero Position</h1>		<div class="rating-wrap">
		<div id="star-rating-44" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="44" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2010-12-17T12:53:00+00:00">December 17, 2010</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/&quot;, &quot;text&quot;: &quot;Page Blob Writes in Windows Azure Storage Client Library does not support Streams with non-zero Position&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/&quot;, &quot;text&quot;: &quot;Page Blob Writes in Windows Azure Storage Client Library does not support Streams with non-zero Position&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p><span style="font-size: medium;"><strong><em>Update 3/09/011:&nbsp; The bug is fixed in the </em></strong></span><a href="http://www.microsoft.com/downloads/en/details.aspx?FamilyID=7a1089b6-4050-4307-86c4-9dadaa5ed018"><span style="font-size: medium;"><strong><em><span style="color: #0066dd;"><span style="font-size: medium;">Windows Azure SDK March 2011 release</span></span></em></strong></span></a><span style="font-size: medium;"><strong><em><span style="font-size: medium;">. <o:p></o:p></span></em></strong></span></p>
<p>The current Windows Azure Storage Client Library does not support passing in a stream to CloudPageBlob.[Begin]WritePages where the stream position is a non-zero value. In such a scenario the Storage Client Library will incorrectly calculate the size of the data range which will cause the server to return HTTP 500: Internal Server Error. This is surfaced to the client via a StorageServerException with the message "Server encountered an internal error. Please try again after some time.&rdquo; </p>
<p>HTTP 500 errors are generally retryable by the client as they relate to an issue on the server side, however in this instance it is the client which is supplying the invalid request. As such this request will be retried by the storage client library N times according to the RetryPolicy specified on the CloudBlobClient (default is 3 retries with an exponential backoff delay). However these requests will not succeed and all subsequent retries will fail with the same error. </p>
<h4>Workarounds</h4>
<p>In the code below I have included a set of extension methods that provide a safe way to invoke [Begin]WritePages which will throw an exception if the source stream is at a non-zero position.&nbsp; You can alter these methods for your specific scenario in case you wish to possibly rewind the stream. Future releases of Storage Client Library will accommodate for this scenario as we continue to expand support for PageBlob at the convenience Layer.</p>
<pre class="code"><span style="color: blue">public static class </span><span style="color: #2b91af">StorageExtensions
</span>{
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Begins an asynchronous operation to write pages to a page blob while enforcing that the stream is at the beginning
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name="pageData"&gt;</span><span style="color: green">A stream providing the page data.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name="startOffset"&gt;</span><span style="color: green">The offset at which to begin writing, in bytes. The offset must be a multiple of 512.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name="callback"&gt;</span><span style="color: green">The callback delegate that will receive notification when the asynchronous operation completes.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name="state"&gt;</span><span style="color: green">A user-defined object that will be passed to the callback delegate.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;returns&gt;</span><span style="color: green">An </span><span style="color: gray">&lt;see cref="IAsyncResult"/&gt; </span><span style="color: green">that references the asynchronous operation.</span><span style="color: gray">&lt;/returns&gt;
    </span><span style="color: blue">public static </span><span style="color: #2b91af">IAsyncResult </span>BeginWritePagesSafe(<span style="color: blue">this </span>CloudPageBlob blobRef, <span style="color: #2b91af">Stream </span>pageData, <span style="color: blue">long </span>startOffset, <span style="color: #2b91af">AsyncCallback </span>callback, <span style="color: blue">object </span>state)
    {1
        <span style="color: blue">if </span>(pageData.Position != 0)
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">"Stream position must be set to zero!"</span>);
        }

        <span style="color: blue">return </span>blobRef.BeginWritePages(pageData, startOffset, callback, state);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Writes pages to a page blob while enforcing that the stream is at the beginning
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name="pageData"&gt;</span><span style="color: green">A stream providing the page data.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name="startOffset"&gt;</span><span style="color: green">The offset at which to begin writing, in bytes. The offset must be a multiple of 512.</span><span style="color: gray">&lt;/param&gt;
    </span><span style="color: blue">public static void </span>WritePagesSafe(<span style="color: blue">this </span>CloudPageBlob blobRef, <span style="color: #2b91af">Stream </span>pageData, <span style="color: blue">long </span>startOffset)
    {
        <span style="color: blue">if </span>(pageData.Position != 0)
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">"Stream position must be set to zero!"</span>);
        }

        blobRef.WritePages(pageData, startOffset, <span style="color: blue">null</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Writes pages to a page blob while enforcing that the stream is at the beginning
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name="pageData"&gt;</span><span style="color: green">A stream providing the page data.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name="startOffset"&gt;</span><span style="color: green">The offset at which to begin writing, in bytes. The offset must be a multiple of 512.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name="options"&gt;</span><span style="color: green">An object that specifies any additional options for the request.</span><span style="color: gray">&lt;/param&gt;
    </span><span style="color: blue">public static void </span>WritePagesSafe(<span style="color: blue">this </span>CloudPageBlob blobRef, <span style="color: #2b91af">Stream </span>pageData, <span style="color: blue">long </span>startOffset, BlobRequestOptions options)
    {
        <span style="color: blue">if </span>(pageData.Position != 0)
        {
            <span style="color: blue">throw new </span><span style="color: #2b91af">InvalidOperationException</span>(<span style="color: #a31515">"Stream position must be set to zero!"</span>);
        }

        blobRef.WritePages(pageData, startOffset, options);
    }
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<h4>Summary</h4>
<p>The current Storage Client Library requires an additional check prior to passing in a Stream to CloudPageBlob.[Begin]WritePages in order to avoid producing an invalid request. Using the code above or applying similar checks at the application level can avoid this issue. Please note that other types of blobs are unaffected by this issue (i.e. CloudBlob.UploadFromStream) and we will be addressing this issue in a future release of the Storage Client Library. </p>
<p>Joe Giardino</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-fixed/" rel="tag">Issues - Fixed</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs-page/" rel="tag">Windows Azure Blobs - Page</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-storage-client-library/" rel="tag">Windows Azure Storage Client Library</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/12/17/page-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F12%2F17%2Fpage-blob-writes-in-windows-azure-storage-client-library-does-not-support-streams-with-non-zero-position%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->