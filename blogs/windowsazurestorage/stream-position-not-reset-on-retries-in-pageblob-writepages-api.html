---
layout: windowsazurestorage
title: Stream Position Not Reset on Retries in PageBlob WritePages API
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-27" class="post-27 post type-post status-publish format-standard hentry category-uncategorized tag-issues-fixed tag-windows-azure-blobs tag-windows-azure-blobs-page">

	<header class="entry-header single">
		<h1 class="entry-title">Stream Position Not Reset on Retries in PageBlob WritePages API</h1>		<div class="rating-wrap">
		<div id="star-rating-27" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="27" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2010-06-14T23:18:00+00:00">June 14, 2010</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/#comments">2</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/&quot;, &quot;text&quot;: &quot;Stream Position Not Reset on Retries in PageBlob WritePages API&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/&quot;, &quot;text&quot;: &quot;Stream Position Not Reset on Retries in PageBlob WritePages API&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>&nbsp;<span style="font-family: 'Calibri','sans-serif'; font-size: 14pt; mso-ascii-theme-font: minor-latin; mso-hansi-theme-font: minor-latin; mso-bidi-theme-font: minor-latin;"><strong><em>The issue is resolved in the Windows Azure SDK&nbsp; 1.3 release which can be downloaded </em></strong><a href="http://msdn.microsoft.com/en-us/windowsazure/cc974146.aspx"><strong><em>here</em></strong></a><strong><em>.<o:p></o:p></em></strong></span></p>
<p>We recently came across a bug in the StorageClient library i<a name="_GoBack"></a>n which <a href="http://msdn.microsoft.com/en-us/library/ee758430.aspx">WritePages</a> fails on retries because the stream is not reset to the beginning before a retry is attempted. This results in the StorageClient reading from incorrect position and hence causing WritePages to fail on retries. </p>
<p>The workaround is to implement a custom retry on which we reset the stream to the start before we invoke WritePages. We have taken note of this bug and it will be fixed in the next release of StorageClient library. Until then, Andrew Edwards, an architect in Storage team, has provided a workaround which can be used to implement WritePages with retries. The workaround saves the selected retry option and sets the retry policy to &ldquo;None&rdquo;. It then implements its own retry mechanism using the policy set. But before issuing a request, it rewinds the stream position to the beginning ensures that WritePages will read from the correct stream position.</p>
<p>This solution should also be used in the VHD upload code provided in blog &ldquo;<a href="http://blogs.msdn.com/b/windowsazurestorage/archive/2010/04/11/using-windows-azure-page-blobs-and-how-to-efficiently-upload-and-download-page-blobs.aspx">Using Windows Azure Page Blobs and How to Efficiently Upload and Download Page Blobs</a>&rdquo;. Please replace pageBlob.WritePages with the call to the below static method to get around the bug mentioned in this post.</p>
<p>Jai Haridas</p>
<p>&nbsp;</p>
<pre class="code"><span style="color: blue">static void </span>WritePages(<span style="color: #2b91af">CloudPageBlob </span>pageBlob, MemoryStream memoryStream, <span style="color: blue">long </span>offset)
{
        <span style="color: #2b91af">CloudBlobClient </span>client = pageBlob.ServiceClient;
        <span style="color: #2b91af">RetryPolicy </span>savedPolicy = client.RetryPolicy;
        client.RetryPolicy = <span style="color: #2b91af">RetryPolicies</span>.NoRetry();

        <span style="color: blue">int </span>retryCount = 0;

        <span style="color: blue">for </span>(;;)
        {
            <span style="color: #2b91af">TimeSpan </span>delay = <span style="color: #2b91af">TimeSpan</span>.FromMilliseconds(-1);

            <span style="color: green">// pageBlob.WritePages doesn't do this for retries
            </span>memoryStream.Seek(0, SeekOrigin.Begin);

            <span style="color: blue">try
            </span>{
                pageBlob.WritePages(memoryStream, offset);
                <span style="color: blue">break</span>;
            }
            <span style="color: blue">catch </span>(<span style="color: #2b91af">TimeoutException </span>e)
            {
                <span style="color: blue">bool </span>shouldRetry = savedPolicy != <span style="color: blue">null </span>? 
                    savedPolicy()(retryCount++, e, <span style="color: blue">out </span>delay) : <span style="color: blue">false</span>;
                <span style="color: blue">if </span>(!shouldRetry)
                {
                    <span style="color: blue">throw</span>;
                }
            }
            <span style="color: blue">catch </span>(<span style="color: #2b91af">StorageServerException </span>e)
            {
                <span style="color: blue">bool </span>shouldRetry = savedPolicy != <span style="color: blue">null </span>? 
                    savedPolicy()(retryCount++, e, <span style="color: blue">out </span>delay) : <span style="color: blue">false</span>;
                <span style="color: blue">if </span>(!shouldRetry)
                {
                    <span style="color: blue">throw</span>;
                }
            }

            <span style="color: blue">if </span>(delay &gt; <span style="color: #2b91af">TimeSpan</span>.Zero)
            {
                System.Threading.<span style="color: #2b91af">Thread</span>.Sleep(delay);
            }
        }

        client.RetryPolicy = savedPolicy;
}</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-fixed/" rel="tag">Issues - Fixed</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs-page/" rel="tag">Windows Azure Blobs - Page</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (2)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F06%2F14%2Fstream-position-not-reset-on-retries-in-pageblob-writepages-api%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-73">
				<div id="div-comment-73" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Chris</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/#comment-73">
			March 14, 2011 at 12:30 pm</a>		</div>

		<p>Now that 1.4 has been released, is this fixed?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F06%2F14%2Fstream-position-not-reset-on-retries-in-pageblob-writepages-api%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-74">
				<div id="div-comment-74" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">jaidevh1@hotmail.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/06/14/stream-position-not-reset-on-retries-in-pageblob-writepages-api/#comment-74">
			March 14, 2011 at 4:24 pm</a>		</div>

		<p>@Chris, Yes this is fixed in sdk 1.4.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F06%2F14%2Fstream-position-not-reset-on-retries-in-pageblob-writepages-api%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->