---
layout: windowsazurestorage
title: WCF Data Service Asynchronous Issue when using Windows Azure Tables from SDK 1.0/1.1
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-26" class="post-26 post type-post status-publish format-standard hentry category-uncategorized tag-issues-fixed tag-windows-azure-tables">

	<header class="entry-header single">
		<h1 class="entry-title">WCF Data Service Asynchronous Issue when using Windows Azure Tables from SDK 1.0/1.1</h1>		<div class="rating-wrap">
		<div id="star-rating-26" class="wds-ratings" data-rating="0" data-userrating="0" data-postid="26" data-container="body" data-toggle="tooltip" title="0 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 0 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2010-05-27T20:28:00+00:00">May 27, 2010</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/&quot;, &quot;text&quot;: &quot;WCF Data Service Asynchronous Issue when using Windows Azure Tables from SDK 1.0/1.1&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/&quot;, &quot;text&quot;: &quot;WCF Data Service Asynchronous Issue when using Windows Azure Tables from SDK 1.0/1.1&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p><p><span style="font-family: 'Calibri','sans-serif'; font-size: 11pt; mso-ascii-theme-font: minor-latin; mso-hansi-theme-font: minor-latin; mso-bidi-theme-font: minor-latin;"></p>
<p class="MsoNormal"><span style="font-family: 'Calibri','sans-serif'; font-size: 14pt; mso-ascii-theme-font: minor-latin; mso-hansi-theme-font: minor-latin; mso-bidi-theme-font: minor-latin;"><strong><em></em></strong></span></p>
<p class="MsoNormal"><span style="font-family: 'Calibri','sans-serif'; font-size: 14pt; mso-ascii-theme-font: minor-latin; mso-hansi-theme-font: minor-latin; mso-bidi-theme-font: minor-latin;"><strong><em>The issue is resolved in the latest version of the Windows Azure SDK which can be downloaded </em></strong><a href="http://msdn.microsoft.com/en-us/windowsazure/cc974146.aspx"><strong><em>here</em></strong></a><strong><em>.<o:p></o:p></em></strong></span></p>
<p>&nbsp;We have received a few reports of problems when using the following APIs in Windows Azure Storage Client Library (WA SCL) for Windows Azure Tables and the following routines:</p>
<p></span></p>
</p>
<ul>
<li>SaveChangesWithRetries, </li>
<li>BeginSaveChangesWithRetries/EndSaveChangesWithRetries, </li>
<li>Using CloudTableQuery to iterate query results or using BeginExecuteSegmented/EndExecutedSegment </li>
<li>BeginSaveChanges/EndSaveChanges in WCF Data Service Client library </li>
<li>BeginExecuteQuery/EndExecuteQuery in WCF Data Service Client library </li>
</ul>
<p>The problems can surface in any one of these forms:</p>
<ul>
<li>Incomplete callbacks in WCF Data Service client library which can lead to 90 second delays </li>
<li>NotSupported Exception &ndash; the stream does not support concurrent IO read or write operations </li>
<li>
<div align="left">System.IndexOutOfRangeException &ndash; probable I/O race condition detected while copying memory</div>
</li>
</ul>
<p>This issue stems from a bug in asynchronous APIs (BeginSaveChanges/EndSaveChanges and BeginExecuteQuery/EndExecuteQuery) provided by WCF Data Service which has been fixed in .NET 4.0 and .NET 3.5 SP1 Update. However, this version of .NET 3.5 is not available in the Guest OS and SDK 1.1 does not support hosting your application in .NET 4.0. </p>
<p>The available options for users to deal with this are:</p>
<ol>
<li>Rather than using the WA SCL Table APIs that provide continuation token handling and retries, use the WCF Data Service synchronous APIs directly until .NET 3.5 SP1 Update is available in the cloud. </li>
<li>As a work around, if the application is fine with dealing with the occasional delay from using the unpatched version of .NET 3.5, the application can look for the StorageClientException with the message &ldquo;Unexpected Internal Storage Client Error&rdquo; and status code &ldquo;HttpStatusCode.Unused&rdquo;. On occurrence of such an exception, the application should dispose of the context that was being used and this context should not be reused for any other operation as recommended in the workaround. </li>
<li>Use the next version of the SDK when it comes out, since it will allow your application to use .NET 4.0 </li>
</ol>
<p>To elaborate a little on option 1, when a CUD operation needs to be performed, one can use the synchronous WCF Data Service API to avoid the problem mentioned above. The following code shows an example:</p>
<pre class="code"><span style="color: #2b91af">CloudTableClient </span>tableClient = <span style="color: blue">new </span><span style="color: #2b91af">CloudTableClient</span>(
account.TableEndpoint.AbsoluteUri, 
account.Credentials);
<span style="color: #2b91af">TableServiceContext </span>context = tableClient.GetDataServiceContext();
<span style="color: green">// Replace context.SaveChangesWithRetries() with the following
</span>context.SaveChanges();</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>The WA SCL handled retries for you and if you use bare bones WCF Data Services client library, you would need to provide your own retry logic. However, our previous posts have examples on how to wrap your own functionality with retry logic and they provide the basic functions for providing retry. To get into the details - you can wrap it with an extension method that implements the retry logic similar to how we added retries to the CreateSnapshot method in the &ldquo;<a href="http://blogs.msdn.com/windowsazurestorage/archive/2010/04/30/protecting-your-blobs-against-application-errors.aspxhttp:/blogs.msdn.com/windowsazurestorage/archive/2010/04/30/protecting-your-blobs-against-application-errors.aspx">Protecting Your Blobs Against Application Errors</a>&rdquo; post. The methods GetStatusCodeFromException and IsExceptionRetryable are generic enough to be used for Tables and the logic of retrying the operation on all &ldquo;retryable&rdquo; errors using the retry strategy is useful to implement your own implementation of extension methods.</p>
<p>For queries, you can enumerate over the IQueryable rather than converting it to CloudTableQuery which uses WCF Data Service&rsquo;s async API. A crucial point to note here is that the application would have to handle continuation tokens and retry each query request. For continuation token handling please refer to the <a href="http://msdn.microsoft.com/en-us/library/dd135718.aspx">Windows Azure Table technical documentation</a> that provides an example. The above mention retry strategy can be used for queries too.</p>
<p>Hope this post helps and as always, please do send feedback our way.</p>
<p>Jai Haridas</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-fixed/" rel="tag">Issues - Fixed</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-tables/" rel="tag">Windows Azure Tables</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2010/05/27/wcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2010%2F05%2F27%2Fwcf-data-service-asynchronous-issue-when-using-windows-azure-tables-from-sdk-1-01-1%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->