---
layout: windowsazurestorage
title: Blob Download Bug in Windows Azure SDK 1.5
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-65" class="post-65 post type-post status-publish format-standard hentry category-uncategorized tag-issues-known tag-windows-azure-blobs tag-windows-azure-storage-client-library">

	<header class="entry-header single">
		<h1 class="entry-title">Blob Download Bug in Windows Azure SDK 1.5</h1>		<div class="rating-wrap">
		<div id="star-rating-65" class="wds-ratings" data-rating="4" data-userrating="0" data-postid="65" data-container="body" data-toggle="tooltip" title="2 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2011-09-27T22:24:37+00:00">September 27, 2011</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/#respond">0</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/&quot;, &quot;text&quot;: &quot;Blob Download Bug in Windows Azure SDK 1.5&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/&quot;, &quot;text&quot;: &quot;Blob Download Bug in Windows Azure SDK 1.5&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p><em><b>Update:</b> We have now released a fix for this issue.&#160; The download blob methods in this version throw an IOException if the connection is closed while downloading the blob, which is the same behavior seen in versions 1.4 and earlier of the StorageClient library.&#160; </em></p>
<p><em>We strongly recommend that users using <b>SDK version 1.5.20830.1814</b> upgrade their applications immediately to this new version <b>1.5.20928.1904</b>.&#160; You can determine if you have the affected version of the SDK by going to <b>Programs and Features</b> in the <b>Control Panel</b> and verify the version of the <b>Windows Azure SDK</b>.&#160; If version 1.5.20830.1814 is installed, please follow these steps to upgrade:</em></p>
<ol>
<li><em>Click “Get Tools &amp; SDK” on the&#160; </em><a href="http://www.microsoft.com/windowsazure/sdk/"><em>Windows Azure SDK download page</em></a><em>.&#160; You <b>do not</b> need to uninstall the previous version first.</em></li>
<li><em>Update your projects to use the copy of Microsoft.WindowsAzure.StorageClient.dll found in C:\Program Files\Windows Azure SDK\v1.5\bin\</em></li>
</ol>
<p>&#160;</p>
<p>We found a<a name="_GoBack"></a> bug in the StorageClient library in Windows Azure SDK 1.5 that impacts the DownloadToStream, DownloadToFile, DownloadText, and DownloadByteArray methods for Windows Azure Blobs.&#160; </p>
<p>If a client is doing a synchronous blob download using the SDK 1.5 and its connection is closed, then the client can get a partial download of the blob. The problem is that the client does not get an exception when the connection is closed, so it thinks the full blob was downloaded.&#160; For example, if the blob was 15MB, and the client downloaded just 1MB and the connection was closed, then the client would only have 1MB (instead of 15MB) and think that it had the whole blob.&#160; Instead, the client should have gotten an exception. The problem only occurs when the connection to the client is closed, and only for synchronous downloads, but not asynchronous downloads.&#160; </p>
<p>The issue was introduced in version 1.5 of the Azure SDK when we changed the synchronous download methods to call the synchronous Read API on the web response stream. We see that once response headers have been received, the synchronous read method on the .NET response stream does not throw an exception when a connection is lost and the blob content has not been fully received yet. Since an exception is not thrown, this results in the Download method behaving as if the entire download has completed and it returns successfully when only partial content has been downloaded.</p>
<p>The problem only occurs when all of the following are true:</p>
<ul>
<li>A synchronous download method is used</li>
<li>At least the response headers are received by the client after which the connection to the client is closed before the entire content is received by the client</li>
</ul>
<p>Notably, one scenario where this can occur is if the request timeout happens after the headers have been received, but before all of the content can be transferred. For example, if the client set the timeout to 30 seconds for download of a 100GB blob, then it’s likely that this problem would occur, because 30 seconds is long enough for the response headers to be received along with part of the blob content, but is not long enough to transfer the full 100GB of content.</p>
<p>This does not impact asynchronous downloads, because asynchronous reads from a response stream throw an IOException when the connection is closed.&#160; In addition, calls to OpenRead() are not affected as they also use the asynchronous read methods. </p>
<p>We will be releasing an SDK hotfix for this soon and apologize for any inconvenience this may have caused. Until then we recommend that customers use SDK 1.4 or the async methods to download blobs in SDK 1.5. Additionally, customers who have already started using SDK 1.5, can work around this issue by doing the following: Replace your DownloadToStream, DownloadToFile, DownloadText, and DownloadByteArray methods with BeginDownloadToStream/EndDownloadToStream. This will ensure that an IOException is thrown if the connection is closed, similar to SDK 1.4. The following is an example showing you how to do that:   </p>
<pre class="code"><span style="color: #2b91af">CloudBlob </span>blob = <span style="color: blue">new </span><span style="color: #2b91af">CloudBlob</span>(uri);
blob.DownloadToStream(myFileStream); <span style="color: green">// WARNING: Can result in partial successful downloads

// NOTE: Use async method to ensure an exception is thrown if connection is 
// closed after partial download
</span>blob.EndDownloadToStream(
blob.BeginDownloadToStream(myFileStream, <span style="color: blue">null </span><span style="color: green">/* callback */</span>, <span style="color: blue">null </span><span style="color: green">/* state */</span>));</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>If you rely on the text/file/byte array versions of download, we have the below extension methods for your convenience, which wraps a stream to work around this problem.<br/>
  </p>
<pre class="code"><span style="color: blue">using </span>System.IO;
<span style="color: blue">using </span>System.Text;
<span style="color: blue">using </span>Microsoft.WindowsAzure.StorageClient;

<span style="color: blue">public static class </span><span style="color: #2b91af">CloudBlobExtensions
</span>{
    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the contents of a blob to a stream.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;target&quot;&gt;</span><span style="color: green">The target stream.</span><span style="color: gray">&lt;/param&gt;
    </span><span style="color: blue">public static void </span>DownloadToStreamSync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, Stream target)
    {
        blob.DownloadToStreamSync(target, <span style="color: blue">null</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the contents of a blob to a stream.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;target&quot;&gt;</span><span style="color: green">The target stream.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name=&quot;options&quot;&gt;</span><span style="color: green">An object that specifies any additional options for the 
    </span><span style="color: gray">/// </span><span style="color: green">request.</span><span style="color: gray">&lt;/param&gt;
    </span><span style="color: blue">public static void </span>DownloadToStreamSync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, Stream target, 
        <span style="color: #2b91af">BlobRequestOptions </span>options)
    {
        blob.EndDownloadToStream(blob.BeginDownloadToStream(target, <span style="color: blue">null</span>, <span style="color: blue">null</span>));
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the blob's contents.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;returns&gt;</span><span style="color: green">The contents of the blob, as a string.</span><span style="color: gray">&lt;/returns&gt;
    </span><span style="color: blue">public static string </span>DownloadTextSync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob)
    {
        <span style="color: blue">return </span>blob.DownloadTextSync(<span style="color: blue">null</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the blob's contents.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;options&quot;&gt;</span><span style="color: green">An object that specifies any additional options for the 
    </span><span style="color: gray">/// </span><span style="color: green">request.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;returns&gt;</span><span style="color: green">The contents of the blob, as a string.</span><span style="color: gray">&lt;/returns&gt;
    </span><span style="color: blue">public static string </span>DownloadTextSync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, <span style="color: #2b91af">BlobRequestOptions </span>options)
    {
        Encoding encoding = Encoding.UTF8;

        <span style="color: blue">byte</span>[] array = blob.DownloadByteArraySync(options);

        <span style="color: blue">return </span>encoding.GetString(array);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the blob's contents to a file.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;fileName&quot;&gt;</span><span style="color: green">The path and file name of the target file.</span><span style="color: gray">&lt;/param&gt;
    </span><span style="color: blue">public static void </span>DownloadToFileSync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, <span style="color: blue">string </span>fileName)
    {
        blob.DownloadToFileSync(fileName, <span style="color: blue">null</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the blob's contents to a file.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;fileName&quot;&gt;</span><span style="color: green">The path and file name of the target file.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;param name=&quot;options&quot;&gt;</span><span style="color: green">An object that specifies any additional options for the 
    </span><span style="color: gray">/// </span><span style="color: green">request.</span><span style="color: gray">&lt;/param&gt;
    </span><span style="color: blue">public static void </span>DownloadToFileSync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, <span style="color: blue">string </span>fileName, 
        <span style="color: #2b91af">BlobRequestOptions </span>options)
    {
        <span style="color: blue">using </span>(<span style="color: blue">var </span>fileStream = File.Create(fileName))
        {
            blob.DownloadToStreamSync(fileStream, options);
        }
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the blob's contents as an array of bytes.
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;returns&gt;</span><span style="color: green">The contents of the blob, as an array of bytes.</span><span style="color: gray">&lt;/returns&gt;
    </span><span style="color: blue">public static byte</span>[] DownloadByteArraySync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob)
    {
        <span style="color: blue">return </span>blob.DownloadByteArraySync(<span style="color: blue">null</span>);
    }

    <span style="color: gray">/// &lt;summary&gt;
    /// </span><span style="color: green">Downloads the blob's contents as an array of bytes. 
    </span><span style="color: gray">/// &lt;/summary&gt;
    /// &lt;param name=&quot;options&quot;&gt;</span><span style="color: green">An object that specifies any additional options for the 
    </span><span style="color: gray">/// </span><span style="color: green">request.</span><span style="color: gray">&lt;/param&gt;
    /// &lt;returns&gt;</span><span style="color: green">The contents of the blob, as an array of bytes.</span><span style="color: gray">&lt;/returns&gt;
    </span><span style="color: blue">public static byte</span>[] DownloadByteArraySync(<span style="color: blue">this </span><span style="color: #2b91af">CloudBlob </span>blob, 
        <span style="color: #2b91af">BlobRequestOptions </span>options)
    {
        <span style="color: blue">using </span>(<span style="color: blue">var </span>memoryStream = <span style="color: blue">new </span>MemoryStream())
        {
            blob.DownloadToStreamSync(memoryStream, options);

            <span style="color: blue">return </span>memoryStream.ToArray();
        }
    }
}</pre>
<p><b>Usage Examples:</b></p>
<pre class="code">blob.DownloadTextSync();
blob.DownloadByteArraySync();
blob.DownloadToFileSync(fileName);</pre>
<p><a href="http://11011.net/software/vspaste"></a></p>
<p>Joe Giardino</p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
					<div class="tags">
				<span>Tags </span>
				<span>
					<a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/issues-known/" rel="tag">Issues - Known</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-blobs/" rel="tag">Windows Azure Blobs</a> <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/tag/windows-azure-storage-client-library/" rel="tag">Windows Azure Storage Client Library</a>				</span>
			</div>
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (0)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2011/09/27/blob-download-bug-in-windows-azure-sdk-1-5/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2011%2F09%2F27%2Fblob-download-bug-in-windows-azure-sdk-1-5%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->