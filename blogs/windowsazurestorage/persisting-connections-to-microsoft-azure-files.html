---
layout: windowsazurestorage
title: Persisting connections to Microsoft Azure Files
weight: 3
---

<div id="site-content" class="site-content row">

	<div id="primary" class="content-area col-sm-9">
		<div id="single-content" class="div-content">

			
				
<article id="post-159" class="post-159 post type-post status-publish format-standard hentry category-uncategorized">

	<header class="entry-header single">
		<h1 class="entry-title">Persisting connections to Microsoft Azure Files</h1>		<div class="rating-wrap">
		<div id="star-rating-159" class="wds-ratings" data-rating="4" data-userrating="0" data-postid="159" data-container="body" data-toggle="tooltip" title="2 user(s) rated">
			<div class="wds-ratings-inner-wrap">
				<div>
					<div aria-label="Select 5 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="5"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span><span aria-hidden="true" class="star-5"><span>&#x2605;</span></span></div><div aria-label="Select 4 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="4"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span><span aria-hidden="true" class="star-4"><span>&#x2605;</span></span></div><div aria-label="Select 3 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="3"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span><span aria-hidden="true" class="star-3"><span>&#x2605;</span></span></div><div aria-label="Select 2 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="2"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span><span aria-hidden="true" class="star-2"><span>&#x2605;</span></span></div><div aria-label="Select 1 star, this article is 4 star rated" tabindex="0" class="wds-ratings-stars wds-ratings-stars-enable-editing" data-stars="1"><span aria-hidden="true" class="star-1"><span>&#x2605;</span></span></div>
				</div>
			</div>
		</div>
		</div>		<div class="clear-both"></div>
		<div class="entry-meta">
			<img alt="avatar of windows-azure-storage" src="https://i1.social.s-msft.com/profile/u/avatar.jpg?displayname=Windows+Azure+Storage&amp;size=extralarge&amp;version=00000000-0000-0000-0000-000000000000" class="avatar avatar-22 photo" height="22" width="22"/><span class="byline"><span class="author vcard"><a class="url fn n profile-usercard-hover" data-profile-userid="59e1aedafa2d4428b7004b2c2fac4adc" href="https://social.msdn.microsoft.com/profile/Windows+Azure+Storage">Windows Azure Storage</a></span></span><span class="posted-on posted-on-margin"><span class="screen-reader-text"></span><time class="entry-date published updated" datetime="2014-05-26T22:00:00+00:00">May 26, 2014</time></span><span class="comments-link"><span class="glyphicon glyphicon-comment" aria-hidden="true"></span><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comments">19</a></span>				<span class="social-icons-wrap">
		<ul class="social-icons">
			<li><div class="fb-share-button" data-href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/" data-layout="button_count" data-size="large" data-mobile-iframe="true"><a class="fb-xfbml-parse-ignore" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/&amp;src=sdkpreparse">Share</a></div></li>
			<div id="fb-root" style="display:none"></div>

			<li class="social-icon twitter"><a data-social="{&quot;type&quot;:&quot;twitter&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/&quot;, &quot;text&quot;: &quot;Persisting connections to Microsoft Azure Files&quot;}" href="#" id="post_tweet_count">0</a></li>
			<li class="social-icon linkedin"><a data-social="{&quot;type&quot;:&quot;linkedin&quot;, &quot;url&quot;:&quot;https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/&quot;, &quot;text&quot;: &quot;Persisting connections to Microsoft Azure Files&quot;}" href="#" id="get_post_linkedin_count">0</a></li>
		</ul>
	</span><!-- .social-icons-wrap -->
	<script type="text/javascript">
		// Get social counts
		jQuery( window ).load(function () {
			jQuery.getScript('https://blogs.msdn.microsoft.com/windowsazurestorage/wp-content/themes/microsoft/js/social-counts.js?ver=02092017')
				.done(function(script,textStatus) {
					window.msdnsocial.ajax('https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/');
				});
		});
	</script>
		</div>
		<hr>
	</header><!-- .entry-header -->

	<div class="entry-content single">
		<p>We recently blogged about our preview release of Azure Storage Files <a target="_blank" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/05/12/introducing-microsoft-azure-file-service.aspx">here</a>. The post contained information on Azure Files, how to get started by applying for preview and explained some tools that we have to help you create the share and transfer data. This post will concentrate on how you can create a persistent connection to an Azure File share so that after a VM reboots, the share will be available for your scheduled tasks, applications, or logged in user.</p>
<h2>Windows IaaS VMs</h2>
<p>By default, Windows attempts to persist connections to SMB shares across reboots. However, it will not automatically persist your Azure Files credentials across reboots, so it will fail to reconnect to an Azure Files share after a reboot. There are several ways to persist these credentials, some of which are detailed below.</p>
<h3>Persisting Credentials</h3>
<h4>CmdKey</h4>
<p>The easiest way to establish a persistent connections is to save your storage account credentials into windows using the “CmdKey” command line utility. The following is an example command line for persisting your storage account credentials into your VM:</p>
<blockquote><p><span style="font-family: Courier New">C:\&gt;cmdkey /add:&lt;yourstorageaccountname&gt;.file.core.windows.net /user:&lt;domainname&gt;\&lt;yourstorageaccountname&gt; /pass:&lt;YourStorageAccountKeyWhichEndsIn==&gt; </span></p></blockquote>
<p><span style="font-family: Courier New">Note: yourstorageaccountname is not your live id but the name in the endpoint. domainname here will be "AZURE"</span></p>
<p>CmdKey will also allow you to list the credentials it stored:</p>
<p><span style="font-family: Courier New">C:\&gt;cmdkey /list </span></p>
<p><span style="font-family: Courier New">Currently stored credentials:</span></p>
<blockquote><p><span style="font-family: Courier New">Target: Domain:target=filedemo.file.core.windows.net<br/>
Type: Domain Password<br/>
User: AZURE\filedemo</span></p></blockquote>
<p>Once the credentials have been persisted, you no longer have to supply them when connecting to your share. Instead you can connect without specifying any credentials:</p>
<blockquote><p><span style="font-family: Courier New">C:\&gt;net use * \\filedemo.file.core.windows.net\demo1 </span></p>
<p><span style="font-family: Courier New">Drive Z: is now connected to \\filedemo.file.core.windows.net\demo1. </span></p>
<p><span style="font-family: Courier New">The command completed successfully. </span></p></blockquote>
<p>Then you can reboot your VM (this will disconnect you from your VM):</p>
<blockquote><p><span style="font-family: Courier New">shutdown –t 0 –r</span></p></blockquote>
<p>When your VM has restarted and you reconnect, you can open up another command window and confirm that your connection has been automatically reconnected:</p>
<p><span style="font-family: Courier New">C:\&gt;net use </span></p>
<p><span style="font-family: Courier New">New connections will be remembered. </span></p>
<p><span style="font-family: Courier New">Status    Local    Remote       Network </span></p>
<p><span style="font-family: Courier New">----------------------------------------------------------------------------- </span></p>
<p><span style="font-family: Courier New">OK        Z:       \\filedemo.file.core.windows.net\demo1 </span></p>
<p><span style="font-family: Courier New">                                Microsoft Windows Network </span></p>
<p><span style="font-family: Courier New">The command completed successfully.</span></p>
<h4>Credential Manager</h4>
<p>The credential manager (located under Control Panel\User Accounts) will also allow you to persist your storage account credentials.</p>
<p><a href="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/8037.image_438DE0EF.png"><img width="885" height="573" title="image" style="padding-top: 0px;padding-left: 0px;padding-right: 0px;border-width: 0px" alt="image" src="https://msdnshared.blob.core.windows.net/media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Blogs.Components.WeblogFiles/00/00/01/36/55/metablogapi/6215.image_thumb_112A0D70.png" border="0"/></a></p>
<h3>User Contexts</h3>
<p>Windows maintains different contexts for each user that is running on a VM, and sometimes it will have different contexts for the same user on the same VM at the same time. Each context can be independently connected to a different set of SMB shares, and each context will have its own drive letter mapping to the shares it is connected to.</p>
<p>The credentials persisted by CmdKey are available to the user who ran “CmdKey”. The connections remembered by “net use” are also available to the user who ran net use. Therefore, if you have an application that runs under a different user name, you may want to persist the credentials and connections for other user’s as well. To do that, you can use the “runas” command:</p>
<blockquote><p><span style="font-family: Courier New">runas /user:&lt;username&gt; cmd.exe </span></p></blockquote>
<p>That command will open a new command window. The title of the command window will read “cmd.exe (running as COMPUTERNAME\username)”. If you run “net use” in that command window, you will notice this user is not connected to any shares:</p>
<blockquote><p><span style="font-family: Courier New">C:\&gt;net use </span></p>
<p><span style="font-family: Courier New">New connections will be remembered. </span></p>
<p><span style="font-family: Courier New">There are no entries in the list.</span></p></blockquote>
<p>You can run “CmdKey” and “net use” as above for that user, and persist both your storage credentials and connections to Azure File for that user.</p>
<h4>Administrator Contexts</h4>
<p>If you create a new local user on your VM, and add that user to the administrators group, then you can run commands for that user in both elevated and non-elevated contexts. Connections are not shared between elevated and non-elevated contexts, so you may want to connect separately in each context by executing “net use”. However, the persisted credentials are shared, so you only need to run “CmdKey” in one of the contexts.</p>
<h4>Handling Scheduled Tasks</h4>
<p>You can create scheduled tasks that run under any user on the VM, and credentials persistent with CmdKey for that user will be available to the schedule tasks. However, those scheduled tasks may run in a different user context than the logged in user, so connections to SMB shares will not be automatically re-connected in the user context that the task is running under.</p>
<p>For example, if you created a schedule task that runs a script that calls “net use” and writes the output to a local file, and that user had previously created a persistent connection to an Azure File share and also had persistent the credentials for that share, the output would contain:</p>
<p><span style="font-family: Courier New">Status      Local    Remote       Network </span></p>
<p><span style="font-family: Courier New">----------------------------------------------------------------------------- </span></p>
<p><span style="font-family: Courier New">Unavailable Z:       \\filedemo.file.core.windows.net\demo1 </span></p>
<p><span style="font-family: Courier New">                                  Microsoft Windows Network </span></p>
<p><span style="font-family: Courier New">The command completed successfully. </span></p>
<p>However, the credentials are available in that context to reconnect to the share, so adding the following command to your script will re-establish the network connection:</p>
<blockquote><p><span style="font-family: Courier New">net use z: </span><span style="font-family: Courier New">\\filedemo.file.core.windows.net\demo1</span></p></blockquote>
<p>Alternatively, the script can access files using the full UNC path rather than the mapped drive letter:</p>
<blockquote><p><span style="font-family: Courier New">dir </span><span style="font-family: Courier New">\\filedemo.file.core.windows.net\demo1</span></p></blockquote>
<p>Also note that since the scheduled task is running in a different context that the logged in user, connections created by the schedule task may not be connected for the context of the logged in user.</p>
<h2>Windows PaaS Roles</h2>
<p>Persistent connections are the opposite of what you want for PaaS roles. For PaaS roles, you need to ensure that your code can connect automatically whether the system has started a fresh instance, or if your instance has just been restart.</p>
<h3>PInvoke WNetAddConnection2</h3>
<p>You can map a drive letter in your PaaS role startup code by pinvoking WNetAddConnection2. The following code declares a set of structures you need to establish a mapping from an Azure Files share to a local drive letter.</p>
<div id="codeSnippetWrapper" style="overflow: auto;cursor: text;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 97.5%;direction: ltr;text-align: left;margin: 20px 0px 10px;line-height: 12pt;background-color: #f4f4f4;border: silver 1px solid;padding: 4px">
<div id="codeSnippet" style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">[DllImport(<span style="color: #006080">"Mpr.dll"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">            EntryPoint = <span style="color: #006080">"WNetAddConnection2"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">            CallingConvention = CallingConvention.Winapi)]</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px"><span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">extern</span> <span style="color: #0000ff">int</span> WNetAddConnection2(NETRESOURCE lpNetResource,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">                                             <span style="color: #0000ff">string</span> lpPassword,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">                                             <span style="color: #0000ff">string</span> lpUsername,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">                                             System.UInt32 dwFlags);</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px"></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">[DllImport(<span style="color: #006080">"Mpr.dll"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">           EntryPoint = <span style="color: #006080">"WNetCancelConnection2"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">           CallingConvention = CallingConvention.Winapi)]</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px"><span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">extern</span> <span style="color: #0000ff">int</span> WNetCancelConnection2(<span style="color: #0000ff">string</span> lpName,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">                                                System.UInt32 dwFlags,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">                                                System.Boolean fForce);</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px"></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">[StructLayout(LayoutKind.Sequential)]</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px"><span style="color: #0000ff">private</span> <span style="color: #0000ff">class</span> NETRESOURCE</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">{</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> dwScope;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> ResourceType dwType;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> dwDisplayType;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">int</span> dwUsage;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> lpLocalName;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> lpRemoteName;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> lpComment;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    <span style="color: #0000ff">public</span> <span style="color: #0000ff">string</span> lpProvider;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">};</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px"></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">enum</span> ResourceType</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">{</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    RESOURCETYPE_DISK = 1,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">};</pre>
<!--CRLF-->
</div>
</div>
<p>Then you can write a method that will mount the share on a given drive letter:</p>
<div id="codeSnippetWrapper" style="overflow: auto;cursor: text;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 97.5%;direction: ltr;text-align: left;margin: 20px 0px 10px;line-height: 12pt;background-color: #f4f4f4;border: silver 1px solid;padding: 4px">
<div id="codeSnippet" style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px"><span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> MountShare(<span style="color: #0000ff">string</span> shareName,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">                              <span style="color: #0000ff">string</span> driveLetterAndColon,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">                              <span style="color: #0000ff">string</span> username,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">                              <span style="color: #0000ff">string</span> password)</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">{</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    <span style="color: #0000ff">if</span> (!String.IsNullOrEmpty(driveLetterAndColon))</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    {</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">        <span style="color: #008000">// Make sure we aren't using this driveLetter for another mapping</span></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">        WNetCancelConnection2(driveLetterAndColon, 0, <span style="color: #0000ff">true</span>);</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    }</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px"></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    NETRESOURCE nr = <span style="color: #0000ff">new</span> NETRESOURCE();</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    nr.dwType = ResourceType.RESOURCETYPE_DISK;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    nr.lpRemoteName = shareName;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    nr.lpLocalName = driveLetterAndColon;</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px"></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    <span style="color: #0000ff">int</span> result = WNetAddConnection2(nr, password, username, 0);</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px"></pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">    <span style="color: #0000ff">if</span> (result != 0)</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    {</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">        <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> Exception(<span style="color: #006080">"WNetAddConnection2 failed with error "</span> + result);</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">    }</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">}</pre>
<!--CRLF-->
</div>
</div>
<p>Then you can call this method from the “OnStart()” method of your role:</p>
<div id="codeSnippetWrapper" style="overflow: auto;cursor: text;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 97.5%;direction: ltr;text-align: left;margin: 20px 0px 10px;line-height: 12pt;background-color: #f4f4f4;border: silver 1px solid;padding: 4px">
<div id="codeSnippet" style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">MountShare(<span style="color: #006080">"\\\\filedemo.file.core.windows.net\\demo1"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">           <span style="color: #006080">"z:"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">           <span style="color: #006080">"filedemo"</span>,</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">           <span style="color: #006080">"&lt;YourStorageAccountKeyWhichEndsIn==&gt;"</span>);</pre>
<!--CRLF-->
</div>
</div>
<p>From that point forward in your worker role, you will be able to read and write files to the Azure File share using either the drive letter, or the full UNC path:</p>
<div id="codeSnippetWrapper" style="overflow: auto;cursor: text;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 97.5%;direction: ltr;text-align: left;margin: 20px 0px 10px;line-height: 12pt;background-color: #f4f4f4;border: silver 1px solid;padding: 4px">
<div id="codeSnippet" style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: white;border-style: none;padding: 0px">File.Create(<span style="color: #006080">"z:\\WNetAddConnection2.txt"</span>);</pre>
<!--CRLF-->
<pre style="overflow: visible;font-size: 8pt;font-family: 'Courier New', courier, monospace;width: 100%;color: black;direction: ltr;text-align: left;margin: 0em;line-height: 12pt;background-color: #f4f4f4;border-style: none;padding: 0px">File.Create(<span style="color: #006080"><a>\\\\filedemo.file.core.windows.net\\demo1\\UNC.txt</a></span>);</pre>
<!--CRLF-->
</div>
</div>
<h3>Web Roles and User Contexts</h3>
<p>The OnStart() method of an Azure Web Role runs in a different user context than is used to render pages of the web site. Therefore, if you want to reference your Azure Files shares from the code that renders the pages, you should put the code from above in your Global.Application_Start() method rather than WebRole.OneStart().</p>
<h2>Linux VM</h2>
<p>Linux has a variety of methods for automatically mounting shares during startup, but we only experimented with one method, and only on Ubuntu 14.04 LTS.</p>
<h4>Persist Connections with Fstab</h4>
<p>Linux has a file called “fstab” in /etc that can be used to mount drives and shares during startup. One way to automatically mount an Azure Files share during boot is to add a line to /etc/fstab. The following text should be placed on a single line in the file:</p>
<blockquote><p><span style="font-family: Courier New">//&lt;yourstorageaccountname&gt;.file.core.windows.net/demo1 /home/azureuser/smb cifs vers=2.1,dir_mode=0777,file_mode=0777,username=<span style="font-family: Courier New">AZURE\</span>&lt;yourstorageaccountname&gt;,password=&lt;YourStorageAccountKeyWhichEndsIn==&gt; </span></p></blockquote>
<p>There are several parts of this line, described below in this table:</p>
<p id="insertStyle">
<script type="text/javascript">// table.xstore{border-collapse:collapse;width:100%;} table.xstore tr:nth-child(odd)	{background-color:#f1f1f1;} table.xstore tr:nth-child(even)	{background-color:#ffffff;} table.xstore {background-color:#ffffff;} table.xstore th{color:#ffffff;background-color:#555555;border:1px solid #555555;padding:3px;vertical-align:top;text-align:left;} table.xstore td{border:1px solid #d4d4d4;padding:5px;padding-top:7px;padding-bottom:7px;vertical-align:top;} \x3C/style&gt;";
// ]]&gt;</script>
<table class="xstore" border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<th width="96" valign="top">Part</th>
<th width="259" valign="top">Example</th>
<th width="269" valign="top">Description</th>
</tr>
<tr>
<td width="96" valign="top">Share URL</td>
<td width="259" valign="top">//filedemo.file.core.windows.net/demo1</td>
<td width="269" valign="top">The URL of an Azure Files share that you previously created</td>
</tr>
<tr>
<td width="96" valign="top">Mount point</td>
<td width="259" valign="top">/home/azureuser/smb</td>
<td width="269" valign="top">The path to an empty directory on your Linux VM that you previously created where you want the share to be mounted.</td>
</tr>
<tr>
<td width="96" valign="top">File system</td>
<td width="259" valign="top">Cifs</td>
<td width="269" valign="top">The type of file system you want to mount. For Azure Files, this will be ‘cifs’.</td>
</tr>
<tr>
<td width="96" valign="top" rowspan="5">Mount Parameters</td>
<td width="259" valign="top">vers=2.1</td>
<td width="269" valign="top">The version of SMB to use, in this case version 2.1</td>
</tr>
<tr>
<td width="259" valign="top">dir_mode=0777</td>
<td width="269" valign="top">The permissions mask used for directories in the Azure Files share, in this case full permissions.</td>
</tr>
<tr>
<td width="259" valign="top">file_mode=0777</td>
<td width="269" valign="top">The permissions mask used for files in the Azure Files share, in this case full permissions.</td>
</tr>
<tr>
<td width="259" valign="top">username=filedemo</td>
<td width="269" valign="top">For Azure Files, this username needs to be you storage account name.</td>
</tr>
<tr>
<td width="259" valign="top">password=StorageAccountKey==</td>
<td width="269" valign="top">For Azure Files, this password needs to be your full storage account key.</td>
</tr>
</tbody>
</table>
<p>There are many other options that can be included in your fstab file. For more information see the relevant document for the Linux distribution you are using.</p>
<h2>Summary</h2>
<p>Our previous <a target="_blank" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/05/12/introducing-microsoft-azure-file-service.aspx">post introduced Azure Files</a> and this post concentrates on steps to help you create persistent connections to Azure File shares so that connections to shares are available after a reboot. As always we would love to hear feedback via comments on this blog, <a target="_blank" href="http://social.msdn.microsoft.com/Forums/windowsazure/en-US/home?forum=windowsazuredata">Azure Storage MSDN forum</a>, or send email to <a target="_blank" href="mailto:mastoragequestions@microsoft.com">mastoragequestions@microsoft.com</a>.</p>
<p>Andrew Edwards</p>
<p>Please see these links for more information:</p>
<p><a target="_blank" href="http://msdn.microsoft.com/en-us/library/azure/dn167006.aspx">Azure Files 2014-04-14 version</a></p>
<p><a target="_blank" href="http://blogs.msdn.com/b/windowsazurestorage/archive/2014/05/12/introducing-microsoft-azure-file-service.aspx">Introducing Microsoft Azure File Service</a></p>
<p><a target="_blank" href="https://aka.ms/azcopy">AzCopy</a></p>
<p><a target="_blank" href="http://go.microsoft.com/fwlink/?LinkID=398183">Azure File PowerShell Cmdlets (CTP)</a></p>
<p><a target="_blank" href="http://www.nuget.org/packages/WindowsAzure.Storage">Storage .NET Client Library 4.0 for 2014-04-14 version</a></p>
	</div><!-- .entry-content -->


	<footer class="entry-footer single">
				<hr>
	</footer><!-- .entry-footer -->

</article><!-- #post-## -->

			
		</div><!-- #single-content -->

		
<div id="comments" class="comments-area">
	<div class="comments-title">
		Comments (19)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#respond" style="display:none;">Cancel reply</a></small></h3><p class="must-log-in">You must be <a href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">logged in</a> to post a comment.</p>	</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-489">
				<div id="div-comment-489" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Dave</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-489">
			July 24, 2014 at 11:02 am</a>		</div>

		<p>Any suggestions on how to do this in a PHP web role in a cloud service. There is no equivalent to Application_Start in php and it&#39;s expensive to check for drive letter and map it all the time?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-490">
				<div id="div-comment-490" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">MPalos</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-490">
			July 24, 2014 at 5:34 pm</a>		</div>

		<p>Keep getting WNetAddConnection2 error 86 for PaaS. We don&#39;t have domains and network users, only could of cloud service instances and would like to have shared file system in between. So, everything that documentation refers afterwards is having some network enabled accounts on PaaS instances ?</p>
<p>Could you please post complete example of persistent connection to file service location? Something of combined example from introduction but that doesn&#39;t rely on usage of net use (since it isn&#39;t persistent).</p>
<p>Thanks</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-495">
				<div id="div-comment-495" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/419b33245887eb453bdf6c8715579628?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/419b33245887eb453bdf6c8715579628?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">serdar.ozler@outlook.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-495">
			July 28, 2014 at 3:05 pm</a>		</div>

		<p>@Dave, as you also mentioned, there is no equivalent of Application_Start in PHP. Therefore, we recommend checking for existence of a file in your Azure Files share and mapping the share to a drive letter if the file cannot be found. It will mount the share only the first time a request comes in and then simply check a file’s existence in all other requests. For example;</p>
<p>&lt;?php</p>
<p>if (!file_exists(&quot;z:\test.php&quot;))</p>
<p>{</p>
<p> &nbsp; system(&quot;net use z: \\account.file.core.windows.net\share /u:account key 2&gt;nul 1&gt;nul&quot;);</p>
<p>}</p>
<p>?&gt;</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-503">
				<div id="div-comment-503" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Corgalore</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-503">
			August 12, 2014 at 6:45 pm</a>		</div>

		<p>Do&nbsp;you think Azure Files would be a viable solution for storing ASP.Net website files that use multiple Azure VMs as IIS front-ends? Will the servers be able to reliably re-connect to the Share in order to serve the content?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-509">
				<div id="div-comment-509" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Regular Guy</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-509">
			August 23, 2014 at 9:09 pm</a>		</div>

		<p>Hi Corgalore, I use Azure Files to create files on Linux virtual machines and make them available via Windows IIS and it works very well. So from my experience, the answer to your question is yes.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-515">
				<div id="div-comment-515" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">spike</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-515">
			September 8, 2014 at 8:56 am</a>		</div>

		<p>I am calling MountShare() from my Global.Application_Start() in my Azure website as you suggest and I am getting &quot;WNetAddConnection2 failed with error 5&quot; &#8211; which I believe is a permissions thing. Is it that the account doesn&#39;t have local admin privileges? How might I go about resolving this?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-516">
				<div id="div-comment-516" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-516">
			September 8, 2014 at 9:16 am</a>		</div>

		<p>Hi Spike,</p>
<p>Mounting an Azure File Share from an Azure Website is not currently supported. &nbsp;Azure File Shares can only be connected to Azure Virtual Machines.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Microsoft Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-523">
				<div id="div-comment-523" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">2nd try</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-523">
			September 12, 2014 at 12:04 pm</a>		</div>

		<p>Is there a cleaner/no-code solution for ASP.NET apps than referencing a Windows API call? I want to be able to deploy an ASP.NET app to two Azure VMs with only a configuration file change (pointing to \uncpath&#8230; in production, c:localfolder on developer PCs). I started with a fresh Windows 2012 VM, a new Azure file service, and a one page ASP.NET app that does File.ReadAllText() from the UNC path of the azure file service. Cmdkey saved credentials successfully and I could access the share interactively, either as my app pool account with runas or the local admin account. However, ASP.NET can never connect to the UNC path (&quot;user name or password is incorrect&quot;). I&#39;ve tried running the app pool as local Administrator, granting rights under local policies, using mklink to create a symbolic link &#8211; nothing works and it&#39;s frustrating. What I did get to work was WNetAddConnection2 in the global.asax, but this seems like a dirty hack. I&#39;m using all Microsoft technology, would like to see a solution in IIS or even native code. The Azure file service only gets me about 90% of where I need to be. Can we specify credentials on the file share or have a setting for no authentication from designated VM IPs?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-526">
				<div id="div-comment-526" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-526">
			September 15, 2014 at 12:28 pm</a>		</div>

		<p>Hi &quot;2nd try&quot;,</p>
<p>ASP.NET web pages run under the &quot;Network Service&quot; context, so you need to run &quot;cmdkey&quot; or &quot;net use&quot; under that context. &nbsp;As mentioned above, one way to do that is by running from global.asax. &nbsp;Another way is to use psexec (<a rel="nofollow" target="_new" href="http://technet.microsoft.com/en-us/sysinternals/bb897553.aspx">technet.microsoft.com/&#8230;/bb897553.aspx</a>) and run &quot;net use&quot; from a startup script:</p>
<p> &nbsp; &nbsp;psexec.exe -accepteula -u &quot;NT AUTHORITYNETWORK SERVICE&quot; net use z: \act.file.core.windows.nettest /u:act key==</p>
<p> &nbsp; &nbsp;echo &quot;done&quot;</p>
<p>(Note the call to echo after psexec. &nbsp;For your role to start successfully, the last command in the script must return &#39;0&#39;)</p>
<p>You also need to add the startup script to your ServiceDefinition.csdef:</p>
<p> &nbsp; &nbsp;&lt;Startup&gt;</p>
<p> &nbsp; &nbsp; &nbsp;&lt;Task commandLine=&quot;Startup.cmd&quot; executionContext=&quot;elevated&quot; taskType=&quot;simple&quot;/&gt;</p>
<p> &nbsp; &nbsp;&lt;/Startup&gt;</p>
<p>And add both &quot;psexec.exe&quot; and &quot;startup.cmd&quot; to your webrole&#39;s bin directory.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Microsoft Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-528">
				<div id="div-comment-528" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">2nd try</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-528">
			September 16, 2014 at 9:44 am</a>		</div>

		<p>I ended up creating an account with the user name of the Azure file account and key as the password. What led me down that path was the need for a virtual directory pointing to some static files on the shared drive. Creating a local account on the VM with same name as the Azure file account allowed me to do a &quot;Connect As..&quot; when setting up the virtual directory in IIS. As it turns out setting that account as the app pool identity seems to allow access for the ASP.NET app as well. Thanks again for the feedback. Through scouring blogs like this one I&#39;ve been able to set up a 2VM scenario with SQL Azure as the back end and shared session/file access.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-534">
				<div id="div-comment-534" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">access shared azure files mapping with php running on IIS VM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-534">
			September 24, 2014 at 2:16 am</a>		</div>

		<p>I spend a lot of time trying to make my shared folder accessible to PHP running on my VM with IIS.</p>
<p>I finally figured it out and think it might be usefull to share my solution.</p>
<p>1) create a windows user &nbsp; and affect it to IUSR group. lets call it azureIISUser</p>
<p>2) open &nbsp;powershell console and execute the following script: like explained above in &quot;user context&quot;</p>
<p>&nbsp; &nbsp; &nbsp;a) &nbsp;runas /user:&lt;SERVERNAME&gt;azureIISUser cmd.exe ( replace &lt;SERVERNAME&gt; with the name of your server)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; That command will open a new DOS console running under the azureIISUser user.</p>
<p>&nbsp; &nbsp; &nbsp; b)in the DOS console, execute the following script:( if you have not already registered the shared credential)</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;cmdkey /add:&lt;yourstorageaccountname&gt;.file.core.windows.net /user:&lt;yourstorageaccountname&gt; /pass:&lt;YourStorageAccountKeyWhichEndsIn==&gt;</p>
<p>&nbsp; &nbsp; &nbsp;c) Then map a drive to the shared folder for the new user (here &#39;azureIISUser&#39;)</p>
<p>In the DOS console : net use z: \&lt;yourstorageaccountname&gt;.file.core.windows.net&lt;sharedfolder&gt;</p>
<p>3) &nbsp;Set Up IIS to use the new user:</p>
<p>&nbsp; &nbsp;open IIS, select the site that need access to the mapped shared</p>
<p>&nbsp; &nbsp;a) edit Authentification settings: Authentification settings -&gt; anonymous authentification -&gt;edit-&gt;select aplication pool identity</p>
<p>&nbsp; &nbsp;b) You can now affect the new user to the application pool used by the site. If you affect the user to the application pool without changing the setting of anonymous acces, the site will keep running under IUSER and will not have access to the shared folder.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-535">
				<div id="div-comment-535" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Nazik Huq</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-535">
			October 3, 2014 at 8:58 am</a>		</div>

		<p>What are the performance implications of having all shares under one storage account versus creating one share/storage account in pairs? </p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-536">
				<div id="div-comment-536" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/7baef01f55b96f7ef6e7d2270e0b7ec6?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">jaidevh1@hotmail.com</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-536">
			October 3, 2014 at 10:16 pm</a>		</div>

		<p>@Naziq, It is better to have multiple shares under single storage account and there is no perf implications. However, please ensure that your ingress/egress and request/sec is within the limits of a single storage account (see <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/azure/dn249410.aspx">msdn.microsoft.com/&#8230;/dn249410.aspx</a>) and use multiple storage accounts if you need to scale beyond the limits. </p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-587">
				<div id="div-comment-587" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Vladimir</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-587">
			January 14, 2015 at 1:45 pm</a>		</div>

		<p>Is it possible to create syspreped image which will have file share automatically mounted when new VMs are created from it?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-588">
				<div id="div-comment-588" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Andrew Edwards</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-588">
			January 14, 2015 at 2:15 pm</a>		</div>

		<p>Hi Vladimir,</p>
<p>Connections to Azure Files are per user, not per VM. &nbsp;So you can&#39;t create a sysprep&#39;d image with a shre automatically mounted. &nbsp;Instead, you should have your service/application mount the share from the user context in which it runs or will run.</p>
<p>Thanks</p>
<p>Andrew Edwards</p>
<p>Microsoft Azure Storage</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-28">
				<div id="div-comment-28" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Vladimir</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-28">
			January 15, 2015 at 12:21 pm</a>		</div>

		<p>@Andrew Edwards thanks for your answer.</p>
<p>It would be nice if I could sysprep the image with the script which would mount the file share automatically. So when I create a VM out of that image, file share is automatically available. I could put a net use line in a script.</p>
<p>But I&#39;m not sure if setting up a script which would execute at Windows Startup (like a Windows service?) is possible? If we talk about syspreped image.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-803">
				<div id="div-comment-803" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/0a7af958dea0b327acee1a19a5399a0f?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/0a7af958dea0b327acee1a19a5399a0f?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">developerBillCooper</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-803">
			March 6, 2015 at 4:30 am</a>		</div>

		<p>Storage Team &#8211; I need some help. &nbsp;I have been using azure files preview for several months and it really fits our use case well. &nbsp;But I am experiencing a major roadblock that is preventing us from fully adopting a solution that would include azure files.</p>
<p>We are mounting Azure File shares from Azure Ubuntu 14.04 LTS VMs and all is fine &#8211; for a while. &nbsp;We have found that the share connection fails after some unknown amount of time. &nbsp;A reboot always fixes the problem. &nbsp;I have tried to troubleshoot this on my own, but have not been able to pinpoint the exact issue. &nbsp;I&#39;m not sure if the problem is Ubuntu, cifs, networking, &#8230; </p>
<p>This issue is very consistent. &nbsp;A have previsioned several Azure Ubuntu 14.04 LTS VMs each mounted to a different share on the same storage account, and they all eventually fail in this way.</p>
<p>Azure files is a great feature, and is exactly what we are looking for, but this issue has me very concerned about going forward on a large scale. &nbsp;Please help.</p>
<p>This is what I am seeing in /var/log/kern.log:</p>
<p>Mar &nbsp;4 23:50:42 &lt;MY-VM&gt; kernel: [1751285.617707] CIFS VFS: Server &lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.net has not responded in 120 seconds. Reconnecting&#8230;</p>
<p>Mar &nbsp;5 02:07:56 &lt;MY-VM&gt; kernel: [1759519.155512] CIFS VFS: Server &lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.net has not responded in 120 seconds. Reconnecting&#8230;</p>
<p>Mar &nbsp;5 05:28:07 &lt;MY-VM&gt; kernel: [1771530.473580] CIFS VFS: Server &lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.net has not responded in 120 seconds. Reconnecting&#8230;</p>
<p>Running the command cat /proc/fs/cifs/DebugData gives the following result:</p>
<p>CIFS Version 2.02</p>
<p>Features: dfs fscache lanman posix spnego xattr acl</p>
<p>Active VFS Requests: 0</p>
<p>Servers:</p>
<p>1) entry for &lt;MY-STORAGE-ACCOUNT-IP&gt; not fully displayed</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;TCP status: 4</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Local Users To Server: 1 SecMode: 0x3 Req On Wire: 0</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Shares:</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;1) \&lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.netssd Mounts: 1 DevInfo: 0x20 Attributes: 0x6</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;PathComponentMax: 255 Status: 0x1 type: DISK &nbsp; &nbsp;DISCONNECTED</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;MIDs:</p>
<p>2) entry for &lt;MY-STORAGE-ACCOUNT-IP&gt; not fully displayed</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;TCP status: 4</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Local Users To Server: 1 SecMode: 0x3 Req On Wire: 0</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Shares:</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;1) \&lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.netssd Mounts: 1 DevInfo: 0x20 Attributes: 0x6</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;PathComponentMax: 255 Status: 0x1 type: DISK &nbsp; &nbsp;DISCONNECTED</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;MIDs:</p>
<p>3) entry for &lt;MY-STORAGE-ACCOUNT-IP&gt; not fully displayed</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;TCP status: 4</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Local Users To Server: 1 SecMode: 0x3 Req On Wire: 0</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Shares:</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;1) \&lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.netssd Mounts: 1 DevInfo: 0x20 Attributes: 0x6</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;PathComponentMax: 255 Status: 0x1 type: DISK &nbsp; &nbsp;DISCONNECTED</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;MIDs:</p>
<p>4) entry for &lt;MY-STORAGE-ACCOUNT-IP&gt; not fully displayed</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;TCP status: 4</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Local Users To Server: 1 SecMode: 0x3 Req On Wire: 0</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Shares:</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;1) \&lt;MY-STORAGE-ACCOUNT&gt;.file.core.windows.netssd Mounts: 1 DevInfo: 0x20 Attributes: 0x6</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;PathComponentMax: 255 Status: 0x1 type: DISK &nbsp; &nbsp;DISCONNECTED</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;MIDs:</p>
<p>&#8230;.</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-853">
				<div id="div-comment-853" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">Atul - MSFT</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-853">
			March 16, 2015 at 1:15 pm</a>		</div>

		<p>developerBillCooper, we will need to look into the account in more detail to see what is going on. Can you send some details in a separate email to ascl @ microsoft.com? We will need the following details:</p>
<p>1. Storage account name (do NOT send the storage account key)</p>
<p>2. Time when you saw the connection drop (I cant tell the timezone from your logs below)</p>
<p>Thanks,</p>
<p>Atul</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1501">
				<div id="div-comment-1501" class="comment-body">
				<div class="comment-author vcard">
			<img alt="" src="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=56&amp;d=mm&amp;r=g" srcset="https://secure.gravatar.com/avatar/3651e719491c63d4424134d66fe53db9?s=112&amp;d=mm&amp;r=g 2x" class="avatar avatar-56 photo" height="56" width="56"/>			<cite class="fn">JMarcus</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/windowsazurestorage/2014/05/26/persisting-connections-to-microsoft-azure-files/#comment-1501">
			July 23, 2015 at 1:41 pm</a>		</div>

		<p>Are there plans to allow access to Azure File shares from Azure WebApps any time soon?</p>

		<div class="reply"><a rel="nofollow" class="comment-reply-login" href="https://blogs.msdn.microsoft.com/windowsazurestorage/wp-login.php?redirect_to=https%3A%2F%2Fblogs.msdn.microsoft.com%2Fwindowsazurestorage%2F2014%2F05%2F26%2Fpersisting-connections-to-microsoft-azure-files%2F">Log in to Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
	
</div><!-- .comments-area -->
	</div><!-- #primary -->