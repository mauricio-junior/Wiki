---
layout: default
title: Test Lab Guide&#58; Demonstrate NAP for Remote Access VPN - TechNet Articles - United States (English) - TechNet Wiki
weight: 3
---

<div class="post-content user-defined-markup">

<div class="table-of-contents"><h2 class="title">Table of Contents</h2><div class="hierarchy-list-header"> </div><ul class="hierarchy-list"><li class="hierarchy-item"><a href="#Step_1_Base_Configuration_test_lab">Step 1: Base Configuration test lab</a></li><li class="hierarchy-item"><a href="#Step_2_Remote_Access_VPN_test_lab">Step 2: Remote Access VPN test lab</a></li><li class="hierarchy-itr4 fiji-r4"></div></div></div></div>
<div clem"><a href="#Step_3_Set_up_DC1_as_the_NAP_Health_Policy_Server">Step 3: Set up DC1 as the NAP Health Policy Server</a></li><li class="hierarchy-item"><a href="#Step_4_Configure_EDGE1_as_a_RADIUS_Client">Step 4: Configure EDGE1 as a RADIUS Client</a></li><li class="hierarchy-item"><a href="#Step_5_Demonstrate_NAP_client_behavior_on_CLIENT1">Step 5: Demonstrate NAP client behavior on CLIENT1</a></li><li class="hierarchy-item"><a href="#Step_6_Demonstrate_NAP_Enforcement_Behavior">Step 6: Demonstrate NAP Enforcement Behavior</a></li></ul><div class="hierarchy-list-footer"> </div></div><br />
<br />
<h2 style="margin:10pt 0in 0pt;"><a name="Step_1_Base_Configuration_test_lab"></a><span style="font-family:cambria;font-size:18px;color:#4f81bd;">Step 1: Base Configuration test lab</span></h2>
<p style="margin:0in 0in 10pt;"><span style="font-family:calibri;">Set up the base configuration test lab with the instructions found in
</span><a href="http://go.microsoft.com/fwlink/?LinkId=198140"><span style="font-family:calibri;color:#0066dd;">Base Configuration TLG</span></a><span style="line-height:115%;font-size:9pt;font-family:&#39;segoe ui&#39;,sans-serif;color:#333333;">.</span></p>
<h2 style="margin:10pt 0in 0pt;"><a name="Step_2_Remote_Access_VPN_test_lab"></a><span style="font-family:cambria;font-size:18px;color:#4f81bd;">Step 2: Remote Access VPN test lab</span></h2>
<p style="margin:0in 0in 10pt;"><span style="font-family:calibri;">Set up the remote access VPN test lab with the instructions found in
</span><a href="http://social.technet.microsoft.com/wiki/contents/articles/test-lab-guide-demonstrate-remote-access-vpns.aspx"><span style="font-family:calibri;">Test Lab Guide: Demonstrate Remote Access VPNs</span></a><span style="line-height:115%;font-size:9pt;font-family:&#39;segoe ui&#39;,sans-serif;color:#333333;">.</span></p>
<h2 style="margin:10pt 0in 0pt;"><a name="Step_3_Set_up_DC1_as_the_NAP_Health_Policy_Server"></a><span style="font-family:cambria;font-size:18px;color:#4f81bd;">Step 3: Set up DC1 as the NAP Health Policy Server</span></h2>
<ol>
<li><span style="font-family:calibri;">On DC1, in Server Manager, under <span class="UI">
<strong>Roles Summary</strong></span>, click <span class="UI"><strong>Add Roles</strong></span>, and then click
<span class="UI"><strong>Next</strong></span>.</span> </li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Select Server Roles</strong></span> page, select the
<span class="UI"><strong>Network Policy and Access Services</strong></span> check box, and then click
<span class="UI"><strong>Next</strong></span> twice.</span> </li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Select Role Services</strong></span> page, select
<strong>Network Policy Server</strong>, and then click <span class="UI"><strong>Next</strong></span>.</span>
</li><li><span style="font-family:calibri;">On the <strong>Confirm Installation Selections</strong> page, click
<strong>Install</strong>.</span> </li><li><span style="font-family:calibri;">Verify that all installations were successful, and then click
<span class="UI"><strong>Close</strong></span>.</span> </li><li><span style="font-family:calibri;">Click <span class="UI"><strong>Start</strong></span>, type
<span class="UserInputNon-localizable"><strong>nps.msc</strong></span>, and then press ENTER.</span>
</li><li><span style="font-family:calibri;">In the details pane, under <span class="UI">
<strong>Standard Configuration</strong></span>, click <span class="UI"><strong>Configure NAP</strong></span>.</span>
</li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Select Network Connection Method for Use with NAP</strong></span> page, under
<span class="UI"><strong>Network connection method</strong></span>, select <span class="UI">
<strong>Virtual private network (VPN)</strong></span>, and then click <span class="UI">
<strong>Next</strong></span>.</span> </li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Specify NAP Enforcement Servers Running VPN Server</strong></span> page, click
<span class="UI"><strong>Add</strong></span>. </span></li><li><span style="font-family:calibri;">In <strong>Friendly name</strong>, type <strong>
EDGE1</strong>, in <strong>Address</strong>, type <strong>10.0.0.2</strong>, in <strong>
Shared secret</strong>, type <strong>secret</strong> in <strong>Shared secret</strong> and
<strong>Confirm shared secret</strong>, click <strong>OK</strong>, and then click
<strong>Next</strong>. </span></li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Configure User Groups and Machine Groups</strong></span> page, click
<span class="UI"><strong>Next</strong></span>. You do not need to configure groups for this test lab.</span>
</li><li><span style="font-family:calibri;">On the <strong>Configure an Authentication Method</strong> page, click
<strong>Next</strong>.</span> </li><li><span style="font-family:calibri;">On the <strong>Specify a NAP Remediation Server Group URL</strong> page, click
<strong>New Group</strong>. </span></li><li><span style="font-family:calibri;">In Group Name, type <strong>DCs</strong>, and then click
<strong>Add</strong>.</span> </li><li><span style="font-family:calibri;">In <strong>Friendly name</strong>, type <strong>
DC1,</strong> in <strong>IP address or DNS</strong>, type <strong>10.0.0.1</strong>. Click
<strong>Resolve</strong>, click <strong>OK</strong> twice, and then click <strong>
Next</strong>. </span></li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Define NAP Health Policy</strong></span> page, verify that
<span class="UI"><strong>Windows Security Health Validator</strong></span> and <span class="UI">
<strong>Enable auto-remediation of client computers</strong></span> check boxes are selected, and then click
<span class="UI"><strong>Next</strong></span>.</span> </li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Completing NAP Enforcement Policy and RADIUS Client Configuration</strong></span> page, click
<span class="UI"><strong>Finish</strong></span>.</span> </li><li><span style="font-family:calibri;">In the Network Policy Server console tree, open
<span class="UI"><strong>Network Access Protection<ly name</strong>, type <strong>
DC1,</strong> in <strong>IP address or DNS</strong>, type <strong>10.0.0.1</strong>. Click
<strong>Resolve</strong>, click <strong>OK</strong> twice, and then click <strong>
Next</strong>. </span></li><li><span style="font-family:calibri;">On the <span class="UI"><strong>Define NAP Health Policy</strong></span> page, verify that
<span class="UI"><strong>Windows Security Health Validator</strong></span> and <span class="UI">
<strong>Enable auto-remediation of client computers</strong></span> check boxes are selected, and then click
<span class="UI"><strong>Next</strong></span>.</span> </li><li><span style="font-family:calib/strong></span>\<span class="UI"><strong>System Health Validators\Windows Security Health Validator</strong></span><span class="UI"><span style="font-weight:normal;">, and then click
</span><strong>Settings</strong></span>.</span> </li><li><span style="font-family:calibri;">In the details pane, double-click <strong>Default Configuration</strong>.</span>
</li><li><span style="font-family:calibri;">In the <strong>Windows Security Health Validator</strong> window, for the
<strong>Windows 7/Windows Vista</strong> tab, clear all check boxes except <span class="UI">
<strong>A firewall is enabled for all network connections</strong></span>, and then click
<strong>OK</strong>.</span> </li><li><span style="font-family:calibri;">Click <strong>Start</strong>, point to <strong>
Administrative Tools</strong>, and then click <strong>Active Directory Users and Computers</strong>.</span>
</li><li><span style="font-family:calibri;">In the Active Directory Users and Computers console tree, right-click
<span class="UI"><strong>Contoso.com</strong></span>, point to <span class="UI"><strong>New</strong></span>, and then click
<span class="UI"><strong>Group</strong></span>.</span> </li><li><span style="font-family:calibri;">In the <span class="UI"><strong>New Object - Group</strong></span> dialog box, under
<span class="UI"><strong>Group name</strong></span>, type <span class="UserInputNon-localizable">
<strong>NAP client computers</strong></span>.</span> </li><li><span style="font-family:calibri;">Under <span class="UI"><strong>Group scope</strong></span>, choose
<span class="UI"><strong>Global</strong></span>, under <span class="UI"><strong>Group type</strong></span>, choose
<span class="UI"><strong>Security</strong></span>, and then click <span class="UI">
<strong>OK</strong></span>.</span> </li><li><span style="font-family:calibri;">In the list, double-click the <strong>NAP client computers</strong> group.</span>
</li><li><span style="font-family:calibri;">Click the <strong>Members</strong> tab, click
<strong>Add</strong>, click <strong>Object Types</strong>, select <strong>Computers</strong>, click
<strong>OK</strong>, type <strong>CLIENT1</strong>, and then click <strong>OK</strong> twice.</span>
</li><li><span style="font-family:calibri;">Click <span class="UI"><strong>Start</strong></span>, type
<span class="UserInputNon-localizable"><strong>gpme.msc</strong></span>, and then press ENTER.</span>
</li><li><span style="font-family:calibri;">Click the icon to create a new GPO, then type
<span class="UserInputNon-localizable"><strong>NAP client settings</strong></span> for the name of the new GPO.
</span></li><li><span style="font-family:calibri;">Right-click <span class="UserInputNon-localizable">
<strong>NAP client settings</strong></span><span class="UserInputNon-localizable"><span style="font-weight:normal;">, and then click
</span><strong>Edit</strong></span><span class="UserInputNon-localizable" style="font-weight:normal;">.</span></span>
</li><li><span style="font-family:calibri;">In the console tree of Group Policy Management Editor, open
<span class="UI"><strong>Computer Configuration\Policies\Windows Settings\Security Settings</strong></span><span class="UI"><span style="font-weight:normal;">, and then click
</span><strong>System Services</strong></span>.</span> </li><li><span style="font-family:calibri;">In the details pane, double-click <span class="UI">
<strong>Network Access Protection Agent</strong></span>.</span> </li><li><span style="font-family:calibri;">In the <span class="UI"><strong>Network Access Protection Agent Properties</strong></span> dialog box, select
<span class="UI"><strong>Define this policy setting</strong></span>, click <span class="UI">
<strong>Automatic</strong></span>, and then click <span class="UI"><strong>OK</strong></span>.</span>
</li><li><span style="font-family:calibri;">In the console tree, open <span class="UI">
<strong>Computer Configuration\Policies\Windows Settings\Security Settings\Network Access Protection\NAP Client Configuration</strong></span><span class="UI"><span style="font-weight:normal;">, and then click
</span><strong>Enforcement Clients</strong></span>.</span> </li><li><span style="font-family:calibri;">In the details pane, right-click <span class="UI">
<strong>EAP Quarantine Enforcement Client</strong></span>, and then click <span class="UI">
<strong>Enable</strong></span>.</span> </li><li><span style="font-family:calibri;">In the console tree, open <span class="UI">
<strong>Computer Configuration\Policies\Administrative Templates\Windows Components</strong></span><span class="UI"><span style="font-weight:normal;">, and then click
</span><strong>Security Center</strong></span>.</span> </li><li><span style="font-family:calibri;">In the details pane, double-click <span class="UI">
<strong>Turn on Security Center (Domain PCs only)</strong></span>, click <span class="UI">
<strong>Enabled</strong></span>, and then click <span class="UI"><strong>OK</strong></span>. This enables the Windows Action Center on NAP client computers.</span>
</li><li><span style="font-family:calibri;">Click <span class="UI"><strong>Start</strong></span>, type
<span class="UserInputNon-localizable"><strong>gpmc.msc</strong></span>, and then press ENTER.</span>
</li><li><span style="font-family:calibri;">In the tree, click <strong>NAP client settings</strong>.</span>
</li><li><span style="font-family:calibri;">In the details pane, under <span class="UI">
<strong>Security Filtering</strong></span>, click <span class="UI"><strong>Authenticated Users</strong></span>, and then click
<span class="UI"><strong>Remove</strong></span>.</span> </li><li><span style="font-family:calibri;">When you are prompted to confirm the removal of delegation privilege, click
<span class="UI"><strong>OK</strong></span>.</span> </li><li><span style="font-family:calibri;">In the details pane, under <span class="UI">
<strong>Security Filtering</strong></span>, click <span class="UI"><strong>Add</strong></span>.</span>
</li><li><span style="font-family:calibri;">In the <span class="UI"><strong>Select User, Computer, or Group</strong></span> dialog box, under
<span class="UI"><strong>Enter the object name to select (examples)</strong></span>, type
<span class="UserInputNon-localizable"><strong>NAP client computers</strong></span>, and then click
<span class="UI"><strong>OK</strong></span>.</span> </li></ol>
<br />
<h2 style="margin:10pt 0in 0pt;"><a name="Step_4_Configure_EDGE1_as_a_RADIUS_Client"></a><span style="font-family:cambria;font-size:18px;color:#4f81bd;">Step 4: Configure EDGE1 as a RADIUS Client</span></h2>
<ol>
<li><span style="font-family:calibri;">On EDGE1, click <strong>Start</strong>, point to
<strong>Administrative Tools</strong>, and then click <strong>Routing and Remote Access</strong>.</span>
</li><li><span style="font-family:calibri;">In the tree, right-click <strong>EDGE1</strong>, and then click
<strong>Properties</strong>.</span> </li><li><span style="font-family:calibri;">Click the <strong>Security</strong> tab, in
<strong>Authentication provider</strong>, click <strong>RADIUS Authentication</strong>, and then click
<strong>Configure</strong>.</span> </li><li><span style="font-family:calibri;">In RADIUS Authentication, click <strong>Add</strong>, type
<strong>10.0.0.1</strong> in Server name, and then click <strong>Change</strong>.</span>
</li><li><span style="font-family:calibri;">In Change Secret, type <strong>secret</strong> in
<strong>New secret</strong>, type <strong>secret</strong> in <strong>Confirm new secret</strong>, and then click
<strong>OK</strong> four times.</span> </li></ol>
<br />
<h2 style="margin:10pt 0in 0pt;"><a name="Step_5_Demonstrate_NAP_client_behavior_on_CLIENT1"></a><span style="font-family:cambria;font-size:18px;color:#4f81bd;">Step 5: Demonstrate NAP client behavior on CLIENT1</span></h2>
<ol>
<li><span style="font-family:calibri;">Connect CLIENT1 to the Corpnet subnet.</span>
</li><li><span style="font-family:calibri;">Click <strong>Start</strong>, click <strong>
All Programs</strong>, click <strong>Accessories</strong>, right-click <strong>Command Prompt</strong>, and then click
<strong>Run as administrator</strong>. Click <strong>Yes</strong> at the <strong>
User Account Control</strong> prompt.</span> </li><li><span style="font-family:calibri;">In the command prompt window, run the <strong>
gpupdate /target:computer</strong> command.</span> </li><li><span style="font-family:calibri;">In the command prompt window, run the <strong>
netsh nap client show grouppolicy</strong> command. In <strong>Enforcement clients</strong>,
<strong>EAP Quarantine Enforcement Client</strong> should be set to <strong>Enabled</strong>.</span>
</li><li><span style="font-family:calibri;">Connect CLIENT to the Internet subnet.</span>
</li><li><span style="font-family:calibri;">On CLIENT1, click the network icon in the notification area, and then click
<strong>Open Network and Sharing Center</strong>.</span> </li><li><span style="font-family:calibri;">In the Network and Sharing Center, click <strong>
Change adapter settings</strong>.</span> </li><li><span style="font-family:calibri;">In Network Connections, right-click <strong>
VPN Connection</strong>, and then click <strong>Properties</strong>. </span></li><li><span style="font-family:calibri;">Click the <strong>Security</strong> tab, in
<strong>Authentication</strong>, click <strong>Use Extensible Authentication Protocol (EAP)</strong>, in the drop-down list, click
<strong>Microsoft: Protected EAP (PEAP)</strong>, and then click <strong>Properties</strong>.</span>
</li><li><span style="font-family:calibri;">In Protected EAP Properties, select <strong>
Connect to these servers</strong> and type <strong>dc1.corp.contoso.com</strong>,&nbsp;select
<strong>corp-DC1-CA</strong> <span style="font-family:calibri;">in Trusted Root Certification Authorities</span>, select
<strong>Enforce Network Access Protection</strongr</strong>.</span> </li><li><span style="font-family:calibri;">In the Network and Sharing Center, click <strong>
Change adapter settings</strong>.</span> </li><li><span style="font-family:calibri;">In Network Connections, right-click <strong>
VPN Connection</strong>, and then click <strong>Properties</strong>. </span></li><li><span style="font-family:calibri;">Click the <strong>Security</strong> tab, in
<strong>Authentication</strong>, click <strong>Use Extensible Authentication Protocol (EAP)</strong>, in the drop-down list, click
<strong>Microsoft: Protected EAP (PEAP)</strong>, and then click <strong>Properties</strong>.</span>
</li><li><span style="font-family:calibri;">In Protected EAP Properties, select <strong>
Connect to these servers</strong> and type <strong>dc1.corp.contoso.com</strong>,&nbsp;select
<strong>corp-DC1-CA</strong> <span style="font-family:calibri;">in Trusted Root Certification Authorities</span>, selec>, and then click <strong>OK</strong> twice.</span>
</li><li><span style="font-family:calibri;">In Network Connections, double-click <strong>
VPN Connection</strong>.</span> </li><li><span style="font-family:calibri;">In Connect VPN Connection, type the password in
<strong>Password</strong>, and then click <strong>Connect</strong>. You should see a successful VPN connection, identifying itself as being on the corp.contoso.com network.</span>
</li><li><span style="font-family:calibri;">Click <strong>Start</strong>, click <strong>
Control Panel</strong>, click <strong>System and Security</strong>, and then click
<strong>Windows Firewall</strong>.</span> </li><li><span style="font-family:calibri;">In the left pane, click <strong>Turn Windows Firewall on or off</strong>.</span>
</li><li><span style="font-family:calibri;">In <strong>Domain network location settings</strong>, click
<strong>Turn off Windows Firewall</strong>, and then click <strong>OK</strong>. Watch as the NAP client automatically turns on Windows Firewall for domain networks. This is NAP autoremediation behavior.</span>
</li></ol>
<br />
<h2 style="margin:10pt 0in 0pt;"><a name="Step_6_Demonstrate_NAP_Enforcement_Behavior"></a><span style="font-family:cambria;font-size:18px;color:#4f81bd;">Step 6: Demonstrate NAP Enforcement Behavior</span></h2>
<ol>
<li><span style="font-family:calibri;">On DC1, in the console tree of the Network Policy Server snap-in, open
<strong>Network Access Protection\System Health Validators\Windows Security Health Validator\Settings</strong>.</span>
</li><li><span style="font-family:calibri;">In the details pane, double-click <strong>Default configuration</strong>.</span>
</li><li><span style="font-family:calibri;">Select <strong>An antivirus application is on</strong>, and then click
<strong>OK</strong>.</span> </li><li><span style="font-family:calibri;">On CLIENT1, in the left pane of the <strong>
Windows Firewall</strong> window, click <strong>Turn Windows Firewall on or off</strong>.</span>
</li><li><span style="font-family:calibri;">In <strong>Domain network location settings</strong>, click
<strong>Turn off Windows Firewall</strong>, and then click <strong>OK</strong>.</span>
</li><li><span style="font-family:calibri;">Notice that the NAP client automatically turns on Windows Firewall for domain networks. However, this time you should see a persistent
<strong>Network Access Protection: Network access might be limited</strong> message in the notification area of the desktop. This indicates that CLIENT1 is not compliant with system health requirements because there is no antivirus program installed on CLIENT1.
</span></li><li><span style="font-family:calibri;">Click the notification message. In the <strong>
Network Access Protection</strong> window, you should see the message <strong>This computer doesn’t meet security standards defined by your network administrator</strong>.</span>
</li><li><span style="font-family:calibri;">From a command prompt, ping DC1 at its IP address of 10.0.0.1. This should be successful.</span>
</li><li><span style="font-family:calibri;">Ping APP1 at its IP address of 10.0.0.3. This should not be successful. CLIENT1 cannot reach any other location on the Corpnet subnet except 10.0.0.1 because only 10.0.0.1 is in the configured remediation server group.</span>
</li><li><span style="font-family:calibri;">On DC1, in the details pane of the Network Policy Server snap-in, double-click
<strong>Default configuration</strong>.</span> </li><li><span style="font-family:calibri;">Clear <strong>An antivirus application is on</strong>, and then click
<strong>OK</strong>.</span> </li><li><span style="font-family:calibri;">On CLIENT1, in the <strong>Network Access Protection</strong> window, click
<strong>Try Again</strong>. You should see the message <strong>This computer meets security standards defined by your network administrator</strong>. Click
<strong>Close</strong>.</span> </li><li><span style="font-family:calibri;">From a command prompt, ping DC1 at its IP address of 10.0.0.1. This should be successful.</span>
</li><li><span style="font-family:calibri;">Ping APP1 at its IP address of 10.0.0.3. This should also be successful.</span>
</li><li><span style="font-family:calibri;">In Internet Explorer, in the Address bar, type
<strong>http://app1.corp.contoso.com/</strong>, press ENTER, and then press F5. You should see the default IIS 7 Web page for APP1.</span>
</li><li><span style="font-family:calibri;">Close Internet Explorer.</span> </li><li><span style="font-family:calibri;">Click <strong>Start</strong>, type <strong>
\\app1\files</strong>, and then press ENTER. You should see a folder window with the contents of the Files shared folder.</span>
</li><li><span style="font-family:calibri;">In the Files shared folder window, double-click the
<strong>Example.txt</strong> file. </span></li><li><span style="font-family:calibri;">Close the example.txt - Notepad window and the Files shared folder window.</span>
</li></ol>

</div>
    
    