---
layout: default
title: Troubleshooting PKI Problems on Windows - TechNet Articles - United States (English) - TechNet Wiki
weight: 3
---

<div class="post-content user-defined-markup">

<table class="style1" border="0" frame="box" align="right" style="width:245px;border:1px solid #000000;">
<tbody>
<tr>
<td style="width:241px;">
<p><a href="http://social.technet.microsoft.com/wiki/cfs-file.ashx/__key/CommunityServer.Wikis.Components.Files/articles/6457.cryptodevbanner.png"><img alt=" " src="http://social.technet.microsoft.com/wiki/resized-image.ashx/__size/550x0/__key/CommunityServer.Wikis.Components.Files/articles/6457.cryptodevbanner.png" style="border:0px solid;" /></a><a href="http://social.technet.microsoft.com/cfs-file.ashx/__key/CommunityServer.Wikis.Components.Files/technet/4405.crypt-fragment-top"><div class="r1 fiji-r1"></div><div class="r2 fiji-r2"></div><div class="r3 fiji-r3"></div><div class="r4 fiji-r4"></div></div><div class="content-fragment-content">

<div class="full-post-header"></div>
<div class="full-post">
    <h1 class="post-name">Troubleshooting PKI Problems on Windows</h1>
    

    <div class="post-content user-defined-markup">

<table class="sto.png"></a></p>
</td>
</tr>
<tr>
<td style="width:241px;">
<hr />
Other Resources<br />
<a href="http://msdn.microsoft.com/en-us/default.aspx" target="_blank">Security Developer Center</a><br />
<a href="http://msdn.microsoft.com/en-us/library/aa380255(VS.85).aspx" target="_blank">Cryptography Topics on MSDN</a><br />
<a href="http://twitter.com/winsecsdk">Follow us on Twitter</a></td>
</tr>
</tbody>
</table>
<div class="ExternalClass6B97A489CCFD422BA4843466189672B4">
<div><span style="font-size:10pt;font-family:arial;"></span>&nbsp;</div>
<div><span style="font-size:10pt;font-family:arial;">CAPI2 Diagnostics is a feature&nbsp;first introduced in&nbsp;Microsoft® Windows® Vista. This feature provides administrators with an ability to troubleshoot PKI problems by collecting detailed information about certificate
 chain validation, certificate store operations and signature verification. With CAPI2 Diagnostics, it is easier to identify the root cause of most PKI problems. CAPI2 Diagnostics can reduce the time required to diagnose problems and improve the troubleshooting
 experience.</span></div>
<div><span style="font-size:10pt;font-family:arial;"></span>&nbsp;</div>
<div><span style="font-size:10pt;font-family:arial;">
<div><span style="font-size:10pt;font-family:arial;"><span style="font-size:10pt;font-family:arial;">For quick instructions on how to enable this feature, see below.
</span>To learn more about CAPI2 Diagnostics, check out the <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=FE8EB7EA-68DA-4331-9D38-BDBF9FA2C266">
whitepaper on Troubleshooting PKI problems on Windows Vista</a> at <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=FE8EB7EA-68DA-4331-9D38-BDBF9FA2C266">
http://www.microsoft.com/downloads/details.aspx?FamilyID=FE8EB7EA-68DA-4331-9D38-BDBF9FA2C266</a></span></div>
</span></div>
<div><span style="font-size:10pt;font-family:arial;"></span>&nbsp;</div>
<div><span style="font-size:10pt;font-family:arial;">
<div><span style="font-size:10pt;font-family:arial;">If you have questions or feedback, you can send it to
<a href="mailto:capidiag@microsoft.com">capidiag@microsoft.com</a></span></div>
<div><span style="font-size:10pt;font-family:arial;"></span>&nbsp;</div>
</span></div>
<div><span style="font-size:10pt;font-family:arial;"><strong>How to enable CAPI2 Diagnostics?
</strong></span></div>
<div><span style="font-size:10pt;font-family:arial;"></span>&nbsp;</div>
<div><span style="font-size:10pt;font-family:arial;">
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">You can enable this feature from the event viewer UI or use command line scripts.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><em><span style="font-size:10pt;font-weight:normal;">A. From the Event Viewer UI</span></em></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">1. Open the Event Viewer.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">To do this, Click on Windows Start Symbol, then right-click on Computer and select “Manage”</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">Event Viewer is one of the nodes under System Tools under Computer Management.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">Note that Event Viewer is a MMC snap-in and you need administrative privileges to access the Event Viewer.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">2. In</span><span style="font-size:10pt;font-weight:normal;"> the Event Viewer, go to Application and Services Logs -&gt; Microsoft -&gt; Windows -&gt; CAPI 2 to get the
 CAPI 2 channel.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">3. Right-click on &quot;Operational&quot; and select “Enable Log”. This will enable CAPI2 Diagnostics logging.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">4. To save the log to a file, right click on &quot;Operational&quot; and select the “Save Events as” option.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">You can save the log file in the .evtx format (which can be opened through the Event Viewer) or in the standard XML format.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">5. If there is data present in the logs before you reproduce the problem, it is recommended that you clear the logs before the repro. This allows only the data
 relevant to the problem scenario to be collected from the saved logs.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">To clear the logs, right click on &quot;Operational&quot; and select the “Clear Log” option.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">6. The default size for the event log is 1 MB. For CAPI2 Diagnostics, the logs tend to grow in size quickly and it is recommended to increase the log size to at
 least 4 MB to capture relevant events. To increase the log size, Right-click on “Operational” and select the “Properties” option. In the log properties, increase the maximum log size.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><em><span style="font-size:10pt;font-weight:normal;">B. Command line scripts</span></em></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">You can also enable logging and save the logs using the wevtutil.exe tool.</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">Launch a command line with administrative privileges. Run the following commands</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">1. To enable logging,</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">wevtutil.exe sl Microsoft-Windows-CAPI2/Operational /e:true</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">2. To save the log to a file,
</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">wevtutil.exe epl Microsoft-Windows-CAPI2/Operational filename.evtx</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">3. To disable logging,</span><span style="font-weight:normal;font-family:&#39;timee="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">Launch a command line with administrative privileges. Run the following commands</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;"></span>&nbsp;</div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weights new roman&#39;,serif;"></span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">wevtutil.exe sl Microsoft-Windows-CAPI2/Operational /e:false</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">4. To clear logs,</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">wevtutil.exe cl Microsoft-Windows-CAPI2/Operational</span></div>
<div style="margin:0in 0in 0pt;"><span style="font-size:10pt;font-weight:normal;">5. To increase the log size<br />
wevtutil sl Microsoft-Windows-CAPI2/Operational /ms:&lt;log-size-in-bytes&gt;</span></div>
</span></div>
<span style="font-size:10pt;font-family:arial;">
<h4 style="margin:0.25in 0in 3pt;"><a name="Logging_Modes"></a>Logging Modes</h4>
<div style="margin:3pt 0in;">CAPI2 Diagnostics utilizes Event Viewer features, such as use of error level and keywords, for filtering the data in the log. For example, if you want to look at path validation related errors, you can filter by an
 event level of &quot;Error&quot; (level 2) and the keywords &quot;chain building,&quot; &quot;chain validation,&quot; and &quot;revocation.&quot; Events are marked level 2 when the API returns an error and level 4 if the API returns a success.</div>
<div style="margin:3pt 0in;">In the default logging mode, only events with levels 2 and 4 are logged. This includes success and error events for the top-level events along with any child error events. For more detailed logging with additional
 information corresponding to the child events, enable the <strong>verbose logging mode</strong>. With the verbose mode, events with verbose level 5 are available in the log. For example, with verbose mode, the links to the binary X.509 objects are available
 in the log. X.509 objects are cached in file system at %USERPROFILE%/AppData/LocalLow/Microsoft/X509Objects.</div>
<div style="margin:3pt 0in;">This is logged as:</div>
<table class="CodeSection" border="1" cellspacing="0" cellpadding="0" style="border-collapse:collapse;">
<tbody>
<tr>
<td valign="top" style="padding:0.7pt 0.05in;background-color:transparent;border:1.5pt solid silver;">
<p class="Code" style="margin:0in 0in 0pt;"><span style="font-size:small;font-family:&#39;courier new&#39;;">&lt;X509Objects&gt;</span></p>
<p class="Code" style="margin:0in 0in 0pt;"><span style="font-size:small;font-family:&#39;courier new&#39;;">&nbsp; &lt;Base path=&quot;F:\Users\abby\AppData\LocalLow\Microsoft\X509Objects”/&gt;</span></p>
</td>
</tr>
</tbody>
</table>
<p class="TableSpacing" style="margin:4pt 0in;"><span style="font-size:xx-small;">&nbsp;</span>Verbose mode is useful for operations that rarely fail, such are store and cache operations, but are sometimes useful to give context to other events. If the operation fails,
 an error event with a level of 2 will be logged and will be available in the default logging mode.</p>
<p class="TableSpacing" style="margin:4pt 0in;"><strong>To enable verbose mode</strong></p>
<table class="ProcedureTable" border="0" cellspacing="0" cellpadding="0" style="margin:auto auto auto 0.25in;border-collapse:collapse;">
<tbody>
<tr>
<td valign="top" style="padding:0in;background-color:transparent;width:6.15in;border:#f0f0f0;">
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">1.&nbsp;&nbsp; Click the
<span class="UI"><strong>Start</strong></span> button, click <span class="UI"><strong>Start Search</strong></span>, type
<span class="UI"><strong>Run</strong></span>, and then press Enter. </span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">2.&nbsp;&nbsp; In Run, type
<span class="UI"><strong>regedit</strong></span>, and then click <span class="UI">
<strong>OK</strong></span>.</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">3.&nbsp;&nbsp; If the
<span class="UI"><strong>User Account Control</strong></span> dialog box appears, confirm that the action it displays is what you want, and then click
<span class="UI"><strong>Continue</strong></span>.</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">4.&nbsp;&nbsp; Navigate to the following registry key: HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\crypt32.</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">5.&nbsp;&nbsp; Add a DWORD (32-bit) value
<span class="UI"><strong>DiagLevel</strong></span> with value <span class="UI"><strong>0x00000005</strong></span>.</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">6.&nbsp;&nbsp; Add a QWORD (64-bit) value
<span class="UI"><strong>DiagMatchAnyMask</strong></span> with value <span class="UI">
<strong>0x00ffffff</strong></span>.</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:x-small;"></span><span style="font-size:small;">&nbsp;</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">Additionally,</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">7. If you want to log events only for a particular process, add a multi-string value:
</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">&quot;DiagProcessName&quot; and enter the process name such as iexplore.exe</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">8. If you want to log events only for specific keywords, you can set the appropriate mask in DiagMatchAnyMask.</span></p>
<p class="NumberedList1" style="margin:3pt 0in 3pt 0.25in;"><span style="font-size:small;">&nbsp;</span></p>
</td>
</tr>
</tbody>
</table>
<div>&nbsp;</div>
<div>
<h2>
<hr />
</h2>
<h2><a name="See_Also"></a>See Also</h2>
<ul>
<li><a href="http://social.technet.microsoft.com/wiki/contents/articles/wiki-list-of-technologies-and-related-topics.aspx" class="ExistingPageLink" title="Click to view the page titled: Wiki: List of Technologies and Related Topics"><span style="color:#0066dd;">List
 of Technologies and Related Topics</span></a> </li><li><a href="http://social.technet.microsoft.com/wiki/contents/articles/wiki-development-portal.aspx"><span style="color:#0066dd;">Wiki: Development Portal</span></a>
</li></ul>
</div>
</span></div>

</div>
    
    