---
layout: default
title: 'FIM Troubleshooting&#58; CM Upgrade Fails exception executing SQL statement - TechNet Articles - United States (English) - TechNet Wiki'
weight: 3
---

<div class="post-content user-defined-markup">

<p style="margin:10pt 0in 0pt;"><a name="ISSUE"></a><div class="table-of-contents"><h2 class="title">Table of Contents</h2><div class="hierarchy-list-header"> </div><ul class="hierarchy-list"><li class="hierarchy-item"><a href="#ISSUE">ISSUE:</a></li><li class="hierarchy-item"><a href="#FINDING">Findings</a></li><li class="hierarchy-item"><a href="#RESOLUTION">Resolution</a></li><li class="hierarchy-item"><a href="#DETAILS">Details</a></li></ul><div class="hierarchy-list-footer"> </div></div>&nbsp;&nbsp;&nbsp;&nbsp; </p>
<hr />
<h2 style="margin:10pt 0in 0pt;"><a name="ISSUE"></a>ISSUE: </h2>
<p style="margin:10pt 0in 0pt;">&nbsp;</p>
<p style="margin:0in 0in 10pt;"><span style="font-family:Calibri;">Installing a FIM CM R2 patch fails with the following dialog.</span></p>
<p style="margin:1em 0px 1em 0.5in;">&nbsp;</p>
<div class="reCodeBlock">
<div style="background-color:white;"><span><code style="color:green;">---------------------------</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">FIM Certificate Management</code></span></div>
<div style="background-color:white;"><span><code style="color:green;">---------------------------</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">FIM CM
</code><code style="color:teal;font-weight:bold;">Database</code> <code style="color:black;">
upgrade failed </code><code style="color:teal;font-weight:bold;">with</code> <code style="color:black;">
the following exception:</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">An error occurred: Problem while executing the SQL statement</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:green;">--********************************************************</code></span></div>
<div style="background-color:white;"><span><code style="color:green;">--*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:green;">--*&nbsp;&nbsp; Copyright (C) Microsoft. All rights reserved.&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></span></div>
<div style="background-color:white;"><span><code style="color:green;">--*&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:green;">--********************************************************</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">/* Parameters:&nbsp; */</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">USE</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">GO</code></span></div>
<div style="background-color:#f5f5f5;"><span>&nbsp;</span></div>
<div style="background-color:white;"><span><code style="color:black;">IF
</code><code style="color:gray;">NOT</code> <code style="color:black;">EXISTS (</code></span></div>
<div style="background-color:#f5f5f5;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:teal;font-weight:bold;">SELECT</code>
<code style="color:black;">[column_name] </code></span></span></div>
<div style="background-color:white;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:teal;font-weight:bold;">FROM</code>
<code style="color:black;">INFORMATION_SCHEMA.columns </code></span></span></div>
<div style="background-color:#f5f5f5;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:teal;font-weight:bold;">WHERE</code></span></span></div>
<div style="background-color:white;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:black;">[table_name] =
</code><code style="color:blue;">&#39;CertificateAuthority&#39;</code></span></span></div>
<div style="background-color:#f5f5f5;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:gray;">AND</code>
<code style="color:black;">[column_name] = </code><code style="color:blue;">&#39;ca_exit_module_version&#39;</code><code style="color:black;">)&nbsp;&nbsp;
</code></span></span></div>
<div style="background-color:white;"><span><code style="color:teal;font-weight:bold;">BEGIN</code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
<div style="background-color:#f5f5f5;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:teal;font-weight:bold;">ALTER</code>
<code style="color:teal;font-weight:bold;">TABLE</code> <code style="color:black;">
[CertificateAuthority]</code></span></span></div>
<div style="background-color:white;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:teal;font-weight:bold;">ADD</code>
<code style="color:black;">[ca_exit_module_version] </code><code style="color:teal;font-weight:bold;">VARCHAR</code><code style="color:black;">(50)
</code><code style="color:gray;">NULL</code></span></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:teal;font-weight:bold;">END</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">GO</code></span></div>
</div>
<p style="margin:1em 0px 1em 0.5in;">&nbsp;</p>
<p style="margin:1em 0px;">A verbose MSI log indicates the following.</p>
<p style="margin:1em 0px 1em 0.5in;"><span style="color:red;">Executing op: CustomAspan><code style="color:teal;font-weight:bold;">ALTER</code>
<code style="color:teal;font-weight:bold;">TABLE</code> <code style="color:black;">
[CertificateAuthority]</code></span></span></div>
<div style="background-color:white;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:teal;font-weight:bold;">ADD</code>
<code style="color:black;">[ca_exit_module_version] </code><code style="color:teal;font-weight:bold;">VARCHAR</code><code style="color:black;">(50)
</code><code style="color:gray;">NULL</code></span></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:teal;font-weight:bold;">END</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">GO</code></span></div>
</div>
<p stylectionSchedule(Action=UpgradeDatabase,ActionType=1058,Source=C:\Program Files\Microsoft Forefront Identity Manager\2010\Certificate Management\Bin\,Target=&quot;C:\Program Files\Microsoft
 Forefront Identity Manager\2010\Certificate Management\Bin\Microsoft.Clm.Config.exe&quot; /DB,)</span></p>
<p style="margin:1em 0px 1em 0.5in;">&nbsp;</p>
<p style="margin:1em 0px 1em 0.5in;"><span style="color:red;">CustomAction UpgradeDatabase returned actual error code -5 (note this may not be 100% accurate if translation happened inside sandbox)</span></p>
<p style="margin:1em 0px 1em 0.5in;">&nbsp;</p>
<p style="margin:1em 0px 1em 0.5in;"><span style="color:red;">Note: 1: 1722 2: UpgradeDatabase 3: C:\Program Files\Microsoft Forefront Identity Manager\2010\Certificate Management\Bin\ 4: &quot;C:\Program Files\Microsoft Forefront Identity Manager\2010\Certificate
 Management\Bin\Microsoft.Clm.Config.exe&quot; /DB</span></p>
<p style="margin:1em 0px;">&nbsp;</p>
<p style="margin:1em 0px;">A network trace showed no traffic from the CM server to the SQL server. A SQL Profiler trace corroborated this showing no activity from the CM server.</p>
<p style="margin:1em 0px;">&nbsp;</p>
<h2 style="margin:10pt 0in 0pt;"><a name="FINDING"></a>
<hr />
Findings</h2>
<p style="margin:0in 0in 10pt;"><span style="font-family:Calibri;">Some research indicated there may be something amiss with the SQL connection string in the registry. A PowerShell script converted the registry binary data to text. This text was added to the
 web.config file. After updating the web.config file the patch installation completed successfully.</span></p>
<h2 style="margin:10pt 0in 0pt;"><a name="RESOLUTION"></a><span style="font-family:Calibri;font-size:24px;color:#2f4f4f;">
<hr />
</span>Resolution</h2>
<p style="margin:0in 0in 10pt;"><span style="font-family:Calibri;">Add the connection string to the web.config file (details below).</span></p>
<h2 style="margin:10pt 0in 0pt;"><a name="DETAILS"></a>
<hr />
Details</h2>
<p style="margin:1em 0px;"><strong>Sample DBConnectionString registry setting:</strong></p>
<p style="margin:1em 0px 1em 0.5in;">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Clm\v1.0\Server\WebUser</p>
<p style="margin:1em 0px 1em 0.5in;">&nbsp;&nbsp;&nbsp; DBConnectionString&nbsp;&nbsp;&nbsp; REG_BINARY&nbsp;&nbsp;&nbsp; 01000000D08C9DDF0115D1118C7A00C04FC297EB01000000EA385DBF07333B4887F97F08639DD0040400000002000000000003660000C00000001000000037BE31F2DB88ABACE3355A0B352031F60000000004800000A00000001000000057F97300F6F52206FFC9183E04F34F5E20010000EF95D0649EFB8B92841C703DC9B7CD0D5699D62D63DD956574236CDE5662F8410DBFEBD74E8138EB6562E37D464DA26C2F63F48AD5EA698133AC2D4000BC0D9E9085E162C78FBE3FA5349055C311FBDEB7A0474AF2CD5F455FC35F708CE0289387717B8A1466E2AF7E2E6167E573A52A082D7CC5DA3816A1125260159CD187159E764C9AA111953DCD7DC7AA6F46DA279E34FC186C5118F9BF9D0D32FD5A13B450AB0A9906F2520E7561F3210E916765459699E42D1FFA2C137BE911F9496A2ECE6F2EFFC8D8167F3F7A9E3450D4994E795D749FD32648A61740FCF2CB302A641685C8A8F138DEB373649007ADE1352D26A59DD5B532ADEDEA425EF741F4ECA6149E759B50149E588AE9F1ED4393427405617A189859F19CA0830923F8147718140000000454193E620BF88CA06C03DDF771F51293CFF538</p>
<p style="margin:1em 0px 1em 0.5in;">&nbsp;</p>
<p style="margin:1em 0px;"><strong>Sample PowerShell script conversion of the DBConnectionString registry setting (formatting cleaned up for presentation):</strong></p>
<p style="margin:1em 0px 1em 0.5in;">Connect Timeout=15;Persist Security Info=True;Integrated Security=sspi;Initial Catalog=FIMCertificateManagement;Data Source=SQL01\FIM2010R2CM;</p>
<p style="margin:1em 0px;">&nbsp;</p>
<strong>
<p style="margin:1em 0px;">Sample web.config setting:</p>
<div class="reCodeBlock">
<div style="background-color:white;"><span><code style="color:green;">&lt;!-- DATABASE SETTINGS ************************************************--&gt;</code></span></div>
<div style="background-color:#f5f5f5;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:green;">&lt;!-- Database Connection String~~~~~~~~~~~~~~~~~~--&gt;</code></span></span></div>
<div style="background-color:white;"><span><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</code><span><code style="color:black;">&lt;</code><code style="color:teal;font-weight:bold;">add</code>
<code style="color:gray;">key</code><code style="color:black;">=</code><code style="color:blue;">&quot;Clm.DataAccess.ConnectionString&quot;</code>
<code style="color:gray;">value</code><code style="color:black;">=</code><code style="color:blue;">&quot;Connect Timeout=15;Persist Security Info=True;Integrated Security=sspi;Initial Catalog=FIMCertificateManagement;Data Source=SQL01\FIM2010R2CM&quot;</code>
<code style="color:black;">/&gt;</code></span></span></div>
</div>
</strong>
<p style="margin:1em 0px;">&nbsp;</p>
<p style="margin:1em 0px;"><strong>Contents of PowerShell script:</strong></p>
<p style="margin:1em 0px;">&nbsp;</p>
<div class="reCodeBlock">
<div style="background-color:white;"><span><code style="color:black;">Add-Type -assembly System.Security</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">Add-Type -assembly mscorlib</code></span></div>
<div style="background-color:white;"><span>&nbsp;</span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">$reg = [wmiclass]</code><code style="color:blue;">&#39;\\.\root\default:StdRegprov&#39;</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">$HKLM = 2147483650 #HKEY_LOCAL_MACHINE
</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">$key =
</code><code style="color:blue;">&quot;SOFTWARE\Microsoft\Clm\v1.0\Server\WebUser\&quot;</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">$value =
</code><code style="color:blue;">&quot;DBConnectionString&quot;</code></span></div>
<div style="background-color:#f5f5f5;"><span>&nbsp;</span></div>
<div style="background-color:white;"><span><code style="color:black;">$connectionStringBinary = [</code><code style="color:teal;font-weight:bold;">byte</code><code style="color:black;">[]]($reg.GetBinaryValue($HKLM, $key, $value).uvalue)</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">$connectionStringBytes = [System.Security.Cryptography.ProtectedData]::Unprotect($connectionStringBinary, $</code><code style="color:teal;font-weight:bold;">null</code><code style="color:black;">,
</code><code style="color:blue;">&quot;LocalMachine&quot;</code><code style="color:black;">)</code></span></div>
<div style="background-color:white;"><span><code style="color:black;">$connectionStringString = [System.Text.Encoding]::Unicode.GetString($connectionStringBytes);
</code></span></div>
<div style="background-color:#f5f5f5;"><span><code style="color:black;">$connectionStringString</code></span></div>
</div>

</div>
    
    
