---
layout: default
title: Deploying an Operating System to a Virtual Hard Drive (VHD) in ConfigMgr 2012 R2 - TechNet Articles - United States (English) - TechNet Wiki
weight: 3
---

<div class="post-content user-defined-markup">

System Center 2012 R2 Configuration Manager (ConfigMgr 2012 R2) is scheduled to be released soon and there’s a cool new feature that allows us to deploy an operating system and create a Virtual Hard Disk (VHD) at the same time, meaning that we can now deploy
 an operating system directly to a VHD that can be given to the VMM admins for further use.
<p>Say for example that you have a Virtual Machine Manager administrator who has a project where he needs multiple VMs for production use. The standard procedure would be to manually create a VM, install the OS, install all of the required applications on that
 VM, and then use that VM on <a>all of the other production machines</a>. Now this all can be achieved by ConfigMgr 2012 R2 using a new Task Sequence (TS) that will do all of this for you in a single process.&nbsp; Here are the steps ConfigMgr 2012 R2 uses to create
 this new Virtual Hard Drive:</p>
<p>1) Configuration Manager creates a Task Sequence media.</p>
<p>2) Configuration Manager creates a Virtual Hard Disk.</p>
<p>3) Configuration Manager creates a temporary virtual machine (VM) on the Hyper-V Server.</p>
<p>4) Configuration Manager allocates the resources to the created temporary VM.</p>
<p>5) Configuration Manager mounts the Task Sequence media to the VM. </p>
<p>6) Configuration Manager attaches the VHD to the VM. </p>
<p>7) Configuration Manager executes the Task Sequence.</p>
<p>8) Once the Task Sequence completes, the temporary VM is stopped and the VHD is copied to a share location.</p>
<p><strong>NOTE</strong>: <em>While the steps above will create our VHD, there is an additional prerequisite that is required. In addition to the standard prerequisites for VMM (see
</em><a title="http://technet.microsoft.com/en-us/library/gg610592.aspx" href="http://technet.microsoft.com/en-us/library/gg610592.aspx"><em>http://technet.microsoft.com/en-us/library/gg610592.aspx</em></a><em>), we also need a server with Hyper-V running on
 it, and this server needs to have the ConfigMgr 2012 R2 console installed.</em></p>
<p>Here is an example of how we can deploy an operating system to a Virtual Hard Drive using ConfigMgr 2012 R2:</p>
<p>First we select our new type of Task Sequence that allows us to install an existing Windows image package to a Virtual Hard Drive:</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/7002.clip_5F00_image0024_5F00_329DB90C.jpg"><img title="clip_image002[4]" alt="clip_image002[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/2630.clip_5F00_image0024_5F00_thumb_5F00_1FE8BF55.jpg" width="400" height="153" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>The rest of the Task Sequence is essentially the same as a regular Task Sequence, however there is an extra step that is added as part of this new Task Sequence: The “Shutdown computer” step.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/6874.clip_5F00_image0044_5F00_6350C0B7.jpg"><img title="clip_image004[4]" alt="clip_image004[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/8030.clip_5F00_image0044_5F00_thumb_5F00_29617DCB.jpg" width="500" height="458" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>This is an important part of the TS as this step allows the VM to shut down and then pass control to Configuration Manager to copy the VHD package. Once we have created the Task Sequence to deploy an OS to a Virtual Hard Disk, we will create the Virtual
 Hard Disk itself. To create this, we now have an additional node in Operating Systems for “Virtual Hard Disks”.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/1033.clip_5F00_image0064_5F00_56766A99.jpg"><img title="clip_image006[4]" alt="clip_image006[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/7318.clip_5F00_image0064_5F00_thumb_5F00_27B0B1F7.jpg" width="300" height="269" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>Note that if the Configuration Manager server is not a Hyper-V host we will not get the option to create a Virtual Hard Disk as Configuration Manager needs to interact with the hypervisor to create the virtual machine, perform all the steps in the TS, and
 then delete the VM. In this process, the Configuration Manager console interacts with Hyper-V which is why we require a dedicated Hyper-V server with the ConfigMgr 2012 R2 console.</p>
<p>Below is a screen shot from my Hyper-V server that has the ConfigMgr 2012 R2 console installed.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/4606.clip_5F00_image0074_5F00_42E90AF8.jpg"><img title="clip_image007[4]" alt="clip_image007[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/8838.clip_5F00_image0074_5F00_thumb_5F00_0D0415DE.jpg" width="400" height="271" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>In the Create Virtual Hard Drive wizard, we specify the general description of the Virtual Hard Disk and a share location to store the VHD file created during the process.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/1832.clip_5F00_image0094_5F00_732FDFAE.jpg"><img title="clip_image009[4]" alt="clip_image009[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5483.clip_5F00_image0094_5F00_thumb_5F00_446A270C.jpg" width="400" height="383" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>The next step allows you to select the Task Sequence for deployment. Make sure to select the Task Sequence we created for the Virtual Hard Disk. You will see the option to select other kinds of Task Sequences but those will fail.
</p>
<p>Once we select our Task Sequence we have a preview of all the packages in the TS.
</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/1362.clip_5F00_image0114_5F00_119A2098.jpg"><img title="clip_image011[4]" alt="clip_image011[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/3343.clip_5F00_image0114_5F00_thumb_5F00_49D897B0.jpg" width="400" height="182" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>After this step we get to see the introduction of another new feature in ConfigMgr 2012 R2, a preview of the packages which are required in a TS and their distribution status on the Distribution Point (DP).</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/3465.clip_5F00_image0134_5F00_1708913C.jpg"><img title="clip_image013[4]" alt="clip_image013[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/8512.clip_5F00_image0134_5F00_thumb_5F00_7D345B0C.jpg" width="400" height="118" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>We can clearly see in the above screen shot that there are 3 packages required in my TS and out of them 2 are not on the DP. This is a hard block now and we will not be able to proceed until we distribute all of the required packages to the DP.</p>
<p>After distributing the packages, we also get the option to choose which DP will be used to download these packages. This has an added bonus of allowing us to isolate DP related issues and package related issues we may run into after running the Task Sequence.
</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/6567.clip_5F00_image0154_5F00_1C7701E0.jpg"><img title="clip_image015[4]" alt="clip_image015[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/6404.clip_5F00_image0154_5F00_thumb_5F00_26C82640.jpg" width="400" height="341" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>Here is a preview showing the available Distribution Points and the package distribution status.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/7870.clip_5F00_image0174_5F00_73F81FCB.jpg"><img title="clip_image017[4]" alt="clip_image017[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/6835.clip_5F00_image0174_5F00_thumb_5F00_45326729.jpg" width="404" height="322" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>We also have a preview that shows the DP selected to be used by the Task Sequence to download the required packages.</p>
<p>Once we initiate this wizard, the Operating System Deployment to the Virtual Hard Drive begins.
</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/4606.clip_5F00_image0194_5F00_64750DFC.jpg"><img title="clip_image019[4]" alt="clip_image019[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/8037.clip_5F00_image0194_5F00_thumb_5F00_1CB38515.jpg" width="400" height="406" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>This wizard can be monitored by a log file named DeplottoVHD.log. This log is found in the AdminUILOG folder in the Admin console installation Directory.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/2570.clip_5F00_image0214_5F00_69E37EA0.jpg"><img title="clip_image021[4]" alt="clip_image021[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/1121.clip_5F00_image0214_5F00_thumb_5F00_3B1DC5FE.jpg" width="500" height="104" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>As seen here, the wizard’s first step is to create a Task Sequence media. This creation of the media can be seen in DeploytoVHD.log which is monitored by the CreateTSMedia component and logged in the AdminUILog folder.
</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/1462.clip_5F00_image0234_5F00_56561EFF.jpg"><img title="clip_image023[4]" alt="clip_image023[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/2465.clip_5F00_image0234_5F00_thumb_5F00_408C36A2.jpg" width="500" height="168" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>This is the same process that is logged when we create a normal Task Sequence media except for the fact that in this case TS media is created by Configuration Manager and mounted to the temporary VM.</p>
<p>Once the TS Media is created, the Deploy to VHD component comes into the picture. This creates a temporary VM, allocates the necessary resources to the machine, mounts the TS media and starts the execution.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5621.clip_5F00_image0254_5F00_54A5532B.jpg"><img title="clip_image025[4]" alt="clip_image025[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5040.clip_5F00_image0254_5F00_thumb_5F00_0CE3CA44.jpg" width="500" height="46" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>The CreateTSMedia.log snippet above shows that the process of Task Sequence media creation has completed.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/4162.clip_5F00_image0274_5F00_653D4E19.jpg"><img title="clip_image027[4]" alt="clip_image027[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/8713.clip_5F00_image0274_5F00_thumb_5F00_7D60B874.jpg" width="500" height="139" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>Above in our DeploytoVHYD.log we can see Configuration Manager creating a virtual machine, allocating the resources, mounting the TS media, attaching the VHD and starting the VM.</p>
<p>This log will pause here for some time and wait for the Task Sequence to complete the deployment.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/4431.clip_5F00_image0294_5F00_7C88528A.jpg"><img title="clip_image029[4]" alt="clip_image029[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5047.clip_5F00_image0294_5F00_thumb_5F00_1BCAF95E.jpg" width="500" height="195" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5875.clip_5F00_image0314_5F00_1AF29374.jpg"><img title="clip_image031[4]" alt="clip_image031[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/2742.clip_5F00_image0314_5F00_thumb_5F00_68228CFF.jpg" width="500" height="44" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>We can see above how a temporary virtual machine is created on the Hyper-V server.</p>
<p>Once the Task Sequence completes on the virtual machine, the machine will be shut down and the VHD created as part of the TS will be copied to the shared location specified in the Create Virtual Hard Disk wizard.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/7450.clip_5F00_image0334_5F00_60971D92.jpg"><img title="clip_image033[4]" alt="clip_image033[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5415.clip_5F00_image0334_5F00_thumb_5F00_5FBEB7A8.jpg" width="500" height="182" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>The snippet above of the DeploytoVHD.log shows that after waiting for the VM to shut down, the VHD was copied to the shared location.</p>
<p>Once the Wizard is complete we can see our VHD in the create VHD node with the description we entered previously.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/7485.clip_5F00_image0354_5F00_Hard Disk wizard.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/7450.clip_5F00_image0334_5F00_60971D92.jpg"><img title="clip_image033[4]" alt="clip_image033[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/5415.clip_5F00_image0334_5F00_thumb_5F00_5FBEB7A8.jpg" width="500" height="182" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>The snippet above of the DeploytoVHD.log shows that after waiting for the VM to shut down, the VHD was copied to the shared location.</p>
<p>Once the Wizard is comple45EA8179.jpg"><img title="clip_image035[4]" alt="clip_image035[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/1256.clip_5F00_image0354_5F00_thumb_5F00_1E44054F.jpg" width="500" height="107" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>We might now be thinking of what can we do with this VHD and the answer lies on the same Create VHD node. As we all know, Virtual Machine Manager is part of the System Center suite which includes Configuration Manager, and now with ConfigMgr 2012 R2 we can
 upload this VHD created by Configuration Manager to your Virtual Machine Manager server directly.</p>
<p><a href="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/3632.clip_5F00_image0374_5F00_0B8F0B98.jpg"><img title="clip_image037[4]" alt="clip_image037[4]" src="http://blogs.technet.com/cfs-file.ashx/__key/communityserver-blogs-components-weblogfiles/00-00-00-69-06-metablogapi/6283.clip_5F00_image0374_5F00_thumb_5F00_15E02FF8.jpg" width="500" height="164" style="border-top:0px solid;border-right:0px solid;border-bottom:0px solid;border-left:0px solid;display:inline;" /></a></p>
<p>Now your VHD is ready to be used by your VMM 2012 administrators.</p>
<p><strong>NOTE:</strong> For additional information, see <em>How to Manage Virtual Hard Disks in Configuration Manager</em>
<a title="http://technet.microsoft.com/en-us/library/dn448591.aspx" href="http://technet.microsoft.com/en-us/library/dn448591.aspx">
at http://technet.microsoft.com/en-us/library/dn448591.aspx</a>.</p>
<p>Original author:<strong> Ashish Kumar</strong> via <a href="http://blogs.technet.com/b/configurationmgr/archive/2013/10/31/new-in-system-center-2012-r2-configuration-manager-deploying-an-operating-system-to-a-virtual-hard-drive-vhd.aspx">
http://blogs.technet.com/b/configurationmgr/archive/2013/10/31/new-in-system-center-2012-r2-configuration-manager-deploying-an-operating-system-to-a-virtual-hard-drive-vhd.aspx</a></p>

</div>
    
    